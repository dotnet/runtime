<Project>
  <Target Name="_MonoComputeAvailableComponentDefinitions">
    <!-- Input: _MonoRuntimeAvailableComponents item list: the components provided by the runtime -->
    <!-- Input: _MonoRuntimeComponentLinking property: either 'dynamic' or 'static'.  Are the components static or shared libraries. -->
    <!-- Output: _MonoRuntimeComponentName item list: the components provided by the runtime, with ComponentLib and ComponentStubLib metadata that gives the filenames of the components relative to the runtime pack native subdirectory -->
    <ItemGroup Condition="'$(_MonoRuntimeComponentLinking)' == 'dynamic'">
      <_MonoRuntimeComponentName Include="@(_MonoRuntimeAvailableComponents)">
	<ComponentLib>libmono-component-%(Identity)(_MonoRuntimeComponentSharedLibExt)</ComponentLib>
      </_MonoRuntimeComponentName>
    </ItemGroup>
    <ItemGroup Condition="'$(_MonoRuntimeComponentLinking)' == 'static'">
      <_MonoRuntimeComponentName Include="@(_MonoRuntimeAvailableComponents)">
	<ComponentLib>libmono-component-%(Identity)$(_MonoRuntimeComponentStaticLibExt)</ComponentLib>
	<ComponentStubLib>libmono-component-%(Identity)-stub$(_MonoRuntimeComponentStaticLibExt)</ComponentStubLib>
      </_MonoRuntimeComponentName>
    </ItemGroup>
  </Target>

  <Target Name="_MonoSelectRuntimeComponents" DependsOnTargets="_MonoComputeAvailableComponentDefinitions">
    <!-- Input: _MonoRuntimeComponentLinking property: either 'dynamic' or 'static' (defined by the runtime) -->
    <!-- Input: _MonoRuntimeComponentName item list of the input components (defined by _MonoComputeAvailableComponentDefinitions above) -->
    <!-- Input: _MonoComponent item list of names of components that will be enabled (to be defined by the workload) -->
    <!-- Output: _MonoRuntimeSelectedComponents  subset of _MonoRuntimeComponentName items that were in _MonoComponent -->
    <!-- Output: _MonoRuntimeSelectedStubComponents (static linking only)  subset of _MonoRuntimeComponentName items that were not in _MonoComponent -->
    <!-- Output: _MonoRuntimeComponentLink item list of the filenames to link (relative paths relative to the native/ directory of the runtime pack) -->
    <!--         For dynamic linking, this is only the enabled components.  For static linking, it also includes stubs for the non-selected components -->
   
    <ItemGroup Condition="'$(_MonoRuntimeComponentLinking)' == 'dynamic' or '$(_MonoRuntimeComponentLinking)' == 'static'">
      <!-- take the intersection of the two item lists. -->
      <!-- n.b. copies the metadata from _MonoRuntimeComponentName to _MonoRuntimeSelectedComponents -->
      <_MonoRuntimeSelectedComponents Include="@(_MonoRuntimeComponentName)" Condition="'@(_MonoRuntimeComponentName)' == '@(_MonoComponent)' and '%(Identity)' != ''" />
      <_MonoRuntimeComponentLink Include="%(_MonoRuntimeSelectedComponents.ComponentLib)">
	<Linking>$(_MonoRuntimeComponentLinking)</Linking>
	<IsStub>false</IsStub>
	<ComponentName>%(_MonoRuntimeSelectedComponents.Identity)</ComponentName>
      </_MonoRuntimeComponentLink>
      <!-- non-empty if any unknown components are specified -->
      <_MonoRuntimeSelectedMissingComponents Include="@(_MonoComponent)" Exclude="@(_MonoRuntimeComponentName)" />
    </ItemGroup>

    <ItemGroup Condition="'$(_MonoRuntimeComponentLinking)' == 'static'">
      <!-- Take difference _MonoRuntimeComponentName - _MonoComponent.  The remaining components are stubbed out -->
      <_MonoRuntimeSelectedStubComponents Include="@(_MonoRuntimeComponentName)" Exclude="@(_MonoComponent)" />
      <_MonoRuntimeComponentLink Include="%(_MonoRuntimeSelectedStubComponents.ComponentStubLib)">
	<Linking>$(_MonoRuntimeComponentLinking)</Linking>
	<IsStub>true</IsStub>
	<ComponentName>%(_MonoRuntimeSelectedStubComponents.Identity)</ComponentName>
      </_MonoRuntimeComponentLink>
    </ItemGroup>

    <Error Condition="@(_MonoRuntimeSelectedMissingComponents->Count()) != 0"
	     Text="_MonoComponent item list includes components '@(_MonoRuntimeSelectedMissingComponents)' which are not defined in the runtime pack. Runtime pack includes '@(_MonoRuntimeComponentName)'" />

  </Target>
</Project>
