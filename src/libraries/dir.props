<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Condition="Exists('..\dir.props')" Project="..\dir.props" />
  <!-- Build Tools Version -->
  <PropertyGroup>
    <BuildToolsVersion>1.0.25-prerelease-00007</BuildToolsVersion>
  </PropertyGroup>

  <!-- Common repo directories -->
  <PropertyGroup>
    <ProjectDir>$(MSBuildThisFileDirectory)</ProjectDir>
    <SourceDir>$(ProjectDir)src\</SourceDir>
    <BinDir Condition="'$(BinDir)'==''">$(ProjectDir)bin\</BinDir>
    <TestWorkingDir>$(BinDir)tests\</TestWorkingDir>
    <PackagesDir Condition="'$(PackagesDir)' == ''">$(ProjectDir)packages\</PackagesDir>
    <ToolsDir>$(PackagesDir)Microsoft.DotNet.BuildTools.$(BuildToolsVersion)\lib\</ToolsDir>
  </PropertyGroup>

  <!-- Common nuget properties -->
  <PropertyGroup>
    <NuGetToolPath Condition="'$(NuGetToolPath)' == ''">$(PackagesDir)NuGet.exe</NuGetToolPath>
    <NuGetConfigFile>$(SourceDir)NuGet.Config</NuGetConfigFile>
    <NuGetConfigCommandLine>-ConfigFile "$(NuGetConfigFile)"</NuGetConfigCommandLine>

    <NugetRestoreCommand>"$(NuGetToolPath)"</NugetRestoreCommand>
    <NugetRestoreCommand>$(NugetRestoreCommand) install</NugetRestoreCommand>
    <NugetRestoreCommand>$(NugetRestoreCommand) -OutputDirectory "$(PackagesDir.TrimEnd('\'))"</NugetRestoreCommand>
    <NugetRestoreCommand>$(NugetRestoreCommand) $(NuGetConfigCommandLine)</NugetRestoreCommand>
  </PropertyGroup>
  
  <!-- Coverage options -->
  <PropertyGroup>
    <_CoverageEnabled>false</_CoverageEnabled>
    <_CoverageEnabled Condition="'$(SkipTests)' != 'true' and '$(OS)' == 'Windows_NT' and '$(Coverage)' == 'true'">true</_CoverageEnabled>
    <CoverageReportDir Condition="'$(CoverageReportDir)' == ''">$(BinDir)\tests\coverage\</CoverageReportDir>
    <CoverageVersion>4.5.3711-rc52</CoverageVersion>
    <CoverageToolPath>$(PackagesDir)OpenCover.$(CoverageVersion)\OpenCover.Console.exe</CoverageToolPath>
    <!-- When coverage is enabled, we disallow building projects in parallel. There appear to be issues with the OpenCover tool
         in these scenarios. -->
    <SerializeProjects>true</SerializeProjects>
  </PropertyGroup>
  
  <!-- Set default Configuration and Platform -->
  <PropertyGroup>
    <Configuration Condition="'$(Configuration)' ==''">Debug</Configuration>
    <Platform Condition="'$(Platform)'==''">AnyCPU</Platform>
  </PropertyGroup>
  
  <!-- 
  Projects that have no OS-specific implementations just use Debug and Release for $(Configuration).
  Projects that do have OS-specific implementations use OS_Debug and OS_Release, e.g. a project with
  a Windows implementation and a Unix implementation will have Windows_Debug, Windows_Release, Unix_Debug,
  and Unix_Release.  For cases where a general Unix implementation needs to be further specialized for Linux vs Mac,
  a project may have Windows, Linux, and Mac implementations, in which case it would have Windows_Debug,
  Windows_Release, Linux_Debug, Linux_Release, Mac_Debug, and Mac_Release.
  
  Since now have multiple *Debug and *Release configurations, ConfigurationGroup is set to Debug for any of the
  debug configurations, and to Release for any of the release configurations.
  -->
  
  <!-- Setup Default symbol and optimization for Configuration -->
  <PropertyGroup Condition="'$(Configuration)' == 'Debug' or '$(Configuration)' == 'Windows_Debug' or '$(Configuration)' == 'Linux_Debug' or '$(Configuration)' == 'Mac_Debug' or '$(Configuration)' == 'Unix_Debug'">
    <ConfigurationGroup>Debug</ConfigurationGroup>
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">false</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">full</DebugType>
    <DefineConstants>$(DefineConstants);DEBUG;TRACE</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Release' or '$(Configuration)' == 'Windows_Release' or '$(Configuration)' == 'Linux_Release' or '$(Configuration)' == 'Mac_Release'or '$(Configuration)' == 'Unix_Release'">
    <ConfigurationGroup>Release</ConfigurationGroup>
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">true</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">pdbonly</DebugType>
    <DefineConstants>$(DefineConstants);TRACE</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Windows_Debug' or '$(Configuration)' == 'Windows_Release'">
    <OS>Windows_NT</OS>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Unix_Debug' or '$(Configuration)' == 'Unix_Release'">
    <OS>Unix</OS>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Linux_Debug' or '$(Configuration)' == 'Linux_Release'">
    <OS>Unix</OS> <!-- TODO: Determine actual settings once we have Linux vs Mac specialization -->
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Mac_Debug' or '$(Configuration)' == 'Mac_Release'">
    <OS>Unix</OS> <!-- TODO: Determine actual settings once we have Linux vs Mac specialization -->
  </PropertyGroup>

  <!-- Disable some standard properties for building our projects -->
  <PropertyGroup>
    <NoStdLib>true</NoStdLib>
    <NoExplicitReferenceToStdLib>true</NoExplicitReferenceToStdLib>
    <AddAdditionalExplicitAssemblyReferences>false</AddAdditionalExplicitAssemblyReferences>
    <GenerateTargetFrameworkAttribute>false</GenerateTargetFrameworkAttribute>
  </PropertyGroup>

  <!-- Setup some common paths -->
  <PropertyGroup>
    <CommonPath>$(SourceDir)Common\src</CommonPath>
    <CommonTestPath>$(SourceDir)Common\tests</CommonTestPath>
  </PropertyGroup>

  <!-- Setup the default output and intermediate paths -->
  <PropertyGroup>
    <BaseOutputPath Condition="'$(BaseOutputPath)'==''">$(ProjectDir)bin\</BaseOutputPath>
    <BaseOutputPathWithConfig>$(BaseOutputPath)$(OS)\$(ConfigurationGroup)\</BaseOutputPathWithConfig>
    <BaseOutputPathWithConfig Condition="'$(Platform)' != 'AnyCPU'">$(BaseOutputPath)$(Platform)\$(OS)\$(ConfigurationGroup)\</BaseOutputPathWithConfig>
    <OutputPath>$(BaseOutputPathWithConfig)$(MSBuildProjectName)\</OutputPath>

    <BaseIntermediateOutputPath Condition="'$(BaseIntermediateOutputPath)'==''">$(BaseOutputPath)obj\</BaseIntermediateOutputPath>
    <IntermediateOutputPath Condition="'$(IntermediateOutputPath)' == ''">$(BaseIntermediateOutputPath)$(MSBuildProjectName)\$(OS)\$(ConfigurationGroup)\</IntermediateOutputPath>
    <IntermediateOutputPath Condition="'$(IntermediateOutputPath)' == '' and '$(Platform)' != 'AnyCPU'">$(BaseIntermediateOutputPath)$(MSBuildProjectName)\$(Platform)\$(OS)\$(Configuration)\</IntermediateOutputPath>
    
    <TestPath>$(TestWorkingDir)$(MSBuildProjectName)\$(OS)\$(ConfigurationGroup)\</TestPath>
    <TestPath Condition="'$(Platform)' != 'AnyCPU'">$(TestWorkingDir)$(MSBuildProjectName)\$(Platform)\$(OS)\$(ConfigurationGroup)\</TestPath>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Work around known Dev14 bug - see
         https://connect.microsoft.com/VisualStudio/feedback/details/1000796/connect-file-uap-props-not-found-cant-build-a-portable-lib-on-vs14
    -->
    <_WindowsKitBinPath>$(MSBuildProgramFiles32)\Windows Kits\8.1\bin\x86</_WindowsKitBinPath>
    <_WindowsPhoneKitBinPath>$(MSBuildProgramFiles32)\Windows Phone Kits\8.1\bin</_WindowsPhoneKitBinPath>
    <MakePriExeFullPath>$(_WindowsKitBinPath)\makepri.exe</MakePriExeFullPath>
    <MakeAppxExeFullPath>$(_WindowsKitBinPath)\makeappx.exe</MakeAppxExeFullPath>
    <SignAppxPackageExeFullPath>$(_WindowsKitBinPath)\signtool.exe</SignAppxPackageExeFullPath>
    <MakePriExtensionPath>$(_WindowsPhoneKitBinPath)\x86\MrmEnvironmentExtDl.dll</MakePriExtensionPath>
    <MakePriExtensionPath_x64>$(_WindowsPhoneKitBinPath)\x64\MrmEnvironmentExtDl.dll</MakePriExtensionPath_x64>
  </PropertyGroup>
</Project>
