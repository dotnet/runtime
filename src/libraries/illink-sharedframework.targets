<Project>

  <Target Name="ILLinkTrimSharedFramework"
          AfterTargets="Build"
          DependsOnTargets="PrepareForAssembliesTrim">

    <Message Text="Trimming $(PackageRID) runtime pack assemblies with ILLinker..." Importance="high" />

    <PropertyGroup>
      <LibrariesTrimmedArtifactsPath>$([MSBuild]::NormalizePath('$(ArtifactsBinDir)', 'ILLinkTrimAssembly', '$(BuildSettings)', 'trimmed-runtimepack'))</LibrariesTrimmedArtifactsPath>
    </PropertyGroup>

    <PropertyGroup>
      <_AssemblyPaths>$(MicrosoftNetCoreAppRuntimePackRidLibTfmDir);$(SystemPrivateCoreLibPath)</_AssemblyPaths>
    </PropertyGroup>

    <ItemGroup>
      <!-- add references from the libraries directory -->
      <_DependencyDirectories Include="$(MicrosoftNetCoreAppRuntimePackRidLibTfmDir.TrimEnd('\'))" />
    </ItemGroup>

    <ItemGroup>
      <_LibrariesToLink Include="$(MicrosoftNetCoreAppRuntimePackRidLibTfmDir)*.dll" />
      <_LibrariesToLink Include="$(SystemPrivateCoreLibPath)" />

      <RootAssemblies Include="@(_LibrariesToLink)">
        <RootMode>library</RootMode>
      </RootAssemblies>
    </ItemGroup>

    <ItemGroup>
      <!-- Include suppression XML files bin-placed in earlier per-library linker run. -->
      <_SuppressionsXmls Include="$(ILLinkTrimAssemblyRuntimePackSuppressionsXmlsDir)*.xml" />

      <!-- Collate CoreLib suppression XML files not bin-placed in earlier per-library linker run. CoreLib doesn't use bin-place logic. -->
      <_SuppressionsXmls Include="$(CoreLibSharedDir)ILLink\ILLink.Suppressions.Shared.xml" />
      <_SuppressionsXmls Include="$(CoreLibSharedDir)ILLink\ILLink.Suppressions.LibraryBuild.xml" />
      <_SuppressionsXmls Condition="'$(RuntimeFlavor)' == 'CoreCLR'" Include="$(CoreClrProjectRoot)System.Private.CoreLib\$(ProjectILLinkSuppressionsFile).LibraryBuild.xml" />
    </ItemGroup>

    <PropertyGroup>
      <ILLinkArgs Condition="'@(_SuppressionsXmls)' != ''" >$(ILLinkArgs) --link-attributes &quot;@(_SuppressionsXmls->'%(FullPath)', '&quot; --link-attributes &quot;')&quot;</ILLinkArgs>
    </PropertyGroup>

    <ILLink AssemblyPaths=""
        RootAssemblyNames="@(RootAssemblies)"
        OutputDirectory="$(LibrariesTrimmedArtifactsPath)"
        ExtraArgs="$(ILLinkArgs)"
        ToolExe="$(_DotNetHostFileName)"
        ToolPath="$(_DotNetHostDirectory)" />
  </Target>
</Project>
