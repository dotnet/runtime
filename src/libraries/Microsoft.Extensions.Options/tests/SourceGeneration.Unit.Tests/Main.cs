// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.

using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using Microsoft.Extensions.Options;
using Microsoft.Extensions.Options.Generators;
using SourceGenerators.Tests;
using System;
using System.Collections.Generic;
using System.Collections.Immutable;
using System.ComponentModel.DataAnnotations;
using System.Globalization;
using System.Linq;
using System.Reflection;
using System.Threading.Tasks;
using Xunit;

namespace Microsoft.Gen.OptionsValidation.Unit.Test;

public class EmitterTests
{
    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task TestEmitterWithCustomValidator()
    {
        string source = """
            using System;
            using System.ComponentModel.DataAnnotations;
            using Microsoft.Extensions.Options;

            #nullable enable

            namespace HelloWorld
            {
                public class MyOptions
                {
                    [Required]
                    public string Val1 { get; set; } = string.Empty;

                    [Range(1, 3)]
                    public int Val2 { get; set; }
                }

                [OptionsValidator]
                public partial struct MyOptionsValidator : IValidateOptions<MyOptions>
                {
                }
            }
            """;

        string generatedSource = """

    // <auto-generated/>
    #nullable enable
    #pragma warning disable CS1591 // Compensate for https://github.com/dotnet/roslyn/issues/54103
    namespace HelloWorld
{
    partial struct MyOptionsValidator
    {
        /// <summary>
        /// Validates a specific named options instance (or all when <paramref name="name"/> is <see langword="null" />).
        /// </summary>
        /// <param name="name">The name of the options instance being validated.</param>
        /// <param name="options">The options instance.</param>
        /// <returns>Validation result.</returns>
        [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Extensions.Options.SourceGeneration", "42.42.42.42")]
        public global::Microsoft.Extensions.Options.ValidateOptionsResult Validate(string? name, global::HelloWorld.MyOptions options)
        {
            var baseName = (string.IsNullOrEmpty(name) ? "MyOptions" : name) + ".";
            var builder = new global::Microsoft.Extensions.Options.ValidateOptionsResultBuilder();
            var context = new global::System.ComponentModel.DataAnnotations.ValidationContext(options);
            var validationResults = new global::System.Collections.Generic.List<global::System.ComponentModel.DataAnnotations.ValidationResult>();
            var validationAttributes = new global::System.Collections.Generic.List<global::System.ComponentModel.DataAnnotations.ValidationAttribute>(1);

            context.MemberName = "Val1";
            context.DisplayName = baseName + "Val1";
            validationAttributes.Add(global::__OptionValidationStaticInstances.__Attributes.A1);
            if (!global::System.ComponentModel.DataAnnotations.Validator.TryValidateValue(options.Val1!, context, validationResults, validationAttributes))
            {
                builder.AddResults(validationResults);
            }

            context.MemberName = "Val2";
            context.DisplayName = baseName + "Val2";
            validationResults.Clear();
            validationAttributes.Clear();
            validationAttributes.Add(global::__OptionValidationStaticInstances.__Attributes.A2);
            if (!global::System.ComponentModel.DataAnnotations.Validator.TryValidateValue(options.Val2!, context, validationResults, validationAttributes))
            {
                builder.AddResults(validationResults);
            }

            return builder.Build();
        }
    }
}
namespace __OptionValidationStaticInstances
{
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Extensions.Options.SourceGeneration", "42.42.42.42")]
    internal static class __Attributes
    {
        internal static readonly global::System.ComponentModel.DataAnnotations.RequiredAttribute A1 = new global::System.ComponentModel.DataAnnotations.RequiredAttribute();

        internal static readonly global::System.ComponentModel.DataAnnotations.RangeAttribute A2 = new global::System.ComponentModel.DataAnnotations.RangeAttribute(
            (int)1,
            (int)3);
    }
}
namespace __OptionValidationStaticInstances
{
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Extensions.Options.SourceGeneration", "42.42.42.42")]
    internal static class __Validators
    {
    }
}

""";

        var (diagnostics, generatedSources) = await RoslynTestUtils.RunGenerator(
            new Generator(),
            new[]
            {
                Assembly.GetAssembly(typeof(RequiredAttribute))!,
                Assembly.GetAssembly(typeof(OptionsValidatorAttribute))!,
                Assembly.GetAssembly(typeof(IValidateOptions<object>))!,
            },
            new List<string> { source })
            .ConfigureAwait(false);

        Assert.Empty(diagnostics);
        _ = Assert.Single(generatedSources);

        Assert.Equal(generatedSource.Replace("\r\n", "\n"), generatedSources[0].SourceText.ToString().Replace("\r\n", "\n"));
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task PotentiallyMissingAttributes()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public SecondModel? P1 { get; set; }

                [Required]
                public System.Collections.Generic.IList<SecondModel>? P2 { get; set; }
            }

            public class SecondModel
            {
                [Required]
                public string? P3;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }
        ");

        Assert.Equal(2, diagnostics.Count);
        Assert.Equal(DiagDescriptors.PotentiallyMissingTransitiveValidation.Id, diagnostics[0].Id);
        Assert.Equal(DiagDescriptors.PotentiallyMissingEnumerableValidation.Id, diagnostics[1].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task CircularTypeReferences()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                [ValidateObjectMembers]
                public FirstModel? P1 { get; set; }
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.CircularTypeReferences.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task InvalidValidatorInterface()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public string? P1;
            }

            public class SecondModel
            {
                [Required]
                public string? P2;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            [OptionsValidator]
            public partial class SecondValidator
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.DoesntImplementIValidateOptions.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NotValidator()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [ValidateObjectMembers(typeof(SecondValidator)]
                public SecondModel? P1;
            }

            public class SecondModel
            {
                [Required]
                public string? P2;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            public partial class SecondValidator
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.DoesntImplementIValidateOptions.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ValidatorAlreadyImplementValidateFunction()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public string? P1;

                [ValidateObjectMembers(typeof(SecondValidator)]
                public SecondModel? P2;
            }

            public class SecondModel
            {
                [Required]
                public string? P3;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            [OptionsValidator]
            public partial class SecondValidator : IValidateOptions<SecondModel>
            {
                public ValidateOptionsResult Validate(string name, SecondModel options)
                {
                    throw new System.NotSupportedException();
                }
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.AlreadyImplementsValidateMethod.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NullValidator()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [ValidateObjectMembers(null!)]
                public SecondModel? P1;
            }

            public class SecondModel
            {
                [Required]
                public string? P2;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            [OptionsValidator]
            public partial class SecondValidator : IValidateOptions<SecondModel>
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.NullValidatorType.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NoSimpleValidatorConstructor()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public string? P1;

                [ValidateObjectMembers(typeof(SecondValidator)]
                public SecondModel? P2;
            }

            public class SecondModel
            {
                [Required]
                public string? P3;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            [OptionsValidator]
            public partial class SecondValidator : IValidateOptions<SecondModel>
            {
                public SecondValidator(int _)
                {
                }
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.ValidatorsNeedSimpleConstructor.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NoStaticValidator()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public string P1;
            }

            [OptionsValidator]
            public static partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.CantBeStaticClass.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task BogusModelType()
    {
        var (diagnostics, _) = await RunGenerator(@"
            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<Bogus>
            {
            }
        ");

        // the generator doesn't produce any errors here, since the C# compiler will take care of it
        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task CantValidateOpenGenericMembers()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel<T>
            {
                [Required]
                [ValidateObjectMembers]
                public T? P1;

                [ValidateObjectMembers]
                [Required]
                public T[]? P2;

                [ValidateObjectMembers]
                [Required]
                public System.Collections.Generics.IList<T> P3 = null!;
            }

            [OptionsValidator]
            public partial class FirstValidator<T> : IValidateOptions<FirstModel<T>>
            {
            }
        ");

        Assert.Equal(3, diagnostics.Count);
        Assert.Equal(DiagDescriptors.CantUseWithGenericTypes.Id, diagnostics[0].Id);
        Assert.Equal(DiagDescriptors.CantUseWithGenericTypes.Id, diagnostics[1].Id);
        Assert.Equal(DiagDescriptors.CantUseWithGenericTypes.Id, diagnostics[2].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ClosedGenerics()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel<T>
            {
                [Required]
                [ValidateObjectMembers]
                public T? P1;

                [ValidateObjectMembers]
                [Required]
                public T[]? P2;

                [ValidateObjectMembers]
                [Required]
                public int[]? P3;

                [ValidateObjectMembers]
                [Required]
                public System.Collections.Generics.IList<T>? P4;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel<string>>
            {
            }
        ");

        Assert.Equal(4, diagnostics.Count);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[0].Id);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[1].Id);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[2].Id);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[3].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NoEligibleMembers()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                [ValidateObjectMembers]
                public SecondModel? P1;
            }

            public class SecondModel
            {
                public string P2;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            [OptionsValidator]
            public partial class SecondValidator : IValidateOptions<SecondModel>
            {
            }
        ");

        Assert.Equal(2, diagnostics.Count);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[0].Id);
        Assert.Equal(DiagDescriptors.NoEligibleMembersFromValidator.Id, diagnostics[1].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task AlreadyImplemented()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public string One { get; set; } = string.Empty;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
                public void Validate(string name, FirstModel fm)
                {
                }
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.AlreadyImplementsValidateMethod.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldNotProduceInfoWhenTheClassHasABaseClass()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class Parent
                {
                    [Required]
                    public string parentString { get; set; }
                }

                public class Child : Parent
                {
                    [Required]
                    public string childString { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<Child>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldNotProduceInfoWhenTransitiveClassHasABaseClass()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class Parent
                {
                    [Required]
                    public string parentString { get; set; }
                }

                public class Child : Parent
                {
                    [Required]
                    public string childString { get; set; }
                }

                public class MyOptions
                {
                    [ValidateObjectMembers]
                    public Child childVal { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<MyOptions>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalTheory(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    [InlineData("bool")]
    [InlineData("int")]
    [InlineData("double")]
    [InlineData("string")]
    [InlineData("System.String")]
    [InlineData("System.DateTime")]
    public async Task ShouldProduceWarn_WhenTransitiveAttrMisused(string memberClass)
    {
        var (diagnostics, _) = await RunGenerator(@$"
                public class InnerModel
                {{
                    [Required]
                    public string childString {{ get; set; }}
                }}

                public class MyOptions
                {{
                    [Required]
                    public string simpleVal {{ get; set; }}

                    [ValidateObjectMembers]
                    public {memberClass} complexVal {{ get; set; }}
                }}

                [OptionsValidator]
                public partial class Validator : IValidateOptions<MyOptions>
                {{
                }}
            ");

        Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldProduceWarningWhenTheClassHasNoEligibleMembers()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class Child
                {
                    private string AccountName { get; set; }
                    public object Weight;
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<Child>
                {
                }
            ");

        Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.NoEligibleMembersFromValidator.Id, diagnostics[0].Id);
    }

    [ConditionalTheory(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    [InlineData("private")]
    [InlineData("protected")]
    public async Task ShouldProduceWarningWhenTheClassMembersAreInaccessible(string accessModifier)
    {
        var (diagnostics, _) = await RunGenerator($@"
                public class Model
                {{
                    [Required]
                    public string? PublicVal {{ get; set; }}

                    [Required]
                    {accessModifier} string? Val {{ get; set; }}
                }}

                [OptionsValidator]
                public partial class Validator : IValidateOptions<Model>
                {{
                }}
            ");

        Assert.Single(diagnostics);
        Assert.Equal("SYSLIB1206", diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldNotProduceErrorWhenMultipleValidationAnnotationsExist()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    [MinLength(5)]
                    [MaxLength(15)]
                    public string Val9 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldNotProduceErrorWhenDataTypeAttributesAreUsed()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    [CreditCard]
                    public string Val3 = """";

                    [EmailAddress]
                    public string Val6 { get; set; }

                    [EnumDataType(typeof(string))]
                    public string Val7 { get; set; }

                    [FileExtensions]
                    public string Val8 { get; set; }

                    [Phone]
                    public string Val10 { get; set; }

                    [Url]
                    public string Val11 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldNotProduceErrorWhenConstVariableIsUsedAsAttributeArgument()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    private const int q = 5;
                    [Range(q, 10)]
                    public string Val11 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    // Testing on all existing & eligible annotations extending ValidationAttribute that aren't used above
    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldNotProduceAnyMessagesWhenExistingValidationsArePlaced()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    [Required]
                    public string Val { get; set; }

                    [Compare(""val"")]
                    public string Val2 { get; set; }

                    [DataType(DataType.Password)]
                    public string _val5 = """";

                    [Range(5.1, 10.11)]
                    public string Val12 { get; set; }

                    [Range(typeof(MemberDeclarationSyntax), ""1/2/2004"", ""3/4/2004"")]
                    public string Val14 { get; set; }

                    [RegularExpression("""")]
                    public string Val15 { get; set; }

                    [StringLength(5)]
                    public string Val16 { get; set; }

                    [CustomValidation(typeof(MemberDeclarationSyntax), ""CustomMethod"")]
                    public string Val17 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldNotProduceErrorWhenPropertiesAreUsedAsAttributeArgument()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    private const int q = 5;
                    [Range(q, 10, ErrorMessage = ""ErrorMessage"")]
                    public string Val11 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldSkipWhenOptionsValidatorAttributeDoesNotExist()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    private const int q = 5;
                    [Range(q, 10, ErrorMessage = ""ErrorMessage"")]
                    public string Val11 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ", includeOptionValidatorReferences: false);

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldSkipAtrributeWhenAttributeSymbolCannotBeFound()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    [RandomTest]
                    public string Val11 { get; set; }

                    [Range(1, 10, ErrorMessage = ""ErrorMessage"")]
                    public string Val12 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldSkipAtrributeWhenAttributeSymbolIsNotBasedOnValidationAttribute()
    {
        var (diagnostics, _) = await RunGenerator(@"
                public class IValidateOptionsTestFile
                {
                    [FilterUIHint(""MultiForeignKey"")]
                    public string Val11 { get; set; }

                    [Range(1, 10, ErrorMessage = ""ErrorMessage"")]
                    public string Val12 { get; set; }
                }

                [OptionsValidator]
                public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                {
                }
            ");

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldAcceptAtrributeWhenAttributeIsInDifferentNamespace()
    {
        var (diagnostics, _) = await RunGenerator(@"
                namespace Test {
                    public class IValidateOptionsTestFile
                    {
                        [Test]
                        public string Val11 { get; set; }
                    }

                    [AttributeUsage(AttributeTargets.Class)]
                    public sealed class TestAttribute : ValidationAttribute
                    {
                    }

                    [OptionsValidator]
                    public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                    {
                    }
                }
            ", inNamespace: false);

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldHandleAtrributePropertiesOtherThanString()
    {
        var (diagnostics, _) = await RunGenerator(@"
                namespace Test {
                    public class IValidateOptionsTestFile
                    {
                        [Test(num = 5)]
                        public string Val11 { get; set; }

                        [Required]
                        public string Val12 { get; set; }
                    }

                    [OptionsValidator]
                    public partial class Validator : IValidateOptions<IValidateOptionsTestFile>
                    {
                    }
                }

                namespace System.ComponentModel.DataAnnotations {
                    [AttributeUsage(AttributeTargets.Class)]
                    public sealed class TestAttribute : ValidationAttribute
                    {
                        public int num { get; set; }
                        public TestAttribute() {
                        }
                    }
                }
            ", inNamespace: false);

        Assert.Empty(diagnostics);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ShouldStoreFloatValuesCorrectly()
    {
        var backupCulture = CultureInfo.CurrentCulture;
        CultureInfo.CurrentCulture = new CultureInfo("ru-RU", false);
        try
        {
            var (diagMessages, generatedResults) = await RunGenerator(@"
                    public class Model
                    {
                        [Range(-0.1, 1.3)]
                        public string Val { get; set; }
                    }

                    [OptionsValidator]
                    public partial class Validator : IValidateOptions<Model>
                    {
                    }
                ");

            Assert.Empty(diagMessages);
            Assert.Single(generatedResults);
            Assert.DoesNotContain("0,1", generatedResults[0].SourceText.ToString());
            Assert.DoesNotContain("1,3", generatedResults[0].SourceText.ToString());
        }
        finally
        {
            CultureInfo.CurrentCulture = backupCulture;
        }
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task MultiModelValidatorGeneratesOnlyOnePartialTypeBlock()
    {
        var (diagnostics, sources) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public string P1 { get; set; }
            }

            public class SecondModel
            {
                [Required]
                public string P2 { get; set; }
            }

            public class ThirdModel
            {
                [Required]
                public string P3 { get; set; }
            }

            [OptionsValidator]
            public partial class MultiValidator : IValidateOptions<FirstModel>, IValidateOptions<SecondModel>, IValidateOptions<ThirdModel>
            {
            }
        ");

        var typeDeclarations = sources[0].SyntaxTree
            .GetRoot()
            .DescendantNodes()
            .OfType<TypeDeclarationSyntax>()
            .ToArray();

        var multiValidatorTypeDeclarations = typeDeclarations
            .Where(x => x.Identifier.ValueText == "MultiValidator")
            .ToArray();

        Assert.Single(multiValidatorTypeDeclarations);

        var validateMethodDeclarations = multiValidatorTypeDeclarations[0]
            .DescendantNodes()
            .OfType<MethodDeclarationSyntax>()
            .Where(x => x.Identifier.ValueText == "Validate")
            .ToArray();

        Assert.Equal(3, validateMethodDeclarations.Length);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task CircularTypeReferencesInEnumeration()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                [ValidateEnumeratedItems]
                public FirstModel[]? P1 { get; set; }
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.CircularTypeReferences.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NotValidatorInEnumeration()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [ValidateEnumeratedItems(typeof(SecondValidator)]
                public SecondModel[]? P1;
            }

            public class SecondModel
            {
                [Required]
                public string? P2;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            public partial class SecondValidator
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.DoesntImplementIValidateOptions.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NullValidatorInEnumeration()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [ValidateEnumeratedItems(null!)]
                public SecondModel[]? P1;
            }

            public class SecondModel
            {
                [Required]
                public string? P2;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            [OptionsValidator]
            public partial class SecondValidator : IValidateOptions<SecondModel>
            {
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.NullValidatorType.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NoSimpleValidatorConstructorInEnumeration()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                public string? P1;

                [ValidateEnumeratedItems(typeof(SecondValidator)]
                public SecondModel[]? P2;
            }

            public class SecondModel
            {
                [Required]
                public string? P3;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }

            [OptionsValidator]
            public partial class SecondValidator : IValidateOptions<SecondModel>
            {
                public SecondValidator(int _)
                {
                }
            }
        ");

        _ = Assert.Single(diagnostics);
        Assert.Equal(DiagDescriptors.ValidatorsNeedSimpleConstructor.Id, diagnostics[0].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task CantValidateOpenGenericMembersInEnumeration()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel<T>
            {
                [Required]
                [ValidateEnumeratedItems]
                public T[]? P1;

                [ValidateEnumeratedItems]
                [Required]
                public T[]? P2;

                [ValidateEnumeratedItems]
                [Required]
                public System.Collections.Generic.IList<T> P3 = null!;
            }

            [OptionsValidator]
            public partial class FirstValidator<T> : IValidateOptions<FirstModel<T>>
            {
            }
        ");

        Assert.Equal(3, diagnostics.Count);
        Assert.Equal(DiagDescriptors.CantUseWithGenericTypes.Id, diagnostics[0].Id);
        Assert.Equal(DiagDescriptors.CantUseWithGenericTypes.Id, diagnostics[1].Id);
        Assert.Equal(DiagDescriptors.CantUseWithGenericTypes.Id, diagnostics[2].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task ClosedGenericsInEnumeration()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel<T>
            {
                [ValidateEnumeratedItems]
                [Required]
                public T[]? P1;

                [ValidateEnumeratedItems]
                [Required]
                public int[]? P2;

                [ValidateEnumeratedItems]
                [Required]
                public System.Collections.Generic.IList<T>? P3;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel<string>>
            {
            }
        ");

        Assert.Equal(3, diagnostics.Count);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[0].Id);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[1].Id);
        Assert.Equal(DiagDescriptors.NoEligibleMember.Id, diagnostics[2].Id);
    }

    [ConditionalFact(typeof(PlatformDetection), nameof(PlatformDetection.IsNotBrowser))]
    public async Task NotEnumerable()
    {
        var (diagnostics, _) = await RunGenerator(@"
            public class FirstModel
            {
                [Required]
                [ValidateEnumeratedItems]
                public int P1;
            }

            [OptionsValidator]
            public partial class FirstValidator : IValidateOptions<FirstModel>
            {
            }
        ");

        Assert.Equal(1, diagnostics.Count);
        Assert.Equal(DiagDescriptors.NotEnumerableType.Id, diagnostics[0].Id);
    }

    private static async Task<(IReadOnlyList<Diagnostic> diagnostics, ImmutableArray<GeneratedSourceResult> generatedSources)> RunGenerator(
        string code,
        bool wrap = true,
        bool inNamespace = true,
        bool includeOptionValidatorReferences = true,
        bool includeSystemReferences = true,
        bool includeOptionsReferences = true,
        bool includeTransitiveReferences = true)
    {
        var text = code;
        if (wrap)
        {
            var nspaceStart = "namespace Test {";
            var nspaceEnd = "}";
            if (!inNamespace)
            {
                nspaceStart = "";
                nspaceEnd = "";
            }

            text = $@"
                    {nspaceStart}
                    using System.ComponentModel.DataAnnotations;
                    using Microsoft.Extensions.Options.Validation;
                    using Microsoft.Shared.Data.Validation;
                    using Microsoft.Extensions.Options;
                    using Microsoft.CodeAnalysis.CSharp.Syntax;
                    {code}
                    {nspaceEnd}
                ";
        }

        var assemblies = new List<Assembly> { Assembly.GetAssembly(typeof(MemberDeclarationSyntax))! };

        if (includeOptionValidatorReferences)
        {
            assemblies.Add(Assembly.GetAssembly(typeof(OptionsValidatorAttribute))!);
        }

        if (includeSystemReferences)
        {
            assemblies.Add(Assembly.GetAssembly(typeof(RequiredAttribute))!);
        }

        if (includeOptionsReferences)
        {
            assemblies.Add(Assembly.GetAssembly(typeof(IValidateOptions<object>))!);
        }

        if (includeTransitiveReferences)
        {
            assemblies.Add(Assembly.GetAssembly(typeof(Microsoft.Extensions.Options.ValidateObjectMembersAttribute))!);
        }

        var result = await RoslynTestUtils.RunGenerator(new Generator(), assemblies.ToArray(), new[] { text })
            .ConfigureAwait(false);

        return result;
    }
}
