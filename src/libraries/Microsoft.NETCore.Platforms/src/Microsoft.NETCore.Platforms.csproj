<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>$(BundledNETCoreAppTargetFramework)</TargetFramework>
    <IsPackable>true</IsPackable>
    <IsShipping>false</IsShipping>
    <SuppressDependenciesWhenPacking>true</SuppressDependenciesWhenPacking>
    <PackageDescription>Provides runtime information required to resolve target framework, platform, and runtime specific implementations of .NET packages.</PackageDescription>
    <NoWarn>$(NoWarn);NU5128</NoWarn> <!-- No Dependencies-->

    <!-- Opt out of features that aren't necessary for a local build task. -->
    <EnableBinPlacing>false</EnableBinPlacing>
    <!-- This project should not build against the live built .NETCoreApp targeting pack as it contributes to the build itself. -->
    <UseLocalTargetingRuntimePack>false</UseLocalTargetingRuntimePack>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <IncludeSymbols>false</IncludeSymbols>
    <!-- TODO: Remove when a newer SDK with that property exposed is available. -->
    <NetCoreSdkRoot Condition="'$(NetCoreSdkRoot)' == ''">$([System.IO.Path]::GetDirectoryName('$(BundledRuntimeIdentifierGraphFile)'))\</NetCoreSdkRoot>
  </PropertyGroup>

  <ItemGroup Condition="'$(DotNetBuildSourceOnly)' == 'true'">
    <!--
      When building from source, ensure the RID we're building for and the RID we're building on are part of the RID graph.
      The RID we're targeting may not be part of the graph because source-build builds are generally non-portable.
      The RID we're building on may not be part of the RID graph if we are being built with a source-built SDK.
      If we're cross-building (for example building source-build for a new version of an existing distro and bootstrapping from an old version)
      then the RID we're building on would be different than the RID we're targeting.
    -->
    <AdditionalRuntimeIdentifiers Include="$(TargetRid)" Imports="$(PortableTargetRid)" />
    <AdditionalRuntimeIdentifiers Include="$(NETCoreSdkRuntimeIdentifier)" Imports="$(NETCoreSdkPortableRuntimeIdentifier)" />
  </ItemGroup>

  <ItemGroup>
    <Compile Include="UpdateRuntimeIdentifierGraph.cs" />
  </ItemGroup>

  <ItemGroup Condition="'@(AdditionalRuntimeIdentifiers)' == ''">
    <Content Include="runtime.json" PackagePath="/" />
    <Content Include="PortableRuntimeIdentifierGraph.json" PackagePath="/" />
  </ItemGroup>

  <ItemGroup Condition="'@(AdditionalRuntimeIdentifiers)' != ''">
    <Content Include="$(BaseOutputPath)runtime.json" PackagePath="/" />
    <Content Include="$(BaseOutputPath)PortableRuntimeIdentifierGraph.json" PackagePath="/" />
  </ItemGroup>

  <!-- Reference these assemblies from the SDK directly. We do this to avoid bringing the package closure for assemblies we don't use here. -->
  <ItemGroup>
    <Reference Include="$(NetCoreSdkRoot)Microsoft.Build.Framework.dll" Private="false" />
    <Reference Include="$(NetCoreSdkRoot)Microsoft.Build.Utilities.Core.dll" Private="false" />
    <Reference Include="$(NetCoreSdkRoot)Newtonsoft.Json.dll" Private="false" />
  </ItemGroup>

  <UsingTask TaskName="UpdateRuntimeIdentifierGraph" AssemblyFile="$(TargetPath)" Runtime="NET" TaskFactory="TaskHostFactory" />
  <Target Name="UpdateRuntimeIdentifierGraph"
          AfterTargets="Build"
          Condition="'@(AdditionalRuntimeIdentifiers)' != ''">
    <!-- non portable RID graph -->
    <UpdateRuntimeIdentifierGraph InputFile="runtime.json"
                                  OutputFile="$(BaseOutputPath)runtime.json"
                                  AdditionalRuntimeIdentifiers="@(AdditionalRuntimeIdentifiers)" />

    <!-- portable RID graph -->
    <UpdateRuntimeIdentifierGraph InputFile="PortableRuntimeIdentifierGraph.json"
                                  OutputFile="$(BaseOutputPath)PortableRuntimeIdentifierGraph.json"
                                  AdditionalRuntimeIdentifiers="@(AdditionalRuntimeIdentifiers)" />
  </Target>

</Project>
