<Project>
  <PropertyGroup>
    <AsnXml />
  </PropertyGroup>
  <ItemGroup>
    <None Include="$(MSBuildThisFileDirectory)asn.xsd">
      <Link>Common\System\Security\Cryptography\Asn1\asn.xsd</Link>
    </None>
  </ItemGroup>

  <UsingTask
    TaskName="CompareFilesIgnoreLineEndings"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <GeneratedFile ParameterType="Microsoft.Build.Framework.ITaskItem" Required="true" />
      <ExistingFile ParameterType="Microsoft.Build.Framework.ITaskItem" Required="true" />
      <ContentsDiffer ParameterType="System.Boolean" Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.Collections.Generic" />
      <Using Namespace="System.IO" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
          if (!File.Exists(ExistingFile.ItemSpec))
          {
              ContentsDiffer = true;
              return true;
          }

          using (IEnumerator<string> existingLines = File.ReadLines(ExistingFile.ItemSpec).GetEnumerator())
          using (IEnumerator<string> generatedLines = File.ReadLines(GeneratedFile.ItemSpec).GetEnumerator())
          {
              while (generatedLines.MoveNext())
              {
                  if (!existingLines.MoveNext())
                  {
                      ContentsDiffer = true;
                      return true;
                  }

                  if (generatedLines.Current != existingLines.Current)
                  {
                      ContentsDiffer = true;
                      return true;
                  }
              }

              ContentsDiffer = existingLines.MoveNext();
          }
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="CompileAsn" BeforeTargets="CoreCompile"
    Condition=" '@(AsnXml)' != '' "
    Inputs="@(AsnXml);$(MSBuildThisFileDirectory)asn.xslt"
    Outputs="%(Identity).cs">

    <PropertyGroup>
      <_AsnIntermediatePath>$([MSBuild]::NormalizeDirectory('$(IntermediateOutputPath)', 'asnxml'))</_AsnIntermediatePath>
    </PropertyGroup>

    <MakeDir Directories="$(_AsnIntermediatePath)" />

    <XslTransformation
      XslInputPath="$(MSBuildThisFileDirectory)asn.xslt"
      XmlInputPaths="@(AsnXml)"
      OutputPaths="@(AsnXml -> '$(_AsnIntermediatePath)%(filename).cs')" />

    <CompareFilesIgnoreLineEndings
      GeneratedFile="@(AsnXml -> '$(_AsnIntermediatePath)%(filename).cs')"
      ExistingFile="@(AsnXml -> '%(Identity).cs')">
      <Output TaskParameter="ContentsDiffer" ItemName="_FilesDiffer" />
    </CompareFilesIgnoreLineEndings>

    <Copy
      Condition="'@(_FilesDiffer)' == 'True'"
      SourceFiles="@(AsnXml -> '$(_AsnIntermediatePath)%(filename).cs')"
      DestinationFiles="@(AsnXml -> '%(Identity).cs')" />

    <Warning Condition="'@(_FilesDiffer)' == 'True'" Text="AsnXml regenerated files, be sure to check them in: @(AsnXml -> '%(Identity).cs')" />
  </Target>
</Project>
