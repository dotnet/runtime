<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <!-- This test project is Android-only and uses network_security_config.xml -->
    <TargetFrameworks>$(NetCoreAppCurrent)-android</TargetFrameworks>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="AndroidPlatformTrustTests.cs" />

    <!-- Common test files -->
    <Compile Include="$(CommonTestPath)System\Net\Configuration.cs"
             Link="Common\System\Net\Configuration.cs" />
    <Compile Include="$(CommonTestPath)System\Net\Configuration.Certificates.cs"
             Link="Common\System\Net\Configuration.Certificates.cs" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="System.Net.TestData" Version="$(SystemNetTestDataVersion)" />
  </ItemGroup>

  <!-- Android network security config setup -->
  <PropertyGroup>
    <_NetworkSecurityConfigDir>$(IntermediateOutputPath)network-security-config</_NetworkSecurityConfigDir>
  </PropertyGroup>

  <Target Name="_PrepareNetworkSecurityConfig"
          BeforeTargets="_AndroidGenerateAppBundle"
          DependsOnTargets="CopyFilesToOutputDirectory">
    <PropertyGroup>
      <!-- Extract root CA from PKCS#7 bundle (contains root) -->
      <_CaCertP7bPath>$(OutputPath)TestData/contoso.com.p7b</_CaCertP7bPath>
      <_CaCertDerPath>$(_NetworkSecurityConfigDir)/res/raw/test_ca.der</_CaCertDerPath>
      <_FinalNetworkSecurityConfigPath>$(_NetworkSecurityConfigDir)/network_security_config.xml</_FinalNetworkSecurityConfigPath>
    </PropertyGroup>

    <MakeDir Directories="$(_NetworkSecurityConfigDir)/res/raw" />

    <!-- Extract root CA from PKCS#7 bundle and write as DER -->
    <ExtractRootCA P7bPath="$(_CaCertP7bPath)" OutputPath="$(_CaCertDerPath)" />

    <!-- Copy network_security_config.xml to the intermediate directory -->
    <Copy SourceFiles="$(MSBuildThisFileDirectory)network_security_config.xml"
          DestinationFiles="$(_FinalNetworkSecurityConfigPath)" />

    <Message Importance="High" Text="Prepared network security config at $(_FinalNetworkSecurityConfigPath)" />
  </Target>

  <PropertyGroup>
    <NetworkSecurityConfig>$(IntermediateOutputPath)network-security-config/network_security_config.xml</NetworkSecurityConfig>
    <NetworkSecurityConfigResourcesDir>$(IntermediateOutputPath)network-security-config/res</NetworkSecurityConfigResourcesDir>
  </PropertyGroup>

  <UsingTask TaskName="ExtractRootCA" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <P7bPath ParameterType="System.String" Required="true" />
      <OutputPath ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.Security.Cryptography.X509Certificates" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
        var collection = new X509Certificate2Collection();
        byte[] rootRawData = null;
        try
        {
            collection.Import(P7bPath);
            foreach (X509Certificate2 cert in collection)
            {
                if (cert.Subject == cert.Issuer)
                {
                    rootRawData = cert.Export(X509ContentType.Cert);
                    break;
                }
            }
            if (rootRawData == null)
                throw new Exception("Root CA not found in " + P7bPath);
            System.IO.File.WriteAllBytes(OutputPath, rootRawData);
        }
        finally
        {
            foreach (X509Certificate2 cert in collection)
            {
                cert.Dispose();
            }
        }
        ]]>
      </Code>
    </Task>
  </UsingTask>

</Project>
