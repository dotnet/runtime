<Project Sdk="Microsoft.Build.Traversal">

  <Import Project="$(RepositoryEngineeringDir)testing\coverage.props" Condition="'$(Coverage)' == 'true'" />

  <PropertyGroup>
    <TestInParallel Condition="'$(Coverage)' != 'true'">true</TestInParallel>
    <!-- For tests we want to continue running if a test run failed. -->
    <TestContinueOnError>ErrorAndContinue</TestContinueOnError>
    <TraversalGlobalProperties>BuildAllProjects=true</TraversalGlobalProperties>
    <CoverageReportInputPath>$(ArtifactsBinDir)*.Tests/**/coverage.xml</CoverageReportInputPath>
    <CoverageReportDir>$(ArtifactsDir)coverage</CoverageReportDir>
  </PropertyGroup>

  <!-- These projects are required to restore the runtime and setup testhost -->
  <ItemGroup Condition="'$(DotNetBuildFromSource)' != 'true' and '$(BuildAllConfigurations)' != 'true' and '$(ContinuousIntegrationBuild)' == 'true'" >
    <SetupProject Include="$(MSBuildThisFileDirectory)restore\runtime\runtime.depproj" />
    <SetupProject Include="$(MSBuildThisFileDirectory)pretest.proj" />
    <!-- Restore projects and build before/after. -->
    <ProjectReference Include="@(SetupProject)" Condition="'$(MSBuildRestoreSessionId)' != ''" />
  </ItemGroup>

  <ItemGroup>
    <!-- We currently only test with C# projects. -->
    <ProjectReference Include="$(MSBuildThisFileDirectory)*\tests\**\*.Tests.csproj"
                      Exclude="@(ProjectExclusions)"
                      Condition="'$(BuildAllConfigurations)' != 'true'" />
    <ProjectReference Include="$(MSBuildThisFileDirectory)pkg\test\testPackages.proj"
                      Condition="'$(BuildAllConfigurations)' == 'true'" />
  </ItemGroup>

  <Target Name="PrepareTestHost"
          Condition="'@(SetupProject)' != ''"
          BeforeTargets="Build">
    <MSBuild Targets="Build"
             Projects="@(SetupProjects)"
             Properties="$(TraversalGlobalProperties)" />
  </Target>

  <Target Name="GenerateCoverageReport"
          Condition="'$(Coverage)' == 'true' == 'true' and '$(SkipCoverageReport)' != 'true'"
          AfterTargets="Test"
          Inputs="$(CoverageReportInputPath)"
          Outputs="$(CoverageReportResultsPath)">
    <Exec Command="$(CoverageReportCommandLine)" />
  </Target>

  <Import Project="$(RepositoryEngineeringDir)testing\coverage.targets" Condition="'$(Coverage)' == 'true'" />

</Project>
