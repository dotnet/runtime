<Project>

  <Target Name="ILLinkTrimOOBAssemblies"
          AfterTargets="Build"
          DependsOnTargets="PrepareForAssembliesTrim">

    <Message Text="Trimming $(PackageRID) OOB assemblies with ILLinker..." Importance="high" />

    <PropertyGroup>
      <LibrariesTrimmedOOBArtifactsPath>$([MSBuild]::NormalizePath('$(ArtifactsBinDir)', 'ILLinkTrimAssembly', '$(BuildSettings)', 'trimmed-oobs'))</LibrariesTrimmedOOBArtifactsPath>
    </PropertyGroup>

    <ItemGroup>
      <!-- add references from the libraries directory -->
      <_DependencyDirectories Include="$(NetCoreAppCurrentRuntimePath.TrimEnd('\'))" />
    </ItemGroup>

    <ItemGroup>
      <_OOBsToLink Include="$(NetCoreAppCurrentRuntimePath)*.dll" Exclude="$(NetCoreAppCurrentRuntimePath)*.Generator.dll;$(NetCoreAppCurrentRuntimePath)*.Native.dll" />
      <_RuntimePackLinkedAssemblies Include="$(MicrosoftNetCoreAppRuntimePackRidLibTfmDir)*.dll" />
      <_OOBsToFileName Include="@(_OOBsToLink -> '%(FileName)')">
        <OriginalIdentity>%(Identity)</OriginalIdentity>
      </_OOBsToFileName>
      <_RuntimePackAssembliesToFileName Include="@(_RuntimePackLinkedAssemblies -> '%(FileName)')">
        <OriginalIdentity>%(Identity)</OriginalIdentity>
      </_RuntimePackAssembliesToFileName>

      <_FinalOOBsFileName Include="@(_OOBsToFileName)" Exclude="@(_RuntimePackAssembliesToFileName)" />
      <_FinalOOBReferences Include="@(_OOBsToFileName)" Exclude="@(_FinalOOBsFileName)" />
      <_FinalOOBs Include="@(_FinalOOBsFileName -> '%(OriginalIdentity)')" />
      <_FinalReferences Include="@(_FinalOOBReferences -> '%(OriginalIdentity)')" />
      <_FinalReferences Include="$(SystemPrivateCoreLibPath)" />


      <OOBRootAssemblies Include="@(_FinalOOBs)">
        <RootMode>library</RootMode>
      </OOBRootAssemblies>
    </ItemGroup>

    <ItemGroup>
      <!-- Include suppression XML files bin-placed in earlier per-library linker run. -->
      <_SuppressionsXmls Include="$(ILLinkTrimAssemblyOOBSuppressionsXmlsDir)*.xml" />
    </ItemGroup>

   <PropertyGroup>
      <ILLinkArgs Condition="'@(_SuppressionsXmls)' != ''" >$(ILLinkArgs) --link-attributes &quot;@(_SuppressionsXmls->'%(FullPath)', '&quot; --link-attributes &quot;')&quot;</ILLinkArgs>
    </PropertyGroup>

    <ILLink AssemblyPaths=""
        RootAssemblyNames="@(OOBRootAssemblies)"
        ReferenceAssemblyPaths="@(_FinalReferences)"
        OutputDirectory="$(LibrariesTrimmedOOBArtifactsPath)"
        ExtraArgs="$(ILLinkArgs)"
        ToolExe="$(_DotNetHostFileName)"
        ToolPath="$(_DotNetHostDirectory)" />
  </Target>
</Project>
