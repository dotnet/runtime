<Project>
  <Target Name="GetEventLogMessagePaths">
    <PropertyGroup>
      <_eventLogMessagesResources>Messages\EventLogMessages.res</_eventLogMessagesResources>
      <_eventLogMessagesAssemblyName>$(MSBuildProjectName).Messages</_eventLogMessagesAssemblyName>
      <_eventLogMessagesOutputAssembly>$(IntermediateOutputPath)$(_eventLogMessagesAssemblyName).dll</_eventLogMessagesOutputAssembly>
      <_eventLogMessagesOutputSymbols>$(IntermediateOutputPath)$(_eventLogMessagesAssemblyName).pdb</_eventLogMessagesOutputSymbols>
      <_eventLogMessagesAssemblyInfo>$(IntermediateOutputPath)$(_eventLogMessagesAssemblyName).AssemblyInfo.cs</_eventLogMessagesAssemblyInfo>
    </PropertyGroup>
  </Target>

  <Target Name="GenerateEventLogMessages"
          AfterTargets="CoreCompile"
          DependsOnTargets="ResolveReferences;GenerateTargetFrameworkMonikerAttribute;GetAssemblyAttributes;GetEventLogMessagePaths"
          Inputs="$(_eventLogMessagesResources);$(MSBuildAllProjects)"
          Outputs="$(_eventLogMessagesOutputAssembly)">
    <ItemGroup>
      <_eventLogMessagesCompile Include="$(TargetFrameworkMonikerAssemblyAttributesPath)" />

      <_eventLogMessagesAttribute Include="@(AssemblyAttribute)" />
      <_eventLogMessagesAttribute Condition="'%(_eventLogMessagesAttribute._Parameter1)' == '$(AssemblyName)'">
        <_Parameter1>$(_eventLogMessagesAssemblyName)</_Parameter1>
      </_eventLogMessagesAttribute>
      <!-- we don't require this attribute and don't want to define it on downlevel platforms -->
      <_eventLogMessagesAttribute Remove="System.Runtime.Versioning.SupportedOSPlatform" />
    </ItemGroup>

    <WriteCodeFragment AssemblyAttributes="@(_eventLogMessagesAttribute)" Language="C#" OutputFile="$(_eventLogMessagesAssemblyInfo)">
      <Output TaskParameter="OutputFile" ItemName="_eventLogMessagesCompile" />
      <Output TaskParameter="OutputFile" ItemName="FileWrites" />
    </WriteCodeFragment>

    <Csc OutputAssembly="$(_eventLogMessagesOutputAssembly)"
         Sources="@(_eventLogMessagesCompile)"
         Win32Resource="$(_eventLogMessagesResources)"
         References="@(ReferencePath)"
         DebugType="$(DebugType)"
         KeyContainer="$(KeyContainerName)"
         KeyFile="$(KeyOriginatorFile)"
         NoConfig="true"
         NoLogo="$(NoLogo)"
         NoStandardLib="$(NoCompilerStandardLib)"
         PdbFile="$(_eventLogMessagesOutputSymbols)"
         PublicSign="$(PublicSign)"
         DelaySign="$(DelaySign)"
         Deterministic="$(Deterministic)"
         DisabledWarnings="$(DisabledWarnings)"
         WarningLevel="$(WarningLevel)"
         WarningsAsErrors="$(WarningsAsErrors)"
         WarningsNotAsErrors="$(WarningsNotAsErrors)"
         TargetType="Library"
         ToolExe="$(CscToolExe)"
         ToolPath="$(CscToolPath)"
         UseSharedCompilation="$(UseSharedCompilation)">

      <Output TaskParameter="OutputAssembly" ItemName="FileWrites"/>
      <Output TaskParameter="OutputAssembly" ItemName="ReferenceCopyLocalPaths" />
    </Csc>
  </Target>
  <Target Name="_AddMessagesToPackage"
          BeforeTargets="GetFilesToPackage"
          DependsOnTargets="GetEventLogMessagePaths">
    <ItemGroup>
      <AdditionalFileToPackage Include="$(_eventLogMessagesOutputAssembly)" />
      <AdditionalFileToPackage Include="$(_eventLogMessagesOutputSymbols)" />
    </ItemGroup>
  </Target>
</Project>