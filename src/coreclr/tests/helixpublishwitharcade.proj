<Project Sdk="Microsoft.DotNet.Helix.Sdk" DefaultTargets="SubmitTestsToHelix">

  <!-- This project uses the helix SDK ,documented at
       https://github.com/dotnet/arcade/tree/master/src/Microsoft.DotNet.Helix/Sdk,
       to send test jobs to helix. -->

  <Import Project="..\dir.props" />

  <PropertyGroup>
    <!-- TODO: pick appropriate helix source and type. -->
    <HelixSource>pr/coreclr/master</HelixSource>
    <HelixType>test/stuff</HelixType>
    <HelixBuild>$(BUILD_BUILDNUMBER)</HelixBuild>

    <EnableXUnitReporter>true</EnableXUnitReporter>
    <WaitForWorkItemCompletion>true</WaitForWorkItemCompletion>
    <SourceDirectory>$(MSBuildProjectDirectory)/..</SourceDirectory>
  </PropertyGroup>

  <ItemGroup>
    <HelixCorrelationPayload Include="$(SourceDirectory)\bin\tests\*\archive\Core_Root\*.zip">
      <PayloadArchive>%(Identity)</PayloadArchive>
    </HelixCorrelationPayload>
  </ItemGroup>

  <Target Name="SubmitTestsToHelix">
    <ItemGroup>
      <Scenarios Include="$(Scenarios)" />
      <ProjectsToBuild Include="$(MSBuildProjectFile)">
        <Properties>Scenario=%(Scenarios.Identity)</Properties>
      </ProjectsToBuild>
    </ItemGroup>

    <PropertyGroup>
      <BuildInParallel>false</BuildInParallel>
      <BuildInParallel Condition=" '@(ProjectsToBuild->Count())' > '1' ">true</BuildInParallel>
    </PropertyGroup>

    <MSBuild Projects="@(ProjectsToBuild)" Targets="Test" BuildInParallel="$(BuildInParallel)" StopOnFirstFailure="false" UnloadProjectsOnCompletion="true" />
  </Target>

  <Target Name="BuildHelixWorkItem"
          BeforeTargets="Test">
    <PropertyGroup>
      <!-- The "normal" scenario is just a way to include the default
           (empty) scenario when specifying multiple scenarios at
           once. From here, on, treat it as the empty scenario so that
           job names will not have a scenario prefix and the runtest
           script doesn't have to define a "normal" scenario. -->
      <Scenario Condition=" '$(Scenario)' == 'normal' "></Scenario>
      <ScenarioPrefix Condition=" '$(Scenario)' == '' " />
      <ScenarioPrefix Condition=" '$(Scenario)' != '' ">$(Scenario) </ScenarioPrefix>
    </PropertyGroup>
    <ItemGroup>
      <TestZipFiles Include="$(SourceDirectory)\bin\tests\*\archive\tests\*.zip" />
      <HelixWorkItem Include="@(TestZipFiles->'$(ScenarioPrefix)%(FileName)')" >
        <PayloadArchive>%(Identity)</PayloadArchive>
        <Command Condition=" '$(Scenario)' == '' ">python runtest_helix.py -wrapper %(FileName).dll</Command>
        <Command Condition=" '$(Scenario)' != '' ">python runtest_helix.py -scenario $(Scenario) -wrapper %(FileName).dll</Command>
      </HelixWorkItem>
    </ItemGroup>

  </Target>

</Project>
