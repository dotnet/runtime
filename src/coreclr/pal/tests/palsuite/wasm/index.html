<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PAL Tests WASM</title>
</head>
<body>
    <h1>PAL Tests WASM</h1>
    <pre id="log"></pre>
    <script>
        const disabledTestNamePatterns = [
            "debug_api/", // blocks main thread; seems to depend on spawning child processes.
            "file_io/GetFileAttributesEx", // blocks main thread
            "file_io/GetSystemTime", // blocks main thread
            "file_io/GetTempFileName./test2/paltest_gettempfilename._test2", // infinite loop
            "file_io/WriteFile/test5/paltest_writefile_test5", // infinite loop
            "filemapping_memmgt/MapViewOfFile/test1/paltest_mapviewoffile_test1", // infinite loop and then chrome crashes
            "miscellaneous/GetTickCount", // blocks main thread
            "miscellaneous/queryperformancecounter", // blocks main thread
            "threading/", // we're single-threaded
            // "threading/CriticalSectionFunctions/test8/paltest_criticalsectionfunctions_test8", // blocks main thread
        ];

        const nextRunDelay = 50, reloadDelay = 50;
        nextRunTimeout = -1;
        nextTestName = location.hash.trim().substring(1);
        capturingTestCaseNames = nextTestName.length === 0;
        const capturedTestCaseNames = capturingTestCaseNames
            ? []
            : JSON.parse(localStorage.getItem("testCaseNames"));

        Module = {
            arguments: capturingTestCaseNames
                ? ["PrintPalTests"]
                : [nextTestName],
            quit: function (code) {
                if (capturingTestCaseNames) {
                    capturedTestCaseNames.sort();
                    localStorage.setItem("testCaseNames", JSON.stringify(capturedTestCaseNames));
                    localStorage.setItem("passedCount", JSON.stringify(0));
                    localStorage.setItem("failedCount", JSON.stringify(0));
                    localStorage.setItem("disabledCount", JSON.stringify(0));
                    console.log("Captured " + capturedTestCaseNames.length + " test name(s). Starting test run.");
                    capturingTestCaseNames = false;
                } else if (nextRunTimeout < 0) {
                    if (code == 0) {
                        passedCount = JSON.parse(localStorage.getItem("passedCount")) + 1;
                        localStorage.setItem("passedCount", JSON.stringify(passedCount));
                    } else {
                        failedCount = JSON.parse(localStorage.getItem("failedCount")) + 1;
                        localStorage.setItem("failedCount", JSON.stringify(failedCount));
                    }
                }

                var msg = "'" + Module.arguments[1] + "' exited with code " + code;
                if (nextRunTimeout < 0)
                    msg += "; scheduling next test";

                if (code != 0)
                    console.error(msg);
                else
                    console.log(msg);

                if (nextRunTimeout < 0)
                    nextRunTimeout = window.setTimeout(performNextRun, nextRunDelay);
            },
        };

        function isDisabledTest (testName) {
            if (typeof (testName) !== "string")
                return false;

            for (let pattern of disabledTestNamePatterns) {
                if (testName.match(pattern)) {
                    console.log("Test '" + testName + "' is disabled by regex pattern '" + pattern + "'");
                    return true;
                }
            }

            return false;
        }

        function pickNextTest (testIndex) {
            let result = undefined;
            var lastIndex = testIndex;
            do {
                testIndex++;
                result = capturedTestCaseNames[testIndex];
                console.log("abc Test check '" + result + "'");
            } while (isDisabledTest(result));

            if (testIndex != lastIndex + 1) {
                disabledCount = JSON.parse(localStorage.getItem("disabledCount")) + testIndex - lastIndex - 1;
                localStorage.setItem("disabledCount", JSON.stringify(disabledCount));
            }

            return result;
        }

        function performNextRun () {
            nextRunTimeout = -1;
            const testIndex = capturedTestCaseNames.indexOf(Module.arguments[1]);
            const nextTestName = pickNextTest(testIndex);
            console.log("We just ran " + Module.arguments[1] + " which is test index " + testIndex + "; next test is " + nextTestName);

            if (nextTestName === undefined) {
                location.hash = "";
                console.error("Number of tests passed: " + localStorage.getItem("passedCount") + " failed: " + localStorage.getItem("failedCount") + " disabled: " + localStorage.getItem("disabledCount"));
                console.error("Test run complete");
            } else {
                location.hash = "#" + nextTestName;
                window.setTimeout(location.reload.bind(location), reloadDelay);
            }
        }

        const originalConsoleLog = console.log;
        console.log = function(message) {
            originalConsoleLog(message);
            fetch('/log=paltests-log.txt', {
                method: 'POST',
                body: ('stdout: ' + message),
                headers: {
                    'Content-Type': 'text/plain'
                }
            });
            if (capturingTestCaseNames) {
                capturedTestCaseNames.push(message.trim());
            } else {
                const elt = document.createElement("span");
                elt.textContent = message + "\n";
                document.querySelector("#log").appendChild(elt);
            }
        };
        const originalConsoleError = console.error;
        console.error = function(message) {
            originalConsoleError(message);
            fetch('/log=paltests-log.txt', {
                method: 'POST',
                body: ('stderr: ' + message),
                headers: {
                    'Content-Type': 'text/plain'
                }
            });
            const elt = document.createElement("span");
            elt.textContent = message + "\n";
            elt.style.color = "red";
            document.querySelector("#log").appendChild(elt);
        };
    </script>
    <script src="paltests.js"></script>
</body>
