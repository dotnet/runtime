<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PAL Tests WASM</title>
</head>
<body>
    <h1>PAL Tests WASM</h1>
    <pre id="log">
    </pre>
    <script>
        const nextRunDelay = 100, reloadDelay = 100;
        nextRunTimeout = -1;
        nextTestName = location.hash.trim().substring(1);
        capturingTestCaseNames = nextTestName.length === 0;
        const capturedTestCaseNames = capturingTestCaseNames
            ? []
            : JSON.parse(localStorage.getItem("testCaseNames"));

        Module = {
            arguments: capturingTestCaseNames
                ? ["PrintPalTests"]
                : [nextTestName],
            quit: function (code) {
                if (capturingTestCaseNames) {
                    capturedTestCaseNames.sort();
                    localStorage.setItem("testCaseNames", JSON.stringify(capturedTestCaseNames));
                    console.log("Captured " + capturedTestCaseNames.length + " test name(s). Starting test run.");
                    capturingTestCaseNames = false;
                }

                var msg = "'" + Module.arguments[1] + "' exited with code " + code;
                if (nextRunTimeout < 0)
                    msg += "; scheduling next test";

                if (code != 0)
                    console.error(msg);
                else
                    console.log(msg);

                if (nextRunTimeout < 0)
                    nextRunTimeout = window.setTimeout(performNextRun, nextRunDelay);
            },
        };

        function performNextRun () {
            nextRunTimeout = -1;
            const testIndex = capturedTestCaseNames.indexOf(Module.arguments[1]);
            const nextTestName = capturedTestCaseNames[testIndex + 1];
            console.log("We just ran " + Module.arguments[1] + " which is test index " + testIndex + "; next test is " + nextTestName);

            location.hash = "#" + nextTestName;
            window.setTimeout(location.reload.bind(location), reloadDelay);
        }

        const originalConsoleLog = console.log;
        console.log = function(message) {
            originalConsoleLog(message);
            fetch('/log=paltests-log.txt', {
                method: 'POST',
                body: ('stdout: ' + message),
                headers: {
                    'Content-Type': 'text/plain'
                }
            });
            if (capturingTestCaseNames) {
                capturedTestCaseNames.push(message.trim());
            } else {
                const elt = document.createElement("span");
                elt.textContent = message + "\n";
                document.querySelector("#log").appendChild(elt);
            }
        };
        const originalConsoleError = console.error;
        console.error = function(message) {
            originalConsoleError(message);
            fetch('/log=paltests-log.txt', {
                method: 'POST',
                body: ('stderr: ' + message),
                headers: {
                    'Content-Type': 'text/plain'
                }
            });
            const elt = document.createElement("span");
            elt.textContent = message + "\n";
            elt.style.color = "red";
            document.querySelector("#log").appendChild(elt);
        };
    </script>
    <script src="paltests.js"></script>
</body>
