<Project Sdk="Microsoft.DotNet.Helix.Sdk" DefaultTargets="Test">

  <!--
    cdac-dump-gen-helix.proj — Generates crash dumps on Helix and downloads them
    back to the ADO agent for the x-plat dump test flow.

    This project sends a work item that runs debuggees to produce dumps, tars the
    results, and copies the tar to $HELIX_WORKITEM_UPLOAD_ROOT. The Helix SDK
    automatically downloads the tar back via DownloadFilesFromResults.

    See cdac-dump-xplat-test-helix.proj for the test execution half.

    Properties (set by pipeline):
      HelixTargetQueues  — Helix queue(s) to run on
      TestHostPayload    — Path to testhost shared framework directory
      DumpTestsPayload   — Path to payload directory (debuggees + metadata)
      TargetOS           — Target OS (windows, linux, osx)
      TargetArchitecture — Target architecture (x64, arm64)
  -->

  <PropertyGroup>
    <Language>msbuild</Language>
    <EnableAzurePipelinesReporter>true</EnableAzurePipelinesReporter>
    <Creator>$(_Creator)</Creator>
    <WaitForWorkItemCompletion>true</WaitForWorkItemCompletion>
    <HelixType>test/cdac/dumpgen/</HelixType>
    <HelixBuild>$(BUILD_BUILDNUMBER)</HelixBuild>
    <HelixSource Condition="'$(HelixSource)' == ''">pr/dotnet/runtime/cdac-dump-gen</HelixSource>
    <WorkItemTimeout>01:00:00</WorkItemTimeout>
  </PropertyGroup>

  <!--
    HelixTargetQueues is set by the pipeline YAML (eng/pipelines/runtime-diagnostics.yml)
    so that all Helix queue references stay centralized under eng/.
  -->

  <!-- Send the testhost as a correlation payload -->
  <ItemGroup>
    <HelixCorrelationPayload Include="$(TestHostPayload)">
      <PayloadDirectory>%(Identity)</PayloadDirectory>
    </HelixCorrelationPayload>
  </ItemGroup>

  <!--
    Import debuggee metadata generated by PrepareHelixPayload.
    The props file contains _Debuggee items with DumpDir and MiniDumpType metadata.
  -->
  <Import Project="$(DumpTestsPayload)/debuggee-metadata.props" />

  <!--
    Helix work item command: generate dumps then tar and upload.

    For each debuggee, runs it via the testhost dotnet with DOTNET_DbgEnableMiniDump=1
    to produce a crash dump. After all dumps are generated, tars them and copies the
    tar to $HELIX_WORKITEM_UPLOAD_ROOT for download back to ADO.
  -->

  <!-- Windows: dump generation + tar commands -->
  <PropertyGroup Condition="'$(TargetOS)' == 'windows'">
    <_DumpGenCommands>@(_Debuggee->'mkdir %HELIX_WORKITEM_PAYLOAD%\dumps\local\%(DumpDir)\%(Identity) &amp; set "DOTNET_DbgMiniDumpType=%(MiniDumpType)" &amp; set "DOTNET_DbgMiniDumpName=%HELIX_WORKITEM_PAYLOAD%\dumps\local\%(DumpDir)\%(Identity)\%(Identity).dmp" &amp; %HELIX_CORRELATION_PAYLOAD%\dotnet.exe exec %HELIX_WORKITEM_PAYLOAD%\debuggees\%(Identity)\%(Identity).dll', ' &amp; ')</_DumpGenCommands>
    <_TarCommand>tar -czf %HELIX_WORKITEM_UPLOAD_ROOT%\dumps.tar.gz -C %HELIX_WORKITEM_PAYLOAD%\dumps .</_TarCommand>
    <_FullCommand>$(_DumpGenCommands) &amp; $(_TarCommand)</_FullCommand>
  </PropertyGroup>

  <!-- Unix: dump generation + tar commands -->
  <PropertyGroup Condition="'$(TargetOS)' != 'windows'">
    <_DumpGenCommands>@(_Debuggee->'mkdir -p $HELIX_WORKITEM_PAYLOAD/dumps/local/%(DumpDir)/%(Identity) &amp;&amp; DOTNET_DbgMiniDumpType=%(MiniDumpType) DOTNET_DbgMiniDumpName=$HELIX_WORKITEM_PAYLOAD/dumps/local/%(DumpDir)/%(Identity)/%(Identity).dmp $HELIX_CORRELATION_PAYLOAD/dotnet exec $HELIX_WORKITEM_PAYLOAD/debuggees/%(Identity)/%(Identity).dll || true', ' &amp;&amp; ')</_DumpGenCommands>
    <_TarCommand>tar -czf $HELIX_WORKITEM_UPLOAD_ROOT/dumps.tar.gz -C $HELIX_WORKITEM_PAYLOAD/dumps .</_TarCommand>
    <_FullCommand>$(_DumpGenCommands) &amp;&amp; $(_TarCommand)</_FullCommand>
  </PropertyGroup>

  <!-- Pre-commands: enable dump generation -->
  <ItemGroup Condition="'$(TargetOS)' == 'windows'">
    <!-- Allow heap dump generation with the unsigned locally-built DAC -->
    <HelixPreCommand Include="reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\MiniDumpSettings&quot; /v DisableAuxProviderSignatureCheck /t REG_DWORD /d 1 /f" />
    <HelixPreCommand Include="set DOTNET_DbgEnableMiniDump=1" />
  </ItemGroup>
  <ItemGroup Condition="'$(TargetOS)' != 'windows'">
    <HelixPreCommand Include="export DOTNET_DbgEnableMiniDump=1" />
    <HelixPreCommand Include="chmod +x $HELIX_CORRELATION_PAYLOAD/dotnet" />
  </ItemGroup>

  <PropertyGroup>
    <HelixPreCommands>@(HelixPreCommand)</HelixPreCommands>
  </PropertyGroup>

  <!-- Single work item: generate dumps, tar, and upload for download -->
  <ItemGroup>
    <HelixWorkItem Include="CdacDumpGen">
      <PayloadDirectory>$(DumpTestsPayload)</PayloadDirectory>
      <Command>$(_FullCommand)</Command>
      <Timeout>$(WorkItemTimeout)</Timeout>
      <DownloadFilesFromResults>dumps.tar.gz</DownloadFilesFromResults>
    </HelixWorkItem>
  </ItemGroup>

</Project>
