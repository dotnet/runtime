# cDAC Dump Tests

Integration tests that validate the cDAC (contract-based Data Access Component) reader
against real crash dumps. Each test loads a dump produced by a purpose-built debuggee
app, creates a `ContractDescriptorTarget` via ClrMD, and exercises one or more cDAC
contracts against real runtime data structures.

## Overview

### Architecture

```
Debuggees/          Purpose-built console apps that crash via FailFast
DumpTests.targets   MSBuild logic to build debuggees, run them, and collect dumps
RunDumpTests.ps1    Windows helper script to orchestrate dump generation + test runs
DumpTestBase.cs     Base class: loads a dump, creates a cDAC Target, handles skipping
ClrMdDumpHost.cs    Wraps ClrMD DataTarget for memory reads and symbol lookup
TestConfiguration   Runtime version descriptor, implements IXunitSerializable
*DumpTests.cs       Test classes organized by cDAC contract
```

### Debuggees

Each debuggee is a small console app under `Debuggees/` that exercises specific runtime
features and then calls `Environment.FailFast()` to produce a crash dump.

| Debuggee | Purpose | Dump Type |
|----------|---------|-----------|
| BasicThreads | Thread management, thread store | Heap |
| GCRoots | GC object graphs, pinned handles | Heap |
| ServerGC | Server GC mode heap structures | Heap |
| StackWalk | Deterministic call stack (Main→A→B→C→FailFast) | Full |
| MultiModule | Multi-assembly metadata resolution | Full |
| TypeHierarchy | Type inheritance, method tables | Heap |
| PInvokeStub | P/Invoke with SetLastError ILStub | Full |
| VarargPInvoke | Vararg P/Invoke via __arglist (sprintf) | Full |
| SyncBlock | Sync block locks | Heap |

The dump type is configured per-debuggee via the `DumpTypes` property in each debuggee's
`.csproj` (default: `Heap`, set in `Debuggees/Directory.Build.props`). Debuggees that
need full memory content (e.g., metadata-heavy scenarios) override this to `Full`.

### Test Classes

Each test class targets a specific cDAC contract and specifies which debuggee dump to
use. Tests are `[ConditionalTheory]` methods parameterized by `TestConfiguration`.

| Test Class | Contract | Debuggee |
|------------|----------|----------|
| ThreadDumpTests | Thread | BasicThreads |
| RuntimeInfoDumpTests | RuntimeInfo | BasicThreads |
| WorkstationGCDumpTests | GC (Workstation) | GCRoots |
| ServerGCDumpTests | GC (Server) | ServerGC |
| StackWalkDumpTests | StackWalk | StackWalk |
| RuntimeTypeSystemDumpTests | RuntimeTypeSystem | TypeHierarchy |
| LoaderDumpTests | Loader | MultiModule |
| EcmaMetadataDumpTests | EcmaMetadata | MultiModule |
| PInvokeStubDumpTests | StackWalk + RTS | PInvokeStub |
| VarargPInvokeDumpTests | StackWalk + RTS | VarargPInvoke |
| SyncBlockDumpTests | SyncBlock (+ Object built-in COM data) | SyncBlock |

### Runtime Versions

Tests run against multiple runtime versions via `TestConfiguration`:

- **`local`** — Framework-dependent build run with the repo's testhost (the runtime
  you just built). Used for validating current development work.
- **`net10.0`** — Self-contained publish against the released .NET 10 runtime. Used
  for cross-version compatibility testing.

Each version produces a separate test invocation via `[MemberData(nameof(TestConfigurations))]`.

> **Note:** .NET 10 did not support cDAC in heap dumps. Heap dump tests for net10.0
> are automatically skipped. Only full dump tests (RuntimeTypeSystem, Loader,
> EcmaMetadata) run against net10.0.

### Test Skipping

Tests can be conditionally skipped using attributes:

- **`[SkipOnVersion("net10.0", "reason")]`** — Skip when running against a specific
  runtime version. Evaluated before the dump is loaded.
- **`[SkipOnOS("linux", "reason")]`** — Skip when the dumps were generated on a specific
  OS. Requires `dump-info.json` to be present in the version directory. Valid values:
  `windows`, `linux`, `osx`, `freebsd`.
- **`[SkipOnOS(IncludeOnly = "windows", Reason = "reason")]`** — Run *only* when the
  dumps were generated on the specified OS. Skips on all other platforms. Useful for
  debuggees that depend on platform-specific native libraries (e.g., `msvcrt.dll`).

Multiple skip attributes can be stacked on a single method.

### Dump Metadata

Each version directory contains a `dump-info.json` file describing the platform where
the dumps were generated:

```json
{
  "os": "windows",
  "arch": "x64"
}
```

This is auto-generated by `DumpTests.targets` during dump generation. When running
tests, `DumpTestBase` loads this metadata and evaluates `[SkipOnOS]` attributes.
If `dump-info.json` is not present, OS-based skipping is silently disabled.

### Dump Directory Layout

Dumps are written to:

```
artifacts/dumps/cdac/{version}/{dumptype}/{debuggee}/{debuggee}.dmp
```

For example:

```
artifacts/dumps/cdac/
  local/
    dump-info.json
    heap/
      BasicThreads/BasicThreads.dmp
    full/
      StackWalk/StackWalk.dmp
      PInvokeStub/PInvokeStub.dmp
  net10.0/
    dump-info.json
    full/
      TypeHierarchy/TypeHierarchy.dmp
```

## Running Locally (Windows)

### Prerequisites

1. Build the runtime and test host:

   ```cmd
   build.cmd clr+libs+tools.cdac -rc release
   ```

2. Ensure the repo dotnet (`.dotnet/dotnet.exe`) is available.

### Using RunDumpTests.ps1

The `RunDumpTests.ps1` script is the recommended way to run locally on Windows.
Run it from the `DumpTests/` directory.

```powershell
# Generate dumps and run all tests
.\RunDumpTests.ps1

# Generate dumps only (no tests)
.\RunDumpTests.ps1 -Action dumps

# Run tests only (dumps must already exist)
.\RunDumpTests.ps1 -Action test

# Target a specific runtime version
.\RunDumpTests.ps1 -Versions local

# Force regeneration of existing dumps
.\RunDumpTests.ps1 -Force

# Filter tests by name
.\RunDumpTests.ps1 -Filter "*StackWalk*"
```

> **Admin Note (Windows):** Heap dumps require the DAC (`mscordaccore.dll`), which is
> unsigned in local builds. Pass `-SetSignatureCheck` on first run to set the
> `DisableAuxProviderSignatureCheck` registry key under
> `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\MiniDumpSettings`.
> This requires running as Administrator.

### Using MSBuild Directly

You can also invoke dump generation directly via MSBuild:

```cmd
.dotnet\dotnet msbuild src\native\managed\cdac\tests\DumpTests\Microsoft.Diagnostics.DataContractReader.DumpTests.csproj /t:GenerateAllDumps /v:minimal
```

And run the tests:

```cmd
.dotnet\dotnet test src\native\managed\cdac\tests\DumpTests\Microsoft.Diagnostics.DataContractReader.DumpTests.csproj
```

### Using a CI Dump Archive

If you have a `.tar.gz` archive of dumps from CI, you can run tests against them
without generating dumps locally:

```powershell
.\RunDumpTests.ps1 -DumpArchive C:\Downloads\CdacDumps_linux_x64.tar.gz
```

This extracts the archive, auto-detects which runtime versions are present, and
runs the tests with `CDAC_DUMP_ROOT` pointing to the extracted dumps.

## Code Coverage

To collect code coverage for the cDAC reader, pass `-Coverage` to `RunDumpTests.ps1`:

```powershell
.\RunDumpTests.ps1 -Coverage
```

This uses [coverlet](https://github.com/coverlet-coverage/coverlet) to instrument the
test run and [ReportGenerator](https://github.com/danielpalme/ReportGenerator) to
produce an HTML report.

### Prerequisites

Restore the required dotnet tools (one-time setup from the DumpTests directory):

```powershell
dotnet tool restore
```

This installs `coverlet` and `reportgenerator` as local tools.

### Output

- **Raw coverage data:** `artifacts/TestResults/cdac-dump-tests/`
- **HTML report:** `artifacts/coverage/cdac-dump-tests/index.html`
- **Text summary:** printed to the console after the test run

Coverage is collected for the `Microsoft.Diagnostics.DataContractReader.*` assemblies
exercised during the test run. The report shows which cDAC contract implementations
are covered by the dump tests.

## CI Pipeline

The CI pipeline is defined in `eng/pipelines/runtime-diagnostics.yml` and runs on
a schedule (nightly) and on PRs that touch `src/native/managed/cdac/**` or
`eng/pipelines/**`.

### Current CI Behavior

CI currently generates **local dumps only** (`CIDumpVersionsOnly=true`). The net10.0
self-contained publish requires a separate .NET 10 SDK which is not available on CI
agents.

The pipeline has three stages:

1. **Build** — Builds the runtime (`clr+libs+tools.cdac+host+packs`) and runs the
   standard diagnostics test suite (with and without cDAC).

2. **DumpCreation** — Builds the runtime, invokes `GenerateAllDumps` to create crash
   dumps for each debuggee, and publishes the dumps as pipeline artifacts. Runs on
   each platform in `cdacDumpPlatforms` (currently `windows_x64` and `linux_x64`).

3. **DumpTest** — Downloads dump artifacts from all platforms and runs the test suite
   against each set of dumps. This enables cross-platform validation (e.g., running
   Linux dump analysis on a Windows host). Tests for net10.0 are skipped via
   `SkipDumpVersions=net10.0`.

## Adding a New Debuggee

1. Create a new directory under `Debuggees/` with a `.csproj` and `Program.cs`.
2. The app should exercise the runtime feature you want to test, then call
   `Environment.FailFast("message")` to trigger a crash dump.
3. The `.csproj` inherits defaults from `Debuggees/Directory.Build.props`
   (output path, target frameworks, `DumpTypes=Heap`).
4. Override `<DumpTypes>Full</DumpTypes>` if your test needs full memory dumps.
5. The debuggee is auto-discovered by `DumpTests.targets` — no list to update.

## Adding a New Test

1. Create a new test class inheriting from `DumpTestBase`.
2. Override `DebuggeeName` to match the debuggee directory name.
3. Override `DumpType` if the debuggee uses full dumps (`"full"`).
4. Write tests as `[ConditionalTheory]` with `[MemberData(nameof(TestConfigurations))]`.
5. Call `InitializeDumpTest(config)` as the first line of every test method.
6. Use `[SkipOnVersion("net10.0", "reason")]` for version-specific skipping.
7. Use `[SkipOnOS(IncludeOnly = "windows", Reason = "reason")]` for platform-specific tests.
