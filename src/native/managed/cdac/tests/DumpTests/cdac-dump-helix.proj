<Project Sdk="Microsoft.DotNet.Helix.Sdk" DefaultTargets="Test">

  <!--
    cdac-dump-helix.proj — Sends cDAC dump generation + testing to Helix.

    This project defines a Helix work item that:
      1. Runs pre-built debuggee apps to produce crash dumps on Helix hardware
      2. Runs the cDAC dump tests against those dumps using xunit.console.dll

    The testhost (locally-built runtime) is sent as a HelixCorrelationPayload.
    It provides the `dotnet` host used for running debuggees and executing tests.

    Properties (set by pipeline or command line):
      HelixTargetQueues  — Helix queue(s) to run on (set by eng/pipelines/runtime-diagnostics.yml)
      TestHostPayload    — Path to testhost shared framework directory (contains dotnet host)
      DumpTestsPayload   — Path to Helix payload directory (contains tests/, debuggees/, and
                           debuggee-metadata.props generated by PrepareHelixPayload)
      TargetOS           — Target OS (windows, linux, osx)
      TargetArchitecture — Target architecture (x64, arm64)
  -->

  <PropertyGroup>
    <Language>msbuild</Language>
    <EnableAzurePipelinesReporter>true</EnableAzurePipelinesReporter>
    <EnableXUnitReporter>true</EnableXUnitReporter>
    <Creator>$(_Creator)</Creator>
    <WaitForWorkItemCompletion>true</WaitForWorkItemCompletion>
    <FailOnTestFailure>true</FailOnTestFailure>
    <HelixType>test/cdac/dumptests/</HelixType>
    <HelixBuild>$(BUILD_BUILDNUMBER)</HelixBuild>
    <HelixSource Condition="'$(HelixSource)' == ''">pr/dotnet/runtime/cdac-dump-tests</HelixSource>
    <WorkItemTimeout>01:00:00</WorkItemTimeout>
  </PropertyGroup>

  <!--
    HelixTargetQueues is set by the pipeline YAML (eng/pipelines/runtime-diagnostics.yml)
    so that all Helix queue references stay centralized under eng/.
  -->

  <!-- Send the testhost as a correlation payload (shared across work items, extracted once per machine) -->
  <ItemGroup>
    <HelixCorrelationPayload Include="$(TestHostPayload)">
      <PayloadDirectory>%(Identity)</PayloadDirectory>
    </HelixCorrelationPayload>
  </ItemGroup>

  <!--
    Import debuggee metadata generated by PrepareHelixPayload.
    The props file contains _Debuggee items with DumpDir and MiniDumpType metadata,
    derived from each debuggee's DumpTypes property (Heap->heap/2, Full->full/4).
  -->
  <Import Project="$(DumpTestsPayload)/debuggee-metadata.props" />

  <!--
    Helix work item command: generate dumps then run tests.

    For each debuggee, runs it via the testhost dotnet with DOTNET_DbgEnableMiniDump=1
    to produce a crash dump, then runs xunit.console.dll against the dumps.

    Windows uses & (runs next regardless of exit code — debuggees crash intentionally).
    Unix uses || true to reset failure from crashed debuggees so && chain continues.
  -->

  <!-- Windows: dump generation + test commands -->
  <PropertyGroup Condition="'$(TargetOS)' == 'windows'">
    <_DumpGenCommands>@(_Debuggee->'mkdir %HELIX_WORKITEM_PAYLOAD%\dumps\local\%(DumpDir)\%(Identity) &amp; set "DOTNET_DbgMiniDumpType=%(MiniDumpType)" &amp; set "DOTNET_DbgMiniDumpName=%HELIX_WORKITEM_PAYLOAD%\dumps\local\%(DumpDir)\%(Identity)\%(Identity).dmp" &amp; %HELIX_CORRELATION_PAYLOAD%\dotnet.exe exec %HELIX_WORKITEM_PAYLOAD%\debuggees\%(Identity)\%(Identity).dll', ' &amp; ')</_DumpGenCommands>
    <_TestCommand>%HELIX_CORRELATION_PAYLOAD%\dotnet.exe exec --runtimeconfig %HELIX_WORKITEM_PAYLOAD%\tests\Microsoft.Diagnostics.DataContractReader.DumpTests.runtimeconfig.json --depsfile %HELIX_WORKITEM_PAYLOAD%\tests\Microsoft.Diagnostics.DataContractReader.DumpTests.deps.json %HELIX_WORKITEM_PAYLOAD%\tests\xunit.console.dll %HELIX_WORKITEM_PAYLOAD%\tests\Microsoft.Diagnostics.DataContractReader.DumpTests.dll -xml testResults.xml -nologo</_TestCommand>
    <_FullCommand>$(_DumpGenCommands) &amp; $(_TestCommand)</_FullCommand>
  </PropertyGroup>

  <!-- Unix: dump generation + test commands -->
  <PropertyGroup Condition="'$(TargetOS)' != 'windows'">
    <_DumpGenCommands>@(_Debuggee->'mkdir -p $HELIX_WORKITEM_PAYLOAD/dumps/local/%(DumpDir)/%(Identity) &amp;&amp; DOTNET_DbgMiniDumpType=%(MiniDumpType) DOTNET_DbgMiniDumpName=$HELIX_WORKITEM_PAYLOAD/dumps/local/%(DumpDir)/%(Identity)/%(Identity).dmp $HELIX_CORRELATION_PAYLOAD/dotnet exec $HELIX_WORKITEM_PAYLOAD/debuggees/%(Identity)/%(Identity).dll || true', ' &amp;&amp; ')</_DumpGenCommands>
    <_TestCommand>$HELIX_CORRELATION_PAYLOAD/dotnet exec --runtimeconfig $HELIX_WORKITEM_PAYLOAD/tests/Microsoft.Diagnostics.DataContractReader.DumpTests.runtimeconfig.json --depsfile $HELIX_WORKITEM_PAYLOAD/tests/Microsoft.Diagnostics.DataContractReader.DumpTests.deps.json $HELIX_WORKITEM_PAYLOAD/tests/xunit.console.dll $HELIX_WORKITEM_PAYLOAD/tests/Microsoft.Diagnostics.DataContractReader.DumpTests.dll -xml testResults.xml -nologo</_TestCommand>
    <_FullCommand>$(_DumpGenCommands) &amp;&amp; $(_TestCommand)</_FullCommand>
  </PropertyGroup>

  <!-- Pre-commands: enable dump generation and set dump root for tests -->
  <ItemGroup Condition="'$(TargetOS)' == 'windows'">
    <!-- Allow heap dump generation with the unsigned locally-built DAC -->
    <HelixPreCommand Include="reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\MiniDumpSettings&quot; /v DisableAuxProviderSignatureCheck /t REG_DWORD /d 1 /f" />
    <HelixPreCommand Include="set DOTNET_DbgEnableMiniDump=1" />
    <HelixPreCommand Include="set CDAC_DUMP_ROOT=%HELIX_WORKITEM_PAYLOAD%\dumps" />
  </ItemGroup>
  <ItemGroup Condition="'$(TargetOS)' != 'windows'">
    <HelixPreCommand Include="export DOTNET_DbgEnableMiniDump=1" />
    <HelixPreCommand Include="export CDAC_DUMP_ROOT=$HELIX_WORKITEM_PAYLOAD/dumps" />
    <HelixPreCommand Include="chmod +x $HELIX_CORRELATION_PAYLOAD/dotnet" />
  </ItemGroup>

  <PropertyGroup>
    <HelixPreCommands>@(HelixPreCommand)</HelixPreCommands>
  </PropertyGroup>

  <!-- Single work item: generate dumps then run tests -->
  <ItemGroup>
    <HelixWorkItem Include="CdacDumpTests">
      <PayloadDirectory>$(DumpTestsPayload)</PayloadDirectory>
      <Command>$(_FullCommand)</Command>
      <Timeout>$(WorkItemTimeout)</Timeout>
    </HelixWorkItem>
  </ItemGroup>

</Project>
