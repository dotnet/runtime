<Project>
  <!--
    DumpTests.targets — Builds debuggee apps, runs them to produce crash dumps,
    and makes dump paths available to the test project.

    Dump output: $(DumpOutputDir)\{RuntimeVersion}\{DebugeeName}\{DebugeeName}.dmp

    Each Debuggee × RuntimeVersion combination produces one dump.

    Properties:
      DumpOutputDir          — Where dumps are written (default: artifacts\dumps\cdac\)
      TestHostDir            — Path to the local-build testhost runtime (auto-detected)
      DebuggeeConfiguration  — Build configuration for debuggees (default: Release)

    RuntimeVersion values:
      "local"  — framework-dependent build, run with the repo's testhost
      "net10.0" — self-contained publish against .NET 10, run directly
  -->

  <PropertyGroup>
    <DumpOutputDir Condition="'$(DumpOutputDir)' == ''">$(RepoRoot)artifacts\dumps\cdac\</DumpOutputDir>
    <DebuggeeConfiguration Condition="'$(DebuggeeConfiguration)' == ''">Release</DebuggeeConfiguration>
    <DebuggeesDir>$(MSBuildThisFileDirectory)Debuggees\</DebuggeesDir>
  </PropertyGroup>

  <!-- Auto-detect testhost from repo artifacts (used for "local" runtime version). -->
  <PropertyGroup Condition="'$(TestHostDir)' == ''">
    <_TestHostConfig Condition="'$(TestHostConfiguration)' == ''">Release</_TestHostConfig>
    <_TestHostConfig Condition="'$(TestHostConfiguration)' != ''">$(TestHostConfiguration)</_TestHostConfig>
    <_HostArch>$(TargetArchitecture)</_HostArch>
    <_HostArch Condition="'$(_HostArch)' == ''">x64</_HostArch>
    <TestHostDir>$(RepoRoot)artifacts\bin\testhost\$(NetCoreAppCurrent)-windows-$(_TestHostConfig)-$(_HostArch)\</TestHostDir>
  </PropertyGroup>

  <!-- Debuggees to build and crash -->
  <ItemGroup>
    <Debuggee Include="BasicThreads" />
    <Debuggee Include="TypeHierarchy" />
    <Debuggee Include="ExceptionState" />
    <Debuggee Include="MultiModule" />
    <Debuggee Include="GCRoots" />
  </ItemGroup>

  <!-- Runtime versions to create dumps for.
       "local" uses the repo's testhost; others publish self-contained. -->
  <ItemGroup>
    <DumpRuntimeVersion Include="local" />
    <DumpRuntimeVersion Include="net10.0" />
  </ItemGroup>

  <Target Name="GenerateAllDumps" BeforeTargets="Build">
    <MSBuild Projects="$(MSBuildProjectFile)"
             Targets="_GenerateDumpsForDebuggee"
             Properties="DebuggeeName=%(Debuggee.Identity)" />
  </Target>

  <Target Name="_GenerateDumpsForDebuggee">
    <MSBuild Projects="$(MSBuildProjectFile)"
             Targets="_GenerateSingleDump"
             Properties="DebuggeeName=$(DebuggeeName);DumpRuntimeVersion=%(DumpRuntimeVersion.Identity)" />
  </Target>

  <Target Name="_GenerateSingleDump">
    <PropertyGroup>
      <_DebuggeeDir>$(DebuggeesDir)$(DebuggeeName)\</_DebuggeeDir>
      <_DumpDir>$(DumpOutputDir)$(DumpRuntimeVersion)\$(DebuggeeName)\</_DumpDir>
      <_DumpFile>$(_DumpDir)$(DebuggeeName).dmp</_DumpFile>
    </PropertyGroup>

    <!-- Skip if dump already exists -->
    <Message Text="Dump already exists: $(_DumpFile). Skipping." Condition="Exists('$(_DumpFile)')" Importance="high" />

    <!-- Determine build/run strategy based on runtime version -->
    <MSBuild Projects="$(MSBuildProjectFile)"
             Targets="_GenerateLocalDump"
             Properties="DebuggeeName=$(DebuggeeName);_DebuggeeDir=$(_DebuggeeDir);_DumpDir=$(_DumpDir);_DumpFile=$(_DumpFile)"
             Condition="!Exists('$(_DumpFile)') AND '$(DumpRuntimeVersion)' == 'local'" />

    <MSBuild Projects="$(MSBuildProjectFile)"
             Targets="_GeneratePublishedDump"
             Properties="DebuggeeName=$(DebuggeeName);DumpRuntimeVersion=$(DumpRuntimeVersion);_DebuggeeDir=$(_DebuggeeDir);_DumpDir=$(_DumpDir);_DumpFile=$(_DumpFile)"
             Condition="!Exists('$(_DumpFile)') AND '$(DumpRuntimeVersion)' != 'local'" />

    <Message Text="Dump created: $(_DumpFile)" Importance="high" Condition="Exists('$(_DumpFile)')" />
  </Target>

  <!-- Local build: framework-dependent, run with testhost -->
  <Target Name="_GenerateLocalDump">
    <PropertyGroup>
      <_DebuggeeBinDir>$(RepoRoot)artifacts\bin\DumpTests\$(DebuggeeName)\$(DebuggeeConfiguration)\$(NetCoreAppCurrent)\</_DebuggeeBinDir>
    </PropertyGroup>

    <Exec Command="&quot;$(RepoRoot).dotnet\dotnet.exe&quot; build &quot;$(_DebuggeeDir)$(DebuggeeName).csproj&quot; -c $(DebuggeeConfiguration) -f $(NetCoreAppCurrent)"
          WorkingDirectory="$(_DebuggeeDir)" />

    <MakeDir Directories="$(_DumpDir)" />

    <Exec Command="&quot;$(TestHostDir)dotnet.exe&quot; exec &quot;$(_DebuggeeBinDir)$(DebuggeeName).dll&quot;"
          WorkingDirectory="$(_DumpDir)"
          IgnoreExitCode="true"
          EnvironmentVariables="DOTNET_DbgEnableMiniDump=1;DOTNET_DbgMiniDumpType=4;DOTNET_DbgMiniDumpName=$(_DumpFile)" />

    <Error Text="Dump file was not created: $(_DumpFile)" Condition="!Exists('$(_DumpFile)')" />
  </Target>

  <!-- Released runtime: self-contained publish, run the exe directly -->
  <Target Name="_GeneratePublishedDump">
    <PropertyGroup>
      <_PublishDir>$(RepoRoot)artifacts\bin\DumpTests\$(DebuggeeName)\$(DebuggeeConfiguration)\$(DumpRuntimeVersion)-publish\</_PublishDir>
    </PropertyGroup>

    <Exec Command="&quot;$(RepoRoot).dotnet\dotnet.exe&quot; publish &quot;$(_DebuggeeDir)$(DebuggeeName).csproj&quot; -c $(DebuggeeConfiguration) -f $(DumpRuntimeVersion) -r win-x64 --self-contained -o &quot;$(_PublishDir)&quot;"
          WorkingDirectory="$(_DebuggeeDir)" />

    <MakeDir Directories="$(_DumpDir)" />

    <Exec Command="&quot;$(_PublishDir)$(DebuggeeName).exe&quot;"
          WorkingDirectory="$(_DumpDir)"
          IgnoreExitCode="true"
          EnvironmentVariables="DOTNET_DbgEnableMiniDump=1;DOTNET_DbgMiniDumpType=4;DOTNET_DbgMiniDumpName=$(_DumpFile)" />

    <Error Text="Dump file was not created: $(_DumpFile)" Condition="!Exists('$(_DumpFile)')" />
  </Target>

  <!-- Expose dump paths as properties for tests -->
  <PropertyGroup>
    <BasicThreadsLocalDumpPath>$(DumpOutputDir)local\BasicThreads\BasicThreads.dmp</BasicThreadsLocalDumpPath>
    <BasicThreadsNet10DumpPath>$(DumpOutputDir)net10.0\BasicThreads\BasicThreads.dmp</BasicThreadsNet10DumpPath>
  </PropertyGroup>
</Project>
