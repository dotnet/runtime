<Project>
    <!-- Write a ProjectName.cmake fragment into the publish artifact folder with that helps with consuming the NativeAOT produced library -->

    <Target Name="WriteNativeLibraryCMakeFragment" DependsOnTargets="SetupProperties;WriteNativeLibraryCMakeFragmentStatic;WriteNativeLibraryCMakeFragmentShared" AfterTargets="Publish" Condition="'$(PublishAot)' == 'true'"
            Outputs="$(NativeLibraryCMakeFragmentPath)">
        <WriteLinesToFile File="$(NativeLibraryCMakeFragmentPath)"
                          Lines="@(NativeLibraryCMakeFragmentLines)"
                          WriteOnlyWhenDifferent="true"
                          Overwrite="true"/>
     </Target>

    <Target Name="PrepareToWriteNativeLibraryCMakeFragment" Condition="'$(PublishAot)' == 'true'">
        <PropertyGroup>
            <NativeLibraryCMakeVarPrefix>$(TargetName.ToUpper())</NativeLibraryCMakeVarPrefix>
            <NativeLibraryCMakeFragmentPath Condition="'$(NativeLibraryCMakeFragmentPath)' == ''">$(PublishDir)/$(MSBuildProjectName).cmake</NativeLibraryCMakeFragmentPath>
            <NativeLibraryArtifactName>$(TargetName)</NativeLibraryArtifactName>
            <NativeLibraryArtifactExt>$(NativeBinaryExt)</NativeLibraryArtifactExt>
            <NativeLibraryArtifactLibPath>$(PublishDir)/</NativeLibraryArtifactLibPath>
        </PropertyGroup>
    </Target>

    <!-- TODO: use GenerateFileFromTemplate -->
    <!-- GenerateFileFromTemplate
         TemplateFile="Microsoft.NETCore.App.MonoCrossAOT.Sdk.props.in"
         Properties="@(_SdkPropsProperties->'%(Identity)=%(Value)')"
         OutputPath="$(IntermediateOutputPath)$(TargetCrossRid).Sdk.props" / -->


    <Target Name="WriteNativeLibraryCMakeFragmentStatic" DependsOnTargets="SetupProperties;PrepareToWriteNativeLibraryCMakeFragment" AfterTargets="Publish" Condition="'$(PublishAot)' == 'true' and '$(NativeLib)' == 'static'">
        <PropertyGroup>
            <NativeLibraryArtifactIlcFrameworkPath>$(IlcFrameworkPath.TrimEnd('\\/'))</NativeLibraryArtifactIlcFrameworkPath>
            <NativeLibraryArtifactIlcSdkPath>$(IlcSdkPath.TrimEnd('\\/'))</NativeLibraryArtifactIlcSdkPath>
        </PropertyGroup>
        <!-- escape backslashes in windows-style paths to make cmake happy -->
        <PropertyGroup Condition="'$(TargetOS)' == 'windows'">
            <NativeLibraryArtifactLibPath>$(NativeLibraryArtifactLibPath.Replace('\', '\\'))</NativeLibraryArtifactLibPath>
            <NativeLibraryArtifactIlcFrameworkPath>$(NativeLibraryArtifactIlcFrameworkPath.Replace('\', '\\'))</NativeLibraryArtifactIlcFrameworkPath>
            <NativeLibraryArtifactIlcSdkPath>$(NativeLibraryArtifactIlcSdkPath.Replace('\', '\\'))</NativeLibraryArtifactIlcSdkPath>
        </PropertyGroup>
        <ItemGroup>
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_MODE &quot;static&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_NAME &quot;$(NativeLibraryArtifactName)&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_EXT &quot;$(NativeLibraryArtifactExt)&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_LIBPATH &quot;$(NativeLibraryArtifactLibPath.TrimEnd('\\/'))&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set(NATIVEAOT_FRAMEWORK_PATH &quot;$(NativeLibraryArtifactIlcFrameworkPath)&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set(NATIVEAOT_SDK_PATH &quot;$(NativeLibraryArtifactIlcSdkPath)&quot;)" />
        </ItemGroup>
    </Target>

    <Target Name="WriteNativeLibraryCMakeFragmentShared" DependsOnTargets="SetupProperties;PrepareToWriteNativeLibraryCMakeFragment" AfterTargets="Publish" Condition="'$(PublishAot)' == 'true' and '$(NativeLib)' == 'shared'">
        <PropertyGroup Condition="'$(TargetOS)' != 'windows'">
            <!-- the import lib is in the native sub-directory, not publish-->
            <NativeLibraryArtifactImpLibFullPath>$([System.IO.Path]::GetFullPath('$(NativeOutputPath)$(TargetName)$(LibSuffix)'))</NativeLibraryArtifactImpLibFullPath>
        </PropertyGroup>
        <!-- escape backslashes in windows-style paths to make cmake happy -->
        <PropertyGroup Condition="'$(TargetOS)' == 'windows'">
            <NativeLibraryArtifactLibPath>$(NativeLibraryArtifactLibPath.Replace('\', '\\'))</NativeLibraryArtifactLibPath>
            <NativeLibraryArtifactImpLibFullPath>$(NativeLibraryArtifactImpLibFullPath.Replace('\', '\\'))</NativeLibraryArtifactImpLibFullPath>
        </PropertyGroup>
        <ItemGroup>
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_MODE &quot;shared&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_NAME &quot;$(NativeLibraryArtifactName)&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_EXT &quot;$(NativeLibraryArtifactExt)&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_LIBPATH &quot;$(NativeLibraryArtifactLibPath.TrimEnd('\\/'))&quot;)" />
            <NativeLibraryCMakeFragmentLines Include="set($(NativeLibraryCMakeVarPrefix)_IMPLIBPATH &quot;$(NativeLibraryArtifactImpLibFullPath.TrimEnd('\\/'))&quot;)" Condition="'$(TargetOS)' != 'windows'"/>
        </ItemGroup>
    </Target>

</Project>
