<Project Sdk="Microsoft.NET.Sdk" DefaultTargets="BuildApp">
  <PropertyGroup>
    <TargetFramework>$(NetCoreAppCurrent)</TargetFramework>
    <MicrosoftNetCoreAppRuntimePackDir>$(CORE_ROOT)/runtimepack</MicrosoftNetCoreAppRuntimePackDir>
    <EnableTargetingPackDownload>false</EnableTargetingPackDownload>
    <InvariantGlobalization>true</InvariantGlobalization> <!-- workaround for https://github.com/dotnet/runtime/issues/41866 -->
    <NoWarn>$(NoWarn),CA1050</NoWarn>
  </PropertyGroup>

  <UsingTask TaskName="AndroidAppBuilderTask"
             AssemblyFile="$(CORE_ROOT)/AndroidAppBuilder/publish/AndroidAppBuilder.dll" />

  <!-- Build APK during 'dotnet publish' -->
  <Target Name="BuildApp">
    <PropertyGroup>
      <AndroidAbi Condition="'$(Platform)'=='arm64'">arm64-v8a</AndroidAbi>
      <AndroidAbi Condition="'$(Platform)'=='arm'">armeabi-v7a</AndroidAbi>
      <AndroidAbi Condition="'$(Platform)'=='x64'">x86_64</AndroidAbi>
      <AndroidAbi Condition="'$(AndroidAbi)'==''">$(Platform)</AndroidAbi>
      <OutputDir>$(TestBinDir)\AndroidApp</OutputDir>
      <ApkDir>$(OutputDir)\apk</ApkDir>
      <StripDebugSymbols>False</StripDebugSymbols>
      <StripDebugSymbols Condition="'$(Configuration)' == 'Release'">True</StripDebugSymbols>
    </PropertyGroup>

    <MakeDir Directories="$(OutputDir)"/>

    <ItemGroup>
      <AssemblySearchPaths Include="$(TestBinDir)"/>
      <AssemblySearchPaths Include="$(MicrosoftNetCoreAppRuntimePackDir)/native"/>
      <AssemblySearchPaths Include="$(MicrosoftNetCoreAppRuntimePackDir)/lib/$(NetCoreAppCurrent)"/>
    </ItemGroup>

    <RemoveDir Directories="$(ApkDir)" />

    <AndroidAppBuilderTask
        Abi="$(AndroidAbi)"
        MonoRuntimeHeaders="$(MicrosoftNetCoreAppRuntimePackDir)/native/include/mono-2.0"
        MainLibraryFileName="$(TestAssembly)"
        AssemblySearchPaths="@(AssemblySearchPaths)"
        StripDebugSymbols="$(StripDebugSymbols)"
        SourceDir="$(OutputDir)"
        OutputDir="$(ApkDir)">
        <Output TaskParameter="ApkBundlePath" PropertyName="ApkBundlePath" />
        <Output TaskParameter="ApkPackageId" PropertyName="ApkPackageId" />
    </AndroidAppBuilderTask>
    <Message Importance="High" Text="Apk:       $(ApkBundlePath)"/>
    <Message Importance="High" Text="PackageId: $(ApkPackageId)"/>
  </Target>
</Project>
