<Project Sdk="Microsoft.Build.NoTargets/1.0.53" DefaultTargets="BuildApp">
  <PropertyGroup>
    <TargetFramework>$(NetCoreAppCurrent)</TargetFramework>
    <MicrosoftNetCoreAppRuntimePackDir>$(ArtifactsBinDir)microsoft.netcore.app.runtime.android-$(TargetArchitecture)\$(Configuration)\runtimes\android-$(TargetArchitecture)</MicrosoftNetCoreAppRuntimePackDir>
    <AndroidAppBuilderDir>$(CORE_ROOT)/AndroidAppBuilder</AndroidAppBuilderDir>
    <EnableTargetingPackDownload>false</EnableTargetingPackDownload>
    <InvariantGlobalization>true</InvariantGlobalization> <!-- workaround for https://github.com/dotnet/runtime/issues/41866 -->
    <NoWarn>$(NoWarn),CA1050</NoWarn>
  </PropertyGroup>

  <UsingTask TaskName="AndroidAppBuilderTask"
             AssemblyFile="$(AndroidAppBuilderDir)\AndroidAppBuilder.dll" />

  <!-- Build APK during 'dotnet publish' -->
  <Target Name="BuildAppBundle" AfterTargets="Build">
    <PropertyGroup>
      <AndroidAbi Condition="'$(Platform)'=='arm64'">arm64-v8a</AndroidAbi>
      <AndroidAbi Condition="'$(Platform)'=='arm'">armeabi-v7a</AndroidAbi>
      <AndroidAbi Condition="'$(Platform)'=='x64'">x86_64</AndroidAbi>
      <AndroidAbi Condition="'$(AndroidAbi)'==''">$(Platform)</AndroidAbi>
      <ApkDir>$(TestBinDir)\apk</ApkDir>
      <StripDebugSymbols>False</StripDebugSymbols>
      <StripDebugSymbols Condition="'$(Configuration)' == 'Release'">True</StripDebugSymbols>
      <AdbTool>$(ANDROID_SDK_ROOT)\platform-tools\adb</AdbTool>
    </PropertyGroup>

    <ItemGroup>
      <AssemblySearchPaths Include="bin"/>
      <AssemblySearchPaths Include="$(MicrosoftNetCoreAppRuntimePackDir)native"/>
      <AssemblySearchPaths Include="$(MicrosoftNetCoreAppRuntimePackDir)lib\$(NetCoreAppCurrent)"/>
    </ItemGroup>

    <RemoveDir Directories="$(ApkDir)" />

    <!-- These native libs are not needed for HelloWorld
         and can be deleted to save 0.4 Mb for APK size 
    <Delete Files="$(PublishDir)\libSystem.IO.Compression.Native.so" />
    <Delete Files="$(PublishDir)\libSystem.Security.Cryptography.Native.OpenSsl.so" /> -->

    <!--ProjectName="$([System.IO.Path]::GetFileNameWithoutExtension('$(TestAssembly)'))" -->
    <AndroidAppBuilderTask
        Abi="$(AndroidAbi)"
        MonoRuntimeHeaders="$(CORE_ROOT)/monoRuntimeHeaders"
        MainLibraryFileName="$(TestAssembly)"
        MainLibraryDir="$(TestBinDir)"
        StripDebugSymbols="$(StripDebugSymbols)"
        SourceDir="$(CORE_ROOT)/runtimepack/native"
        OutputDir="$(ApkDir)">
        <Output TaskParameter="ApkBundlePath" PropertyName="ApkBundlePath" />
        <Output TaskParameter="ApkPackageId" PropertyName="ApkPackageId" />
    </AndroidAppBuilderTask>
    <Message Importance="High" Text="Apk:       $(ApkBundlePath)"/>
    <Message Importance="High" Text="PackageId: $(ApkPackageId)"/>
  </Target>
</Project>
