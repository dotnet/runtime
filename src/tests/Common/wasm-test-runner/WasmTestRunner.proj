<!-- This project requires an explicit SDK version number because it is used on Helix,
      and global.json is not available. -->
<Project Sdk="Microsoft.Build.NoTargets/1.0.53" DefaultTargets="WasmBuildApp">
  <PropertyGroup>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <MicrosoftNetCoreAppRuntimePackDir>$(CORE_ROOT)\runtimepack-non-existant</MicrosoftNetCoreAppRuntimePackDir>
    <MicrosoftNetCoreAppRuntimePackRidDir>$(CORE_ROOT)\build\runtimepack</MicrosoftNetCoreAppRuntimePackRidDir>
    <TargetFramework>$(NetCoreAppCurrent)</TargetFramework>
    <BuildDir>$(MSBuildThisFileDirectory)\obj\$(Configuration)\wasm</BuildDir>
    <AppDir>$(TestBinDir)/WasmApp/</AppDir>
    <PackageRID>browser-wasm</PackageRID>
    <NETCoreAppMaximumVersion>99.0</NETCoreAppMaximumVersion>
    <IsWasmProject>true</IsWasmProject>
    <WasmGenerateAppBundle>true</WasmGenerateAppBundle>
    <WasmAppBuilderTasksAssemblyPath>$(CORE_ROOT)\WasmAppBuilder\WasmAppBuilder.dll</WasmAppBuilderTasksAssemblyPath>
    <MonoAOTCompilerTasksAssemblyPath>$(CORE_ROOT)\MonoAOTCompiler\MonoAOTCompiler.dll</MonoAOTCompilerTasksAssemblyPath>
    <MonoTargetsTasksAssemblyPath>$(CORE_ROOT)\MonoTargetsTasks\MonoTargetsTasks.dll</MonoTargetsTasksAssemblyPath>

    <JsonToItemsTaskFactoryTasksAssemblyPath>$(CORE_ROOT)\JsonToItemsTaskFactory\JsonToItemsTaskFactory.dll</JsonToItemsTaskFactoryTasksAssemblyPath>
    <RuntimeConfigParserTasksAssemblyPath>$(CORE_ROOT)\RuntimeConfigParser\RuntimeConfigParser.dll</RuntimeConfigParserTasksAssemblyPath>
    <EMSDK_PATH>$(CORE_ROOT)\build\emsdk</EMSDK_PATH>
    <MonoAOTCompilerDir>$(CORE_ROOT)\monoaotcompiler</MonoAOTCompilerDir>
    <PublishTrimmed>true</PublishTrimmed>
    <WasmBuildSupportDir>$(CORE_ROOT)/build/</WasmBuildSupportDir>
    <RuntimeIdentifier>browser-wasm</RuntimeIdentifier>
  </PropertyGroup>

  <Import Project="$(CORE_ROOT)/build/WasmApp.LocalBuild.props" />
  <Import Project="$(CORE_ROOT)/build/WasmApp.LocalBuild.targets" />

  <PropertyGroup>
    <WasmBuildAppDependsOn>BuildApp;$(WasmBuildAppDependsOn)</WasmBuildAppDependsOn>
  </PropertyGroup>

  <Target Name="BuildApp" DependsOnTargets="Publish">
    <PropertyGroup>
      <WasmMainAssemblyFileName>$(TestAssemblyFileName)</WasmMainAssemblyFileName>
      <WasmAppDir>$(AppDir)</WasmAppDir>
      <WasmMainJSPath>$(CORE_ROOT)\runtime-test\runtime-test.js</WasmMainJSPath>
      <WasmResolveAssembliesBeforeBuild>false</WasmResolveAssembliesBeforeBuild>
      <WasmGenerateRunV8Script>true</WasmGenerateRunV8Script>
      <WasmSkipMissingAssemblies>true</WasmSkipMissingAssemblies>
      <AssemblySearchPaths>$(TestBinDir)/publish</AssemblySearchPaths>
    </PropertyGroup>

    <Message Text="!!!naricc_debug!!!: WasmTestRunner: TestBinDir: $(TestBinDir): Corelib: $(MicrosoftNetCoreAppRuntimePackDir)native/System.Private.CoreLib.dll" Importance="high" />

    <ItemGroup>      
      <WasmAssembliesToBundle Include="$(TestBinDir)\publish\*.dll" />
      <WasmAssembliesToBundle Include="$(MicrosoftNetCoreAppRuntimePackDir)native/System.Private.CoreLib.dll" />
    </ItemGroup>

    <Message Importance="High" Text="AppDir: $(AppDir)" />
    <Message Importance="High" Text="TestBinDir: $(TestBinDir)" />
    <Message Importance="High" Text="ArtifactsBinDir: $(ArtifactsBinDir)" />
  </Target>

  <Import Project="$(CORE_ROOT)\build\WasmApp.InTree.targets" />
</Project>
