<!-- This project requires an explicit SDK version number because it is used on Helix,
      and global.json is not available. -->
<Project  DefaultTargets="WasmBuildApp">
  <Import Project="$(MSBuildThisFileDirectory)Directory.Build.props" />
  <PropertyGroup>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <!-- TODO: Target frameowkr should not be hard coded, but I need to propagate NetCoreAppToolCurrent? -->
    <TargetFramework>net6.0</TargetFramework>
    <BuildDir>$(MSBuildThisFileDirectory)\obj\$(Configuration)\wasm</BuildDir>
    <AppDir>$(TestBinDir)/WasmApp/</AppDir>
    <PackageRID>browser-wasm</PackageRID>
    <NETCoreAppMaximumVersion>99.0</NETCoreAppMaximumVersion>
    <IsWasmProject>true</IsWasmProject>
    <WasmGenerateAppBundle>true</WasmGenerateAppBundle>
    <AssemblyName>simple</AssemblyName>

    <TestRootDir Condition="'$(HELIX_WORKITEM_ROOT)' != ''">$(HELIX_WORKITEM_ROOT)\wasm_build\</TestRootDir>
    <TestRootDir Condition="'$(HELIX_WORKITEM_ROOT)' == ''">$(MSBuildThisFileDirectory)..\wasm_build\</TestRootDir>

    <IntermediateOutputPath>$(TestRootDir)\obj\</IntermediateOutputPath>
    <PublishTrimmed>true</PublishTrimmed>
    <RuntimeIdentifier>browser-wasm</RuntimeIdentifier>
    <OriginalPublishDir>$(TestBinDir)\publish\</OriginalPublishDir>
    <RunAOTCompilationAfterBuild>true</RunAOTCompilationAfterBuild>
  </PropertyGroup>

  <PropertyGroup>
    <WasmBuildAppDependsOn>PrepareForWasmBuildApp;$(WasmBuildAppDependsOn)</WasmBuildAppDependsOn>
  </PropertyGroup>

  <Target Name="PrepareForWasmBuildApp">
    <PropertyGroup>
      <WasmMainAssemblyFileName>$(OriginalPublishDir)WasmTestRunner.dll</WasmMainAssemblyFileName>
      <WasmAppDir>$(AppDir)</WasmAppDir>
      <WasmMainJSPath>$(CORE_ROOT)\runtime-test\runtime-test.js</WasmMainJSPath>
      <WasmResolveAssembliesBeforeBuild>false</WasmResolveAssembliesBeforeBuild>
      <WasmGenerateRunV8Script>true</WasmGenerateRunV8Script>
      <WasmSkipMissingAssemblies>true</WasmSkipMissingAssemblies>
      <AssemblySearchPaths>$(TestBinDir)/publish;$(TestBinDir)/publish/refs;$(MicrosoftNetCoreAppRuntimePackDir)/native/</AssemblySearchPaths>
    </PropertyGroup>

    <Message Text="!!!naricc_debug!!!: WasmTestRunner: TestBinDir: $(TestBinDir): Corelib: $(MicrosoftNetCoreAppRuntimePackDir)native/System.Private.CoreLib.dll" Importance="high" />

    <ItemGroup>
      <WasmAssembliesToBundle Include="$(TestBinDir)\publish\*.dll" />
      <WasmAssembliesToBundle Include="$(MicrosoftNetCoreAppRuntimePackDir)runtimes/browser-wasm/native/System.Private.CoreLib.dll" />
      <WasmAssembliesToBundle Include="$(MicrosoftNetCoreAppRuntimePackDir)runtimes/browser-wasm/lib/net7.0/System.Runtime.dll" />
      <WasmAssembliesToBundle Include="$(MicrosoftNetCoreAppRuntimePackDir)runtimes/browser-wasm/lib/net7.0/System.Private.Runtime.InteropServices.JavaScript.dll" />
    </ItemGroup>

    <Message Importance="High" Text="AppDir: $(AppDir)" />
    <Message Importance="High" Text="TestBinDir: $(TestBinDir)" />
    <Message Importance="High" Text="ArtifactsBinDir: $(ArtifactsBinDir)" />
  </Target>

  <Import Project="$(MSBuildThisFileDirectory)Directory.Build.targets" />
</Project>
