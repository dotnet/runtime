<Project>
<!-- Build infrastructure support to enable running merged test runner assemblies like regular tests on mobile platforms. -->
  <PropertyGroup>
    <GenerateRuntimeConfigurationFiles>true</GenerateRuntimeConfigurationFiles>
    <MainLibraryFileName Condition="'$(MainLibraryFileName)' == '' and '$(TestBuildMode)' != 'nativeaot'">$(AssemblyName).dll</MainLibraryFileName>
    <WasmMainAssemblyFileName>$(AssemblyName).dll</WasmMainAssemblyFileName>
    <TestFramework>GeneratedRunner</TestFramework>
    <!-- Don't treat linker warnings as errors for our tests. -->
    <ILLinkTreatWarningsAsErrors>false</ILLinkTreatWarningsAsErrors>
  </PropertyGroup>

  <!--
    If this runner does not use the wrapper generator, assume it has the behavior of a classic standalone test:
    - There is no test framework so no test reporting.
    - The expected exit code is 100.
  -->
  <PropertyGroup Condition="'$(BuildAsStandalone)' == 'true' or '$(ReferenceXUnitWrapperGenerator)' == 'false'">
    <IncludesTestRunner>false</IncludesTestRunner>
    <ExpectedExitCode>100</ExpectedExitCode>
    <EmitXHarnessNoRunnerMarkerFile>true</EmitXHarnessNoRunnerMarkerFile>
  </PropertyGroup>

  <Target Name="_AddRuntimeLibsToPublishAssets" BeforeTargets="PrepareForPublish" DependsOnTargets="ResolveLibrariesRuntimeFilesFromLocalBuild;ResolveRuntimeFilesFromLocalBuild">
    <ItemGroup>
      <RuntimePackAsset Include="@(RuntimeFiles);@(LibrariesRuntimeFiles)" AssetType="runtime" />
    </ItemGroup>
  </Target>

  <ItemGroup>
    <RuntimePackAsset Include="$(TargetingPackPath)/*.dll" AssetType="runtime" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="$(RepoRoot)/src/tests/Common/XHarnessRunnerLibrary/XHarnessRunnerLibrary.csproj" />
  </ItemGroup>

  <!--
    We can't publish the test exclusion list at test build time as we don't know the full test run configuration
    until we're about to send the test runs to Helix. Here we'll include a dummy text exclusion list into the app bundle
    that we will patch with the actual test exclusion list later.
    Adding the exclusion list here allows us to avoid having to manually patch the various metadata files for each app type
    and allows us to only have to replace this file.
  -->
  <Target Name="_AddDummyTestExclusionListToAssets" BeforeTargets="AssignTargetPaths">
    <ItemGroup>
      <_PlaceholderExclusionList Include="$(IntermediateOutputPath)/PlaceholderTestExclusionList.txt" />
      <Content Include="@(_PlaceholderExclusionList)" TargetPath="TestExclusionList.txt" CopyToOutputDirectory="PreserveNewest"/>
    </ItemGroup>
    <WriteLinesToFile File="@(_PlaceholderExclusionList)"
                      Lines=""
                      Overwrite="true"
                      WriteOnlyWhenDifferent="true" />
    <!-- Write ExpectedExitCode to a file so helixpublishwitharcade.proj can read it back -->
    <ItemGroup Condition="'$(ExpectedExitCode)' != ''">
      <_ExpectedExitCodeFile Include="$(IntermediateOutputPath)/ExpectedExitCode.txt" />
      <Content Include="@(_ExpectedExitCodeFile)" TargetPath="ExpectedExitCode.txt" CopyToOutputDirectory="PreserveNewest"/>
    </ItemGroup>
    <WriteLinesToFile Condition="'$(ExpectedExitCode)' != ''"
                      File="@(_ExpectedExitCodeFile)"
                      Lines="$(ExpectedExitCode)"
                      Overwrite="true"
                      WriteOnlyWhenDifferent="true" />
  </Target>

  <!-- Don't use the usual script generation, the scripts it generates are not useful for these tests. -->
  <Target Name="GenerateExecutionScriptsInternal" />
  <Target Name="GenerateLocalRunnerScript" DependsOnTargets="GenerateRunScript" AfterTargets="PublishTestAsSelfContained" />

  <Import Project="$(RepositoryEngineeringDir)testing\tests.targets" />
</Project>
