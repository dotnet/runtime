<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <ItemGroup>
    <_SkipTestAssemblies Include="$(SkipTestAssemblies)" />
  </ItemGroup>

  <PropertyGroup>
      <TestAssemblyDir Condition="'$(TestAssemblyDir)' == ''">$(BaseOutputPathWithConfig)\tests\</TestAssemblyDir>
      <__TestRunHtmlLog Condition="'$(__TestRunHtmlLog)' == ''">$(__LogsDir)\TestRun.html</__TestRunHtmlLog>
      <__TestRunXmlLog Condition="'$(__TestRunXmlLog)' == ''">$(__LogsDir)\TestRun.xml</__TestRunXmlLog>
  </PropertyGroup>


  <Target Name="FindBuildAllTestsAsStandaloneRunnerScripts">
    <ItemGroup>
      <_StandaloneRunnerMarker Include="$(BaseOutputPathWithConfig)\**\*.StandaloneTestRunner" />
      <StandaloneRunnerScripts Include="$([System.IO.Path]::ChangeExtension('%(_StandaloneRunnerMarker.Identity)', '.$(TestScriptExtension)'))" />
      <MergedTestWrapperScripts Update="@(MergedTestWrapperScripts)">
        <RedirectOutputToFile>$([System.IO.Path]::ChangeExtension('%(MergedTestWrapperScripts.Identity)', '.log'))</RedirectOutputToFile>
      </MergedTestWrapperScripts>
    </ItemGroup>
  </Target>

  <Target Name="FindMergedTestDirectories">
    <ItemGroup>
      <_MergedTestAssemblyMarkers Include="$(BaseOutputPathWithConfig)\**\*.MergedTestAssembly" />
      <MergedTestWrapperScripts Include="$([System.IO.Path]::ChangeExtension('%(_MergedTestAssemblyMarkers.Identity)', '.$(TestScriptExtension)'))" />
      <MergedTestWrapperScripts Update="@(MergedTestWrapperScripts)">
        <RedirectOutputToFile>$([System.IO.Path]::ChangeExtension('%(MergedTestWrapperScripts.Identity)', '.log'))</RedirectOutputToFile>
        <TestResultsXmlFile>$([System.IO.Path]::ChangeExtension('%(MergedTestWrapperScripts.Identity)', '.testResults.xml'))</TestResultsXmlFile>
        <RelativeResultsPath>$([System.IO.Path]::GetRelativePath('$(TestBinDir)', $([System.IO.Path]::GetDirectoryName('%(MergedTestWrapperScripts.Identity)'))))</RelativeResultsPath>
      </MergedTestWrapperScripts>
      <MergedTestWrapperScripts Update="@(MergedTestWrapperScripts)">
        <TestResultsCopyTo>$(__LogsDir)\$([MSBuild]::ValueOrDefault('%(MergedTestWrapperScripts.RelativeResultsPath)', '').Replace('/', '.').Replace('\', '.')).testRun.xml</TestResultsCopyTo>
      </MergedTestWrapperScripts>
    </ItemGroup>
  </Target>

  <Target Name="PrepareTestsToRun"
          DependsOnTargets="FindBuildAllTestsAsStandaloneRunnerScripts;FindMergedTestDirectories">
    <Error  Text="Tests must be built to do a test run."
            Condition="'@(StandaloneRunnerScripts)' == '' and '@(MergedTestWrapperScripts)' == ''" />
    <Error  Text="Cannot run tests when both StandaloneRunnerScripts and MergedTestWrapperScripts are present. Either build the test tree as normal (merged runner) or with BuildAllTestsAsStandalone=true."
            Condition="'@(StandaloneRunnerScripts)' != '' and '@(MergedTestWrapperScripts)' != ''" />
  </Target>

  <Target Name="RunSingleMergedTest">
    <Exec Command="chmod +x $(TestWrapperScript)" WorkingDirectory="$(BaseOutputPathWithConfig)" EchoOff="true" Condition="'$(TargetOS)' != 'windows'" />
    <Exec Command="$(TestWrapperScript) &gt;$(RedirectOutputToFile) 2&gt;&amp;1" WorkingDirectory="$(BaseOutputPathWithConfig)" Timeout="$(__TestTimeout)" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="MergedTestExitCode" />
    </Exec>
    <Copy SourceFiles="$(TestResultsXmlFile)" DestinationFiles="$(TestResultsCopyTo)" Condition="'$(MergedTestExitCode)' == '0'" />
    <Message Importance="High" Text="Error running test group '$(TestWrapperScript)' - exit code $(MergedTestExitCode)" Condition="'$(MergedTestExitCode)' != '0'" />
  </Target>

  <Target Name="RunMergedTests" DependsOnTargets="PrepareTestsToRun">
    <ItemGroup>
      <_ProjectsToBuild Include="$(MSBuildThisFileFullPath)">
        <AdditionalProperties>TestWrapperScript=%(MergedTestWrapperScripts.Identity);RedirectOutputToFile=%(MergedTestWrapperScripts.RedirectOutputToFile);TestResultsXmlFile=%(MergedTestWrapperScripts.TestResultsXmlFile);TestResultsCopyTo=%(MergedTestWrapperScripts.TestResultsCopyTo)</AdditionalProperties>
      </_ProjectsToBuild>
    </ItemGroup>

    <MSBuild Projects="@(_ProjectsToBuild)" Targets="RunSingleMergedTest" BuildInParallel="true" Condition="'@(MergedTestWrapperScripts)' != ''" />
  </Target>

  <!--
    Inputs: StandaloneRunnerScript property pointing to the script to run the test.
    Returns: Item with script path and result.
  -->
  <Target Name="RunOneStandaloneRunnerTest" Returns="@(StandaloneRunnerResult)">

    <Exec Command="chmod +x $(StandaloneRunnerScript)" WorkingDirectory="$(BaseOutputPathWithConfig)" EchoOff="true" Condition="'$(TargetOS)' != 'windows'" />

    <Exec Command="$(StandaloneRunnerScript) -usewatcher &gt;$(StandaloneRunnerScript).log 2&gt;&amp;1" WorkingDirectory="$(BaseOutputPathWithConfig)" Timeout="$(__TestTimeout)" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="StandaloneRunnerExitCode" />
    </Exec>

    <ItemGroup>
      <StandaloneRunnerResult Include="$(StandaloneRunnerScript)">
        <Result Condition="'$(StandaloneRunnerExitCode)' == '0'">Pass</Result>
        <Result Condition="'$(StandaloneRunnerExitCode)' != '0'">Fail</Result>
      </StandaloneRunnerResult>
    </ItemGroup>
  </Target>

  <Target Name="RunStandaloneRunnerTests" DependsOnTargets="FindBuildAllTestsAsStandaloneRunnerScripts">
    <ItemGroup>
      <_StandaloneProjectsToBuild Include="$(MSBuildThisFileFullPath)">
        <AdditionalProperties>StandaloneRunnerScript=%(StandaloneRunnerScripts.Identity)</AdditionalProperties>
      </_StandaloneProjectsToBuild>
    </ItemGroup>

    <MSBuild Projects="@(_StandaloneProjectsToBuild)" Targets="RunOneStandaloneRunnerTest" BuildInParallel="true" Condition="'@(StandaloneRunnerScripts)' != ''">
      <Output TaskParameter="TargetOutputs" ItemName="StandaloneRunnerResults" />
    </MSBuild>

    <WriteLinesToFile File="$(__LogsDir)\StandaloneRunnerTestResults.testrun.log"
                      Lines="@(StandaloneRunnerResults -> '%(Identity): %(Result)')"
                      Overwrite="true" />
  </Target>

  <Target Name="RunTests" DependsOnTargets="RunMergedTests;RunStandaloneRunnerTests" Condition="'$(SkipTests)' != 'True'">
    <!-- TODO - merged reporting? -->
  </Target>
</Project>
