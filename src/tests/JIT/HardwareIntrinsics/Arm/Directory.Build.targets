<?xml version="1.0" encoding="utf-8"?>
<Project>

  <Import Project="$([MSBuild]::GetPathOfFileAbove(Directory.Build.targets, $(MSBuildThisFileDirectory)..))" />

  <ItemGroup>
    <ProjectReference Include="$(RepoRoot)/src/tests/Common/GenerateHWIntrinsicTests/GenerateHWIntrinsicTests_Arm.csproj" ReferenceOutputAssembly="false" />
  </ItemGroup>

  <PropertyGroup>
    <!-- Ignore the warning we'd otherwise get about GenerateHWIntrinsicsTests_Arm since we don't actually reference it -->
    <ValidateExecutableReferencesMatchSelfContained>false</ValidateExecutableReferencesMatchSelfContained>
  </PropertyGroup>

  <PropertyGroup>
    <GeneratedHWIntrinsicTestDirectory Condition="'$(GeneratedHWIntrinsicTestDirectory)' == ''">$(IntermediateOutputPath)$(MSBuildProjectName)/gen/</GeneratedHWIntrinsicTestDirectory>
    <GeneratedHWIntrinsicTestListFile Condition="'$(GeneratedHWIntrinsicTestListFile)' == ''">$(GeneratedHWIntrinsicTestDirectory)GeneratedHWIntrinsicTestList.txt</GeneratedHWIntrinsicTestListFile>
  </PropertyGroup>

  <Target Name="ExecuteGenerateTestsScript"
          Inputs="$(MSBuildAllProjects);$(RepoRoot)/src/tests/Common/GenerateHWIntrinsicTests/GenerateHWIntrinsicTests_Arm.cs"
          Outputs="$(GeneratedHWIntrinsicTestListFile)"
          Condition="'$(Language)' == 'C#'">
    <Exec Command="$(DotNetCli) run --project $(RepoRoot)/src/tests/Common/GenerateHWIntrinsicTests/GenerateHWIntrinsicTests_Arm.csproj -c $(Configuration) -- $(MSBuildProjectName) $(MSBuildThisFileDirectory)Shared $(GeneratedHWIntrinsicTestDirectory) $(GeneratedHWIntrinsicTestListFile)" />
  </Target>

  <Target Name="ReadGeneratedHWIntrinsicTestListFile"
          BeforeTargets="BeforeCompile;CoreCompile"
          DependsOnTargets="ExecuteGenerateTestsScript"
          Returns="$(GeneratedHWIntrinsicTestList)"
          Condition="'$(Language)' == 'C#'">
    <ReadLinesFromFile File="$(GeneratedHWIntrinsicTestListFile)">
      <Output TaskParameter="Lines" ItemName="GeneratedHWIntrinsicTestList" />
    </ReadLinesFromFile>
    <ItemGroup>
      <Compile Include="@(GeneratedHWIntrinsicTestList)" />
    </ItemGroup>
  </Target>

</Project>
