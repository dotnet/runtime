<?xml version="1.0" encoding="utf-8"?>
<Project>

  <Import Project="$([MSBuild]::GetPathOfFileAbove(Directory.Build.targets, $(MSBuildThisFileDirectory)..))" />

  <PropertyGroup>
    <GeneratedHWIntrinsicTestDirectory Condition="'$(GeneratedHWIntrinsicTestDirectory)' == ''">$(IntermediateOutputPath)$(MSBuildProjectName)/gen/</GeneratedHWIntrinsicTestDirectory>
    <GeneratedHWIntrinsicTestListFile Condition="'$(GeneratedHWIntrinsicTestListFile)' == ''">$(GeneratedHWIntrinsicTestDirectory)GeneratedHWIntrinsicTestList.txt</GeneratedHWIntrinsicTestListFile>
  </PropertyGroup>

  <Target Name="ExecuteGenerateTestsScript"
          BeforeTargets="BeforeCompile;CoreCompile"
          DependsOnTargets="PrepareForBuild"
          Condition="('$(Language)' == 'C#') AND ('$(MSBuildProjectName)' != 'GenerateTests')"
          Inputs="$(MSBuildAllProjects)"
          Outputs="$(GeneratedHWIntrinsicTestListFile)">
    <Exec Command="$(DotNetCli) run --project $(RepoRoot)/src/tests/Common/GenerateHWIntrinsicTests/GenerateHWIntrinsicTests_General.csproj -c $(Configuration) -- $(MSBuildProjectName) $(MSBuildThisFileDirectory)Shared $(GeneratedHWIntrinsicTestDirectory) $(GeneratedHWIntrinsicTestListFile)" />
    <ReadLinesFromFile File="$(GeneratedHWIntrinsicTestListFile)">
      <Output TaskParameter="Lines" ItemName="GeneratedHWIntrinsicTestList" />
    </ReadLinesFromFile>
    <ItemGroup>
      <Compile Include="@(GeneratedHWIntrinsicTestList)" />
    </ItemGroup>
  </Target>

</Project>
