<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <CLRTestKind>BuildOnly</CLRTestKind>
    <IsTestProject>false</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.OneCollect.RecordTrace" Version="$(MicrosoftOneCollectRecordTraceVersion)" PrivateAssets="All" />
  </ItemGroup>

  <ItemGroup>
    <Compile Include="UserEventsTestRunner.cs" />
    <Compile Include="UserEventsRequirements.cs" />
  </ItemGroup>

  <Target Name="CopyRecordTrace" BeforeTargets="Build;CopyAllNativeProjectReferenceBinaries" Condition="'$(TargetOS)' == 'linux' and ('$(TargetArchitecture)' == 'x64' or '$(TargetArchitecture)' == 'arm64')">
    <PropertyGroup>
      <_DestDir>$(TargetDir)</_DestDir>
      <_DestDir Condition="'$(_DestDir)' == ''">$(OutputPath)</_DestDir>
      <_RecordTraceSource>$(NuGetPackageRoot)microsoft.onecollect.recordtrace/$(MicrosoftOneCollectRecordTraceVersion)/runtimes/linux-$(TargetArchitecture)/native/record-trace</_RecordTraceSource>
      <_RecordTraceRelative Condition="$(BuildProjectRelativeDir) != ''">$(BuildProjectRelativeDir)record-trace</_RecordTraceRelative>
      <_RecordTraceRelative Condition="'$(_RecordTraceRelative)' == ''">$([System.IO.Path]::GetRelativePath('$(TestBinDir)', '$(_DestDir)record-trace'))</_RecordTraceRelative>
    </PropertyGroup>

    <Copy SourceFiles="$(_RecordTraceSource)" DestinationFiles="$(_DestDir)record-trace" SkipUnchangedFiles="true" />

    <!-- For local testing, ensure it has execute permissions -->
    <Exec Command="chmod +x '$(_DestDir)record-trace'" Condition="Exists('$(_DestDir)record-trace')" />

    <!-- For Helix builds, artifacts copied over have their permissions reset. Add the executable to a list for helix to reapply execute permissions -->
    <WriteLinesToFile File="$(_DestDir)helix-extra-executables.list" Lines="$(_RecordTraceRelative)" Overwrite="true" />

    <!-- Although this isn't a test project, userevents tests depend on record-trace, which in turn relies on helix-extra-executables.list to receive execute permissions
         So to get the files included into Helix's _MergedPayloadFiles, we need to manually add an OutOfProcessTest marker. -->
    <WriteLinesToFile
      File="$(_DestDir)$(MSBuildProjectName).OutOfProcessTest"
      Lines="OutOfProcessTest"
      Overwrite="true"
      WriteOnlyWhenDifferent="true" />
  </Target>
</Project>
