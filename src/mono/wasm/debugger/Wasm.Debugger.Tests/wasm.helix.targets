<Project>
  <PropertyGroup Condition="'$(Scenario)' == 'WasmDebuggerTests'">
    <NeedsToRunOnBrowser>true</NeedsToRunOnBrowser>
    <WorkItemPrefix>$(DebuggerHost)-</WorkItemPrefix>
    <UseDotNetCliVersionFromGlobalJson>true</UseDotNetCliVersionFromGlobalJson>
    <_DebuggerTestsWorkItemTimeout Condition="'$(BrowserHost)' != 'windows'">00:20:00</_DebuggerTestsWorkItemTimeout>
    <_DebuggerTestsWorkItemTimeout Condition="'$(BrowserHost)' == 'windows'">00:30:00</_DebuggerTestsWorkItemTimeout>

    <HelixExtensionTargets>$(HelixExtensionTargets);_AddWorkItemsForWasmDebuggerTests</HelixExtensionTargets>
  </PropertyGroup>

  <Target Name="_AddWorkItemsForWasmDebuggerTests">
    <PropertyGroup>
      <_DebuggerTestsArchivePath>$(TestArchiveTestsDir)Wasm.Debugger.Tests.zip</_DebuggerTestsArchivePath>
      <_DebuggerTestsListFilePath>$(TestArchiveTestsDir)DebuggerTestSuite.tests.list</_DebuggerTestsListFilePath>
    </PropertyGroup>

    <Error Condition="!Exists($(_DebuggerTestsArchivePath))"
           Text="Cannot find debugger tests archive at $(_DebuggerTestsArchivePath)" />
    <Error Condition="!Exists($(_DebuggerTestsListFilePath))"
           Text="Cannot find list of debugger class names file at $(_DebuggerTestsListFilePath)" />

    <ReadLinesFromFile File="$(_DebuggerTestsListFilePath)">
      <Output TaskParameter="Lines" ItemName="_DebuggerTestsClassName" />
    </ReadLinesFromFile>

    <Error Condition="@(_DebuggerTestsClassName -> Count()) == 0"
           Text="No debugger test class names found in $(_DebuggerTestsListFilePath)" />

    <ItemGroup>
      <HelixWorkItem Include="@(_DebuggerTestsClassName -> '$(DebuggerHost)-%(Identity)')">
        <PayloadArchive>$(TestArchiveTestsDir)Wasm.Debugger.Tests.zip</PayloadArchive>
        <Command>$(HelixCommand)</Command>
        <Timeout>$(_DebuggerTestsWorkItemTimeout)</Timeout>
        <PreCommands Condition="'$(OS)' == 'Windows_NT'">set &quot;TEST_ARGS=--filter FullyQualifiedName~%(Identity)&quot;</PreCommands>
        <PreCommands Condition="'$(OS)' != 'Windows_NT'">export &quot;TEST_ARGS=--filter FullyQualifiedName~%(Identity)&quot;</PreCommands>
      </HelixWorkItem>
    </ItemGroup>
  </Target>
</Project>
