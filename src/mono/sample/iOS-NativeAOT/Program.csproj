<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <OutputPath>bin</OutputPath>
    <IntermediateOutputPath>$(MSBuildThisFileDirectory)/obj/</IntermediateOutputPath>
    <TargetFramework>$(NetCoreAppCurrent)</TargetFramework>
    <TargetOS Condition="'$(TargetOS)' == ''">ios</TargetOS>
    <TargetOS Condition="'$(TargetsiOSSimulator)' == 'true'">iossimulator</TargetOS>
    <DeployAndRun Condition="'$(DeployAndRun)' == ''">true</DeployAndRun>
    <RuntimeIdentifier>$(TargetOS)-$(TargetArchitecture)</RuntimeIdentifier>
    <AppName>HelloiOS</AppName>
    <StripDebugSymbols Condition="'$(StripDebugSymbols)' == ''">false</StripDebugSymbols>
    <!-- NativeAOT-specific props -->
    <NativeLib>static</NativeLib>
    <CustomNativeMain>true</CustomNativeMain>
    <UseNativeAOTRuntime Condition="'$(UseNativeAOTRuntime)' == ''">true</UseNativeAOTRuntime>

    <!-- FIXME: We do not use publish targets yet, but we need to create a publish directory -->
    <PublishDir Condition="'$(PublishDir)' == ''">$(OutputPath)/publish</PublishDir>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="..\iOS\Program.cs" Link="Program.cs" />
    <DirectPInvoke Include="__Internal" />
  </ItemGroup>

  <PropertyGroup Condition="'$(TargetOS)' == 'maccatalyst'">
    <DevTeamProvisioning Condition="'$(DevTeamProvisioning)' == ''">adhoc</DevTeamProvisioning>
    <EnableAppSandbox Condition="'$(EnableAppSandbox)' == ''">false</EnableAppSandbox>
  </PropertyGroup>

  <Import Project="$(CoreClrProjectRoot)nativeaot\BuildIntegration\Microsoft.DotNet.ILCompiler.SingleEntry.targets" />
  <UsingTask TaskName="AppleAppBuilderTask"
             AssemblyFile="$(AppleAppBuilderTasksAssemblyPath)" />

  <!-- Run before ILC setup  -->
  <Target Name="ConfigureIlcPathsForiOSCrossCompilation">
      <PropertyGroup>
        <IlcPath>$([MSBuild]::NormalizeDirectory('$(RepoRoot)', 'artifacts', 'bin', 'coreclr', '$(HostOS).$(BuildArchitecture).$(CoreCLRConfiguration)', 'ilc'))</IlcPath>
        <IlcToolsPath>$(IlcPath)</IlcToolsPath>
        <IlcSdkPath>$(CoreCLRAotSdkDir)</IlcSdkPath>
        <IlcFrameworkPath Condition="'$(PublishAotUsingRuntimePack)' != 'true'">$(LibrariesAllBinArtifactsPath)</IlcFrameworkPath>
        <IlcFrameworkNativePath Condition="'$(PublishAotUsingRuntimePack)' != 'true'">$(LibrariesAllBinArtifactsPath)</IlcFrameworkNativePath>
    </PropertyGroup>
  </Target>

  <!-- Use locally built runtime pack -->
  <Target Name="_UseLocalRuntimePackPath"
    Condition="'$(PublishAotUsingRuntimePack)' == 'true'"
    AfterTargets="ResolveFrameworkReferences">
      <ItemGroup>
        <ResolvedFrameworkReference Condition="'%(ResolvedRuntimePack.FrameworkName)' == 'Microsoft.NETCore.App'" 
                                    RuntimePackPath="$(CoreCLRArtifactsPath)" />
      </ItemGroup>
  </Target>

  <Target Name="BuildAppBundle"
    AfterTargets="Build"
    DependsOnTargets="ConfigureIlcPathsForiOSCrossCompilation;SetupProperties;ComputeIlcCompileInputs;IlcCompile">

    <PropertyGroup>
      <AppDir>$(MSBuildThisFileDirectory)$(PublishDir)\app</AppDir>
      <IosSimulator Condition="'$(TargetsiOSSimulator)' == 'true'">iPhone 11</IosSimulator>
      <Optimized Condition="'$(Configuration)' == 'Release'">True</Optimized>
    </PropertyGroup>

    <ItemGroup>
      <_LinkerFlagsToDrop Include="@(NativeFramework->'-framework %(Identity)')" />
      <_LinkerFlagsToDrop Include="@(LinkerArg)" Condition="$([System.String]::new('%(Identity)').Contains('swift'))" />
      <LinkerArg Remove="@(_LinkerFlagsToDrop)" />
      <ExtraLinkerArguments Include="@(LinkerArg)" />
    </ItemGroup>

    <RemoveDir Directories="$(AppDir)" />

    <AppleAppBuilderTask
        UseNativeAOTRuntime="$(UseNativeAOTRuntime)"
        NativeDependencies="%(ManagedBinary.IlcOutputFile)"
        TargetOS="$(TargetOS)"
        Arch="$(TargetArchitecture)"
        ProjectName="$(AppName)"
        Assemblies="@(BundleAssemblies)"
        GenerateXcodeProject="True"
        BuildAppBundle="True"
        DevTeamProvisioning="$(DevTeamProvisioning)"
        OutputDirectory="$(AppDir)"
        Optimized="$(Optimized)"
        InvariantGlobalization="$(InvariantGlobalization)"
        StripSymbolTable="$(StripDebugSymbols)"
        AppDir="$(MSBuildThisFileDirectory)$(PublishDir)" 
        ExtraLinkerArguments="@(ExtraLinkerArguments)" >
        <Output TaskParameter="AppBundlePath" PropertyName="AppBundlePath" />
        <Output TaskParameter="XcodeProjectPath" PropertyName="XcodeProjectPath" />
    </AppleAppBuilderTask>

    <Message Importance="High" Text="Xcode: $(XcodeProjectPath)"/>
    <Message Importance="High" Text="App:   $(AppBundlePath)"/>

  </Target>

  <Target Name="RunAppBundle"
          AfterTargets="BuildAppBundle"
          Condition="'$(DeployAndRun)' == 'true'">
    <Exec Condition="'$(TargetOS)' == 'iossimulator'" Command="dotnet xharness apple run --app=$(AppBundlePath) --targets=ios-simulator-64 --output-directory=/tmp/out" />
    <Exec Condition="'$(TargetOS)' == 'ios'" Command="dotnet xharness apple run --app=$(AppBundlePath) --targets=ios-device --output-directory=/tmp/out" />
  </Target>

</Project>