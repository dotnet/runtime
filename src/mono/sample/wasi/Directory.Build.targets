<Project>
  <Import Project="../Directory.Build.targets" />
  <Import Project="$(MonoProjectRoot)\wasi\build\WASIApp.InTree.targets" />

  <PropertyGroup>
    <ShouldProvisionWasmtime Condition="!Exists('$(MonoProjectRoot)/wasi/wasmtime')">true</ShouldProvisionWasmtime>
  </PropertyGroup>


  <Target Name="BuildSampleInTree"
      Inputs="
      Program.cs;
      $(_SampleProject)
      "
      Outputs="
      bin/publish/runtime/native/dotnet.wasm;
      bin/publish/runtime/lib/net7.0/lib/mscorlib.dll;
      bin/publish/$(_SampleAssembly);
      "
>
    <PropertyGroup>
      <_ScriptExt Condition="'$(OS)' == 'Windows_NT'">.cmd</_ScriptExt>
      <_ScriptExt Condition="'$(OS)' != 'Windows_NT'">.sh</_ScriptExt>
      <_Dotnet>$(RepoRoot)dotnet$(_ScriptExt)</_Dotnet>
      <_AOTFlag Condition="'$(RunAOTCompilation)' != ''">/p:RunAOTCompilation=$(RunAOTCompilation)</_AOTFlag>
      <_WasmMainJSFileName>$([System.IO.Path]::GetFileName('$(WasmMainJSPath)'))</_WasmMainJSFileName>
    </PropertyGroup>
    <Exec Command="$(_Dotnet) publish -bl /p:Configuration=$(Configuration) /p:TargetArchitecture=wasm /p:TargetOS=WASI $(_AOTFlag) $(_SampleProject) $(BuildAdditionalArgs)" />

    <ItemGroup>
      <WASIRuntimeFiles Include="$(RepoRoot)artifacts/bin/microsoft.netcore.app.runtime.wasi-wasm/$(Configuration)/runtimes/wasi-wasm/**/*.*"/>
    </ItemGroup>

    <Copy SourceFiles="@(WASIRuntimeFiles)"
          DestinationFiles="@(WASIRuntimeFiles->'bin/publish/runtime/%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true"
          UseHardlinksIfPossible="true" />

  </Target>
  
  <Target Name="ProvisionWasmtime" Condition="'$(ShouldProvisionWasmtime)' == 'true'">
    <ReadLinesFromFile File="$(MonoProjectRoot)/wasi/wasmtime-version.txt">
      <Output TaskParameter="Lines" ItemName="_VersionLines" />
    </ReadLinesFromFile>

    <PropertyGroup>
      <WasmtimeVersion>%(_VersionLines.Identity)</WasmtimeVersion>
      <WasmtimeURL>https://github.com/bytecodealliance/wasmtime/releases/download/v$(WasmtimeVersion)/wasmtime-v$(WasmtimeVersion)-x86_64-linux.tar.xz</WasmtimeURL>
      <WasmtimeURL Condition="'$(HostOS)' == 'osx'" >https://github.com/bytecodealliance/wasmtime/releases/download/v$(WasmtimeVersion)/wasmtime-v$(WasmtimeVersion)-x86_64-macos.tar.xz</WasmtimeURL>
    </PropertyGroup>

    <Exec WorkingDirectory="$(MonoProjectRoot)/wasi" Command="mkdir wasmtime &amp;&amp; curl -L -o- $(WasmtimeURL) | tar -Jxv --strip-components=1 -C wasmtime/ &amp;&amp; cp wasmtime-version.txt wasmtime/wasmtime-version.txt" />
  </Target>

  <Target Name="RunSampleWithWasmtime" DependsOnTargets="ProvisionWasmtime;BuildSampleInTree">
  <!-- 
    TODOWASI - - tcplisten localhost:64000 - - env DEBUGGER_FD=4
  -->
    <Exec 
    WorkingDirectory="bin/publish"
    Command="$(MonoProjectRoot)wasi/wasmtime/wasmtime --dir . runtime/native/dotnet.wasm -- $(_SampleAssembly)" IgnoreExitCode="true" />
  </Target>

</Project>
