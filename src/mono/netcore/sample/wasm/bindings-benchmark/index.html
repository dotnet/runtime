<!DOCTYPE html>
<!--  Licensed to the .NET Foundation under one or more agreements. -->
<!-- The .NET Foundation licenses this file to you under the MIT license. -->
<html>
  <head>
    <title>Bindings Benchmark</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <h3 id="header">Wasm Bindings Benchmark</h3>
    Progress: <span id="progress">Loading...</span><br>
    Avg. Speed: <span id="speed"></span>
    <script type='text/javascript'>
      var App = {
        init: function () {
          console.log ("pausing to give JIT time before warming");

          document.querySelector("#progress").innerHTML = "Waiting for compile...";

          window.setTimeout(App.warmBenchmark.bind(App), 3000);
        },

        warmBenchmark: function () {
          console.log ("warming benchmark");
          document.querySelector("#progress").innerHTML = "Warming runtime...";
          var method = BINDING.bind_static_method("[BindingsBenchmark]Sample.Test:BenchmarkMethod", "ifd");
          method(0, 0, 0);

          var started = performance.now ();
          for (var i = 0; i < 300; i++)
            App.benchmarkIter(method, i);
          var ended = performance.now ();
          var elapsed = ended - started;

          var speedAdjustment = (Math.max(0, 110 - elapsed) / 50) + 1;

          document.querySelector("#progress").innerHTML = "Waiting for compile again...";

          console.log ("warming took", (ended - started), "starting benchmark in 2 seconds");
          window.setTimeout(App.runBenchmark.bind(App, method, speedAdjustment), 2000);
        },

        iterFailed: function (expected, actual) {
          throw new Error("Result mismatch, expected " + expected + " but got " + actual);
        },

        benchmarkIter: function (method, i) {
          var expected = i + i + i + 0.03;

          for (var j = 0; j < 100; j++) {
            var res = method(i, i + 0.01, i + 0.02);
            if (Math.abs(expected - res) >= 0.5)
              this.iterFailed(expected, res);
          }
        },

        runBenchmark: function (method, speedAdjustment) {
          var iterationCount = ((250 * speedAdjustment) | 0) * 1000, callbackCount = 10000;

          var elapsed = 0;
          var i = 0;

          var benchmarkCallback;
          
          benchmarkCallback = (function () {
            var started = performance.now ();

            for (var j = 0; j < callbackCount; j++)
              this.benchmarkIter(method, i);

            var ended = performance.now();
            elapsed += (ended - started);

            i += callbackCount;
            console.log(i);
            document.querySelector("#progress").innerHTML = String(i) + " / " + iterationCount;
            document.querySelector("#speed").innerHTML = (elapsed / i).toFixed(3) + "ms/iter";

            if (i < iterationCount) {
              window.setTimeout(benchmarkCallback, 1);
            } else {
              console.log("ran", i, "iterations in", elapsed);
              console.log(elapsed / i, "ms/iter");
              document.querySelector("#progress").innerHTML = String(i);
              document.querySelector("#speed").innerHTML = (elapsed / i).toFixed(3) + "ms/iter";
            }
          }).bind(this);

          window.setTimeout(benchmarkCallback, 1);
        }
      };
    </script>
    <script type="text/javascript" src="mono-config.js"></script>
    <script type="text/javascript" src="runtime.js"></script>

    <script defer src="dotnet.js"></script>

  </body>
</html>