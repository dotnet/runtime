<!DOCTYPE html>
<!--  Licensed to the .NET Foundation under one or more agreements. -->
<!-- The .NET Foundation licenses this file to you under the MIT license. -->
<html>
  <head>
    <title>TESTS</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <h3 id="header">Wasm Browser Sample</h3>
    Result from Sample.Test.TestMeaning: <span id="out"></span>
    <script type='text/javascript'>
      var App = {
        init: function () {
          var ret = BINDING.call_static_method("[WasmSample]Sample.Test:TestMeaning", []);
          document.getElementById("out").innerHTML = ret;
          console.log ("ready");

          console.log ("warming");

          var method = BINDING.bind_static_method("[WasmSample]Sample.Test:BenchmarkMethod", "ifd");
          method(0, 0, 0);

          for (var i = 0; i < 500; i++)
            App.benchmarkIter(method, i);

          console.log ("starting benchmark in 2 seconds");

          window.setTimeout(App.runBenchmark.bind(App, method), 2000);
        },

        iterFailed: function (expected, actual) {
          throw new Error("Result mismatch, expected " + expected + " but got " + res);
        },

        benchmarkIter: function (method, i) {
          var expected = i + i + i + 0.03;
          var res = method(i, i + 0.01, i + 0.02);
          if (Math.abs(expected - res) >= 0.5)
            this.iterFailed(expected, res);
        },

        runBenchmark: function (method, i) {
          var iterationCount = 125000;
          var started = performance.now ();

          for (var i = 0; i < iterationCount; i++) {
            if (i && ((i % 10000) === 0))
              console.log(i);
            this.benchmarkIter(method, i);
          }

          var ended = performance.now();
          console.log("ran", iterationCount, "iterations in", ended - started);
          console.log((ended - started) / iterationCount, "ms/iter");
        }
      };
    </script>
    <script type="text/javascript" src="mono-config.js"></script>
    <script type="text/javascript" src="runtime.js"></script>

    <script defer src="dotnet.js"></script>

  </body>
</html>