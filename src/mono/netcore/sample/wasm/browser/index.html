<!DOCTYPE html>
<!--  Licensed to the .NET Foundation under one or more agreements. -->
<!-- The .NET Foundation licenses this file to you under the MIT license. -->
<html>
  <head>
    <title>TESTS</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <h3 id="header">Wasm Browser Sample</h3>
    Result from Sample.Test.TestMeaning: <span id="out"></span>
    <script type='text/javascript'>
      var App = {
        init: function () {
          var ret = BINDING.call_static_method("[WasmSample]Sample.Test:TestMeaning", []);
          document.getElementById("out").innerHTML = ret;
          console.log ("ready");

          console.log ("warming");

          var method = BINDING.bind_static_method("[WasmSample]Sample.Test:BenchmarkMethod", "ifd");
          method(0, 0, 0);

          var started = performance.now ();
          for (var i = 0; i < 300; i++)
            App.benchmarkIter(method, i);
          var ended = performance.now ();
          var elapsed = ended - started;

          var speedAdjustment = (Math.max(0, 110 - elapsed) / 50) + 1;

          console.log ("warming took", (ended - started), "starting benchmark in 4 seconds");

          window.setTimeout(App.runBenchmark.bind(App, method, speedAdjustment), 4000);
        },

        iterFailed: function (expected, actual) {
          throw new Error("Result mismatch, expected " + expected + " but got " + res);
        },

        benchmarkIter: function (method, i) {
          var expected = i + i + i + 0.03;

          for (var j = 0; j < 100; j++) {
            var res = method(i, i + 0.01, i + 0.02);
            if (Math.abs(expected - res) >= 0.5)
              this.iterFailed(expected, res);
          }
        },

        runBenchmark: function (method, speedAdjustment) {
          var iterationCount = ((50 * speedAdjustment) | 0) * 1000, callbackCount = 5000;

          var elapsed = 0;
          var i = 0;

          var benchmarkCallback;
          
          benchmarkCallback = (function () {
            var started = performance.now ();

            for (var j = 0; j < callbackCount; j++) {
              this.benchmarkIter(method, i);
            }

            var ended = performance.now();
            elapsed += (ended - started);

            i += callbackCount;

            if (i && ((i % 5000) === 0))
              console.log(i);

            if (i < iterationCount) {
              window.setTimeout(benchmarkCallback, 1);
            } else {
              console.log("ran", iterationCount, "iterations in", elapsed);
              console.log(elapsed / iterationCount, "ms/iter");
            }
          }).bind(this);

          window.setTimeout(benchmarkCallback, 1);
        }
      };
    </script>
    <script type="text/javascript" src="mono-config.js"></script>
    <script type="text/javascript" src="runtime.js"></script>

    <script defer src="dotnet.js"></script>

  </body>
</html>