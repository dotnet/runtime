<Project>
  <PropertyGroup>
    <LinkerTestDir>$(ArtifactsBinDir)linkerTests/</LinkerTestDir>
    <LinkerTestProjectsDir>$(LinkerTestDir)projects/</LinkerTestProjectsDir>
    <TestDotNetPath>$(DotNetRoot)dotnet</TestDotNetPath>

    <ProjectTemplate>$(MSBuildThisFileDirectory)project.csproj.template</ProjectTemplate>
  </PropertyGroup>

  <ItemGroup>
    <TestConsoleAppSourceFiles Include="$(MSBuildProjectDirectory)/*.cs" />

    <!-- If not running in Helix, then remove specified TestRuntimeIdentifiers and only use the one that represents
    the platform we are currently on. -->
    <TestRuntimeIdentifiers Condition="'$(ArchiveTests)' != 'true'" Remove="@(TestRuntimeIdentifiers)" />
    <TestRuntimeIdentifiers Condition="'$(ArchiveTests)' != 'true'" Include="$(PackageRID)" />

    <!-- If running in Helix and the Test project didn't already provide a list of TestRuntimeIdentifiers, default to win-x64 -->
    <TestRuntimeIdentifiers Condition="'@(TestRuntimeIdentifiers)' == ''" Include="win-x64" />

    <TestSupportFiles Include="$(MSBuildThisFileDirectory)SupportFiles/Directory.Build.props">
      <DestinationFolder>$(LinkerTestDir)</DestinationFolder>
    </TestSupportFiles>
    <TestSupportFiles Include="$(MSBuildThisFileDirectory)SupportFiles/Directory.Build.targets">
      <DestinationFolder>$(LinkerTestDir)</DestinationFolder>
    </TestSupportFiles>
  </ItemGroup>

  <Target Name="CreateTestDir"
          Inputs="@(TestSupportFiles)"
          Outputs="@(TestSupportFiles->'%(DestinationFolder)\%(FileName)%(Extension)')">
    <MakeDir Directories="%(TestSupportFiles.DestinationFolder)" />
    <Copy SourceFiles="@(TestSupportFiles)" DestinationFolder="%(TestSupportFiles.DestinationFolder)" />
  </Target>

  <Target Name="GetTestConsoleAppSourceFilesByRID">
    <ItemGroup>
      <TestConsoleAppSourceFilesByRID Include="@(TestConsoleAppSourceFiles)">
        <TestRuntimeIdentifier>%(TestRuntimeIdentifiers.Identity)</TestRuntimeIdentifier>
      </TestConsoleAppSourceFilesByRID>
    </ItemGroup>
  </Target>

  <Target Name="GetTestConsoleApps"
          DependsOnTargets="GetTestConsoleAppSourceFilesByRID">
    <ItemGroup>
      <TestConsoleAppSourceFilesByRID>
        <ProjectDir>$(LinkerTestProjectsDir)$(MSBuildProjectName)/%(Filename)/%(TestRuntimeIdentifier)/</ProjectDir>
      </TestConsoleAppSourceFilesByRID>
      <TestConsoleAppSourceFilesByRID>
        <ProjectFile>%(ProjectDir)project.csproj</ProjectFile>
        <AssetsFile>%(ProjectDir)obj/project.assets.json</AssetsFile>
        <TestCommand>%(ProjectDir)bin\Release\net5.0\win-x64\publish\project.exe</TestCommand>
        <TestExecutionDirectory>%(ProjectDir)bin\Release\net5.0\win-x64\publish\</TestExecutionDirectory>
        <RuntimePackDirectory>$([MSBuild]::NormalizeDirectory('$(ArtifactsBinDir)', 'microsoft.netcore.app.runtime.%(TestRuntimeIdentifier)', '$(Configuration)'))</RuntimePackDirectory>
      </TestConsoleAppSourceFilesByRID>
    </ItemGroup>

    <ItemGroup>
      <TestConsoleApps Include="@(TestConsoleAppSourceFilesByRID->'%(ProjectFile)')">
        <ProjectCompileItems>%(Identity)</ProjectCompileItems>
      </TestConsoleApps>
    </ItemGroup>
  </Target>

  <Target Name="GenerateProjects"
          DependsOnTargets="GetTestConsoleApps;CreateTestDir"
          Inputs="@(TestConsoleAppSourceFilesByRID);$(ProjectTemplate)"
          Outputs="%(TestConsoleApps.Identity)">
    <PropertyGroup>
      <_projectDir>%(TestConsoleApps.ProjectDir)/</_projectDir>
      <_projectFile>%(TestConsoleApps.ProjectFile)</_projectFile>
      <_projectSourceFile>%(TestConsoleApps.ProjectCompileItems)</_projectSourceFile>
    </PropertyGroup>

    <MakeDir Directories="$(_projectDir)" />
    <WriteLinesToFile File="$(_projectFile)"
                      Lines="$([System.IO.File]::ReadAllText('$(ProjectTemplate)').Replace('{RuntimePackDir}', '%(TestConsoleApps.RuntimePackDirectory)').Replace('{TargetingPackDir}','$(MicrosoftNetCoreAppRefPackDir)').Replace('{RuntimeIdentifier}','%(TestConsoleApps.TestRuntimeIdentifier)'))"
                      Overwrite="true" />
    <Copy SourceFiles="$(_projectSourceFile)"
          DestinationFolder="$(_projectDir)" />
    <Message Text="Generated $(_projectFile)" />
  </Target>

  <Target Name="RestoreProjects"
          DependsOnTargets="GenerateProjects">
    <PropertyGroup>
      <TestRestoreCommand>"$(TestDotNetPath)"</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) restore</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) /nr:false</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) /warnaserror</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) -p:configuration=Release</TestRestoreCommand>
    </PropertyGroup>

    <Exec Command="$(TestRestoreCommand)" StandardOutputImportance="Low" WorkingDirectory="%(TestConsoleApps.ProjectDir)" />
  </Target>

  <Target Name="PublishTrimmedProjects"
          BeforeTargets="ExecuteApplications"
          DependsOnTargets="RestoreProjects">
    <PropertyGroup>
      <TestRestoreCommand>"$(TestDotNetPath)"</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) msbuild /t:PublishTrimmed</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) /nr:false</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) /warnaserror</TestRestoreCommand>
      <TestRestoreCommand>$(TestRestoreCommand) -p:configuration=Release</TestRestoreCommand>
    </PropertyGroup>

    <Exec Command="$(TestRestoreCommand)" StandardOutputImportance="Low" WorkingDirectory="%(TestConsoleApps.ProjectDir)" />
  </Target>

  <Target Name="ExecuteApplications"
          Inputs="%(TestConsoleApps.Identity)"
          Outputs="_unused"
          Condition="'$(ArchiveTests)' != 'true'">

    <Exec IgnoreExitCode="true" Command="%(TestConsoleApps.TestCommand)" StandardOutputImportance="Low" WorkingDirectory="%(TestConsoleApps.TestExecutionDirectory)">
      <Output TaskParameter="ExitCode" PropertyName="ExecutionExitCode" />
    </Exec>

    <Error Condition="'$(ExecutionExitCode)' != '100'" Text="Error: [Failed Test]: %(TestConsoleApps.ProjectCompileItems) The Command %(TestConsoleApps.TestCommand) return a non-success exit code." />
  </Target>

  <Target Name="Build" DependsOnTargets="ExecuteApplications;ArchiveHelixItems" />

  <!-- ArchiveHelixItems target will be implemented in a subsequent change in order to add Helix support -->
  <Target Name="ArchiveHelixItems" />

  <!-- define test to do nothing, for this project Build does all the testing -->
  <Target Name="Test" DependsOnTargets="Build" />
</Project>
