# Pipeline to validate and regenerate CMake platform cache files.
#
# This pipeline runs weekly to validate that platform caches are up-to-date.
# If validation fails (cache differs from current system), it regenerates
# the cache and publishes it as an artifact for someone to commit.
#
# Can also be run manually to validate/regenerate specific platforms.
#
# After the pipeline completes with regenerated caches, download the artifacts
# and commit the updated cache files to the repository.

trigger: none
pr: none

schedules:
  - cron: "0 8 * * 0"  # Weekly on Sunday at 8:00 AM UTC
    displayName: Weekly cache validation
    branches:
      include:
        - main
    always: true

parameters:
  - name: platforms
    displayName: Platforms to validate
    type: object
    default:
      - osx_arm64
      - osx_x64
      - linux_x64
      - browser_wasm
      - ios_arm64

variables:
  - template: /eng/pipelines/common/variables.yml
    parameters:
      templatePath: 'templates-official'
  - template: /eng/pipelines/common/internal-variables.yml
    parameters:
      teamName: dotnet-core-acquisition

extends:
  template: /eng/pipelines/common/templates/pipeline-with-resources.yml
  parameters:
    isOfficialBuild: true
    stages:
    - stage: ValidateCmakeCache
      displayName: Validate CMake Cache
      jobs:
      - ${{ each platform in parameters.platforms }}:
        - template: /eng/pipelines/common/platform-matrix.yml
          parameters:
            jobTemplate: /eng/pipelines/common/global-build-job.yml
            buildConfig: debug
            platforms:
            - ${{ platform }}
            jobParameters:
              nameSuffix: ValidateCmakeCache
              # First validate; if that fails, regenerate
              buildArgs: --validate-config || $(Build.SourcesDirectory)/build.sh --regenerate-config
              timeoutInMinutes: 60
              postBuildSteps:
                - script: |
                    set -e
                    # Map platform to cache file name
                    case "${{ platform }}" in
                      osx_arm64)    cachefile="tryrun.osx-arm64.cmake" ;;
                      osx_x64)      cachefile="tryrun.osx-x64.cmake" ;;
                      linux_x64)    cachefile="tryrun.linux-x64.cmake" ;;
                      browser_wasm) cachefile="tryrun.browser.cmake" ;;
                      ios_arm64)    cachefile="tryrun_ios_tvos.cmake" ;;
                      *)
                        echo "Unknown platform: ${{ platform }}"
                        exit 1
                        ;;
                    esac
                    echo "##vso[task.setvariable variable=CacheFile]$cachefile"
                    
                    filepath="$(Build.SourcesDirectory)/eng/native/$cachefile"
                    
                    # Check if cache file was regenerated by comparing to git
                    if git diff --quiet -- "$filepath" 2>/dev/null; then
                      echo "✓ Cache file is up-to-date: $cachefile"
                      echo "##vso[task.setvariable variable=CacheRegenerated]false"
                    else
                      echo "⚠ Cache file was regenerated: $cachefile"
                      echo "##vso[task.setvariable variable=CacheRegenerated]true"
                      echo ""
                      echo "--- Diff ---"
                      git diff -- "$filepath" || true
                    fi
                  displayName: Check cache status

                - task: PublishPipelineArtifact@1
                  displayName: Publish regenerated cache
                  condition: and(succeeded(), eq(variables['CacheRegenerated'], 'true'))
                  inputs:
                    targetPath: $(Build.SourcesDirectory)/eng/native/$(CacheFile)
                    artifactName: cmake-cache-${{ platform }}
