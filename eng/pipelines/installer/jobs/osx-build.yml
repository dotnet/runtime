parameters:
  name: ''
  platform: ''
  pool: ''

jobs:
- job: ${{ format('installer_{0}', coalesce(parameters.name, parameters.platform)) }}
  displayName: ${{ format('Installer Build and Test {0}', coalesce(parameters.name, parameters.platform)) }}
  pool: ${{ parameters.pool }}
  strategy:
    matrix:
      debug:
        _BuildConfig: Debug
      release:
        _BuildConfig: Release
  workspace:
    clean: all
  variables:
    CommonMSBuildArgs: >-
      /p:Configuration=$(_BuildConfig)
      /p:PortableBuild=true
  steps:

  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - task: NuGetAuthenticate@0

  - script: >-
      $(Build.SourcesDirectory)/installer.sh --restore --build --ci --test
      /p:OfficialBuildId=$(Build.BuildNumber)
      /p:StripSymbols=true
      $(CommonMSBuildArgs)
    displayName: Build
    condition: succeeded()

  - template: steps/upload-job-artifacts.yml
    parameters:
      name: ${{ parameters.name }}
