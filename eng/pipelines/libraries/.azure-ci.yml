# Setting batch to true, triggers one build at a time.
# if there is a push while a build in progress, it will wait,
# until the running build finishes, and produce a build with all the changes
# that happened during the last build.
trigger:
  batch: true
  branches:
    include:
    - master
    - release/*.*
  paths:
    exclude:
    - docs/*
    - CODE-OF-CONDUCT.md
    - CONTRIBUTING.md
    - LICENSE.TXT
    - PATENTS.TXT
    - README.md
    - SECURITY.md
    - THIRD-PARTY-NOTICES.TXT
    - src/installer/*
    - src/coreclr/*
    - eng/pipelines/coreclr/*
    - eng/pipelines/installer/*
    - eng/pipelines/common/*

pr:
  branches:
    include:
    - master
    - release/*.*
  paths:
    exclude:
    - docs/*
    - CODE-OF-CONDUCT.md
    - CONTRIBUTING.md
    - LICENSE.TXT
    - PATENTS.TXT
    - README.md
    - SECURITY.md
    - THIRD-PARTY-NOTICES.TXT
    - src/installer/*
    - src/coreclr/*
    - eng/pipelines/coreclr/*
    - eng/pipelines/installer/*

variables:
  - template: variables.yml

  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notIn(variables['Build.Reason'], 'PullRequest')) }}:
    - group: DotNet-Blob-Feed
    - group: corefx-sdl-validation
    - name: _dotnetFeedUrl
      value: https://dotnetfeed.blob.core.windows.net/dotnet-core/index.json
    - name: _PublishUsingPipelines
      value: true
    - name: _DotNetArtifactsCategory
      value: .NETCore
    - name: _DotNetValidationArtifactsCategory
      value: .NETCore

stages:

  - stage: Build
    jobs:
      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/libraries/build-job.yml
          buildConfig: Release
          platforms:
          - Windows_NT_x64
          jobParameters:
            isOfficialBuild: ${{ variables['isOfficialBuild'] }}

      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/libraries/test-job.yml
          buildConfig: Release
          platforms:
          - Windows_NT_x64
          jobParameters:
            isOfficialBuild: ${{ variables['isOfficialBuild'] }}
            runTests: true
            testScope: innerloop

  # Publish and validation steps. Only run in official builds
  - ${{ if eq(variables['isOfficialBuild'], 'true') }}:
    - template: /eng/pipelines/libraries/pre-publish.yml
      parameters:
        dependsOn:
          - Build

    - template: eng\common\templates\post-build\post-build.yml
      parameters:
        validateDependsOn:
          - PrePublish
        enableSymbolValidation: false # https://github.com/dotnet/arcade/issues/2871
        SDLValidationParameters:
          enable: true
          params: ' -SourceToolsList @("policheck","credscan")
          -TsaInstanceURL "$(TsaInstanceURL)"
          -TsaProjectName "$(TsaProjectName)"
          -TsaNotificationEmail "$(TsaNotificationEmail)"
          -TsaCodebaseAdmin "$(TsaCodebaseAdmin)"
          -TsaBugAreaPath "$(TsaBugAreaPath)"
          -TsaIterationPath "$(TsaIterationPath)"
          -TsaRepositoryName "CoreFX"
          -TsaCodebaseName "CoreFX"
          -TsaPublish $True'
