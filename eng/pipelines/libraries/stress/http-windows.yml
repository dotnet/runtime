trigger: none

schedules:
- cron: "0 13 * * *" # 1PM UTC => 5 AM PST
  displayName: HttpStress nightly run
  branches:
    include:
    - master

pool:
  name: Hosted VS2017

variables:
  - template: ../variables.yml
  - name: httpStressProject
    value: $(sourcesRoot)/System.Net.Http/tests/StressTests/HttpStress/
  - name: sdkBaseImage
    value: sdk-corefx-current
  - name: httpStressImage
    value: httpstress

steps:
- checkout: self
  clean: true
  fetchDepth: 0
  lfs: false

- powershell: |
    .\libraries.cmd -ci -c $(BUILD_CONFIGURATION)
    docker build -t $(sdkBaseImage) --build-arg CONFIGURATION=$(BUILD_CONFIGURATION) -f src/libraries/System.Net.Http/tests/StressTests/HttpStress/corefx.windows.Dockerfile artifacts/bin/testhost
  displayName: Build Libraries

- powershell: |
    cd '$(HttpStressProject)'
    docker build -t $(httpStressImage) --build-arg SDK_BASE_IMAGE=$(sdkBaseImage) --build-arg CONFIGURATION=$(BUILD_CONFIGURATION) -f windows.Dockerfile .
  displayName: Build HttpStress

- powershell: |
    cd '$(HttpStressProject)'
    docker run -e HTTPSTRESS_ARGS=$(HTTPSTRESS_ARGS) $(httpStressImage)
  displayName: Run HttpStress

- task: PublishBuildArtifacts@1
  displayName: Publish Logs
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/artifacts/log/$(BUILD_CONFIGURATION)'
    PublishLocation: Container
    ArtifactName: 'httpstress_$(Agent.Os)_$(Agent.JobName)'
  continueOnError: true
  condition: always()
