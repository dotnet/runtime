trigger: none

parameters:
- name: diagnosticsBranch
  displayName: Diagnostics Branch
  type: string
  default: main
- name: cdacDumpPlatforms
  displayName: cDAC Dump Platforms
  type: object
  default:
    - windows_x64
    - linux_x64
    # - osx_x64 # Temporarily due to CI capacity constraints. Will re-enable once osx queues are more available.

resources:
  repositories:
    - repository: diagnostics
      type: github
      endpoint: public
      name: dotnet/diagnostics
      ref:  ${{ parameters.diagnosticsBranch }}

variables:
  - template: /eng/pipelines/common/variables.yml

schedules:
- cron: "30 2 * * *"
  displayName: Every night at 2:30AM
  branches:
    include:
    - main
  always: true

pr:
  branches:
    include:
    - main
  paths:
    include:
    - eng/pipelines/**
    - src/native/managed/cdac/**
    - src/coreclr/debug/runtimeinfo/**

extends:
  template:  /eng/pipelines/common/templates/pipeline-with-resources.yml
  parameters:
    stages:
    - stage: Build
      jobs:
      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/common/global-build-job.yml
          buildConfig: release
          platforms:
          - windows_x64
          jobParameters:
            buildArgs: -s clr+libs+tools.cdac+host+packs -c Debug -rc $(_BuildConfig) -lc $(_BuildConfig)
            nameSuffix: AllSubsets_CoreCLR
            isOfficialBuild: ${{ variables.isOfficialBuild }}
            timeoutInMinutes: 360
            postBuildSteps:
            - powershell: |
                $versionDir = Get-ChildItem -Directory -Path "$(Build.SourcesDirectory)\artifacts\bin\testhost\net*\shared\Microsoft.NETCore.App" | Select-Object -ExpandProperty FullName
                Write-Host "##vso[task.setvariable variable=versionDir]$versionDir"
              displayName: 'Set Path to Shared Framework Artifacts'
            - template: /eng/pipelines/common/upload-artifact-step.yml
              parameters:
                rootFolder: $(versionDir)
                includeRootFolder: false
                archiveType: $(archiveType)
                archiveExtension: $(archiveExtension)
                tarCompression: $(tarCompression)
                artifactName: BuildArtifacts_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_coreclr
                displayName: Build Assets
      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/diagnostics/runtime-diag-job.yml
          buildConfig: release
          platforms:
          - windows_x64
          jobParameters:
            name: cDAC
            useCdac: true
            isOfficialBuild: ${{ variables.isOfficialBuild }}
            liveRuntimeDir: $(Build.SourcesDirectory)/artifacts/runtime
            timeoutInMinutes: 360
            # Workaround: microsoft/azure-pipelines-tasks#21871
            # PublishTestResults v2.270.0 garbles parameterized xUnit test names containing dots.
            # Unsetting this feature flag restores v2.262.0 behavior until a permanent fix ships.
            variables:
              - name: AllowPtrToDetectTestRunRetryFiles
                value: false
            dependsOn:
            - build_windows_x64_release_AllSubsets_CoreCLR
            preBuildSteps:
              - template: /eng/pipelines/common/download-artifact-step.yml
                parameters:
                  artifactName: BuildArtifacts_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_coreclr
                  artifactFileName: BuildArtifacts_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_coreclr$(archiveExtension)
                  unpackFolder: $(Build.SourcesDirectory)/artifacts/runtime
                  displayName: 'Runtime Build Artifacts'
            postBuildSteps:
            - task: PublishTestResults@2
              inputs:
                testResultsFormat: xUnit
                testResultsFiles: '**/*.xml'
                searchFolder: '$(Build.SourcesDirectory)/artifacts/TestResults'
                testRunTitle: 'Tests $(_PhaseName)'
                failTaskOnFailedTests: true
                publishRunAttachments: true
                mergeTestResults: true
                buildConfiguration: $(_BuildConfig)
              continueOnError: true
              condition: always()
            - task: PublishPipelineArtifact@1
              inputs:
                targetPath: '$(Build.SourcesDirectory)/artifacts/tmp/$(_BuildConfig)/dumps'
                artifactName: 'Dumps_cDAC_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_Attempt$(System.JobAttempt)'
              displayName: 'Publish Crash Dumps'
              continueOnError: true
              condition: failed()
            - task: PublishPipelineArtifact@1
              inputs:
                targetPath: '$(Build.SourcesDirectory)/artifacts/TestResults'
                artifactName: 'TestResults_cDAC_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_Attempt$(System.JobAttempt)'
              displayName: 'Publish Test Results and SOS Logs'
              continueOnError: true
              condition: failed()
      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/diagnostics/runtime-diag-job.yml
          buildConfig: release
          platforms:
          - windows_x64
          jobParameters:
            name: DAC
            useCdac: false
            isOfficialBuild: ${{ variables.isOfficialBuild }}
            liveRuntimeDir: $(Build.SourcesDirectory)/artifacts/runtime
            timeoutInMinutes: 360
            # Workaround: microsoft/azure-pipelines-tasks#21871
            variables:
              - name: AllowPtrToDetectTestRunRetryFiles
                value: false
            dependsOn:
            - build_windows_x64_release_AllSubsets_CoreCLR
            preBuildSteps:
              - template: /eng/pipelines/common/download-artifact-step.yml
                parameters:
                  artifactName: BuildArtifacts_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_coreclr
                  artifactFileName: BuildArtifacts_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_coreclr$(archiveExtension)
                  unpackFolder: $(Build.SourcesDirectory)/artifacts/runtime
                  displayName: 'Runtime Build Artifacts'
            postBuildSteps:
            - task: PublishTestResults@2
              inputs:
                testResultsFormat: xUnit
                testResultsFiles: '**/*.xml'
                searchFolder: '$(Build.SourcesDirectory)/artifacts/TestResults'
                testRunTitle: 'Tests $(_PhaseName)'
                failTaskOnFailedTests: true
                publishRunAttachments: true
                mergeTestResults: true
                buildConfiguration: $(_BuildConfig)
              continueOnError: true
              condition: always()
            - task: PublishPipelineArtifact@1
              inputs:
                targetPath: '$(Build.SourcesDirectory)/artifacts/tmp/$(_BuildConfig)/dumps'
                artifactName: 'Dumps_DAC_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_Attempt$(System.JobAttempt)'
              displayName: 'Publish Crash Dumps'
              continueOnError: true
              condition: failed()
            - task: PublishPipelineArtifact@1
              inputs:
                targetPath: '$(Build.SourcesDirectory)/artifacts/TestResults'
                artifactName: 'TestResults_DAC_$(osGroup)$(osSubgroup)_$(archType)_$(_BuildConfig)_Attempt$(System.JobAttempt)'
              displayName: 'Publish Test Results and SOS Logs'
              continueOnError: true
              condition: failed()

    #
    # cDAC Dump Creation — Build runtime, create crash dumps, publish dump artifacts
    #
    - stage: DumpCreation
      dependsOn: []
      jobs:
      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/common/global-build-job.yml
          buildConfig: release
          platforms: ${{ parameters.cdacDumpPlatforms }}
          jobParameters:
            buildArgs: -s clr+libs+tools.cdac -c $(_BuildConfig) -rc $(_BuildConfig) -lc $(_BuildConfig)
            nameSuffix: CdacDumpGeneration
            timeoutInMinutes: 120
            postBuildSteps:
            - script: $(Build.SourcesDirectory)$(dir).dotnet$(dir)dotnet$(exeExt) msbuild
                $(Build.SourcesDirectory)/src/native/managed/cdac/tests/DumpTests/Microsoft.Diagnostics.DataContractReader.DumpTests.csproj
                /t:GenerateAllDumps
                /p:CIDumpVersionsOnly=true
                /p:SetDisableAuxProviderSignatureCheck=true
                /p:TargetArchitecture=$(archType)
                -bl:$(Build.SourcesDirectory)/artifacts/log/DumpGeneration.binlog
              displayName: 'Generate cDAC Dumps'
            - template: /eng/pipelines/common/upload-artifact-step.yml
              parameters:
                rootFolder: $(Build.SourcesDirectory)/artifacts/dumps/cdac
                includeRootFolder: false
                archiveType: tar
                archiveExtension: .tar.gz
                tarCompression: gz
                artifactName: CdacDumps_$(osGroup)_$(archType)
                displayName: cDAC Dump Artifacts

    #
    # cDAC Dump Tests — Download dumps from all platforms, run tests cross-platform
    #
    - stage: DumpTest
      dependsOn:
      - DumpCreation
      jobs:
      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/common/global-build-job.yml
          buildConfig: release
          platforms: ${{ parameters.cdacDumpPlatforms }}
          jobParameters:
            buildArgs: -s tools.cdacdumptests /p:SkipDumpVersions=net10.0
            nameSuffix: CdacDumpTests
            timeoutInMinutes: 60
            postBuildSteps:
            # Download and test against dumps from each platform
            - ${{ each dumpPlatform in parameters.cdacDumpPlatforms }}:
              - template: /eng/pipelines/common/download-artifact-step.yml
                parameters:
                  artifactName: CdacDumps_${{ dumpPlatform }}
                  artifactFileName: CdacDumps_${{ dumpPlatform }}.tar.gz
                  unpackFolder: $(Build.SourcesDirectory)/artifacts/dumps/${{ dumpPlatform }}
                  displayName: '${{ dumpPlatform }} Dumps'
              - script: $(Build.SourcesDirectory)$(dir).dotnet$(dir)dotnet$(exeExt) test
                  $(Build.SourcesDirectory)/src/native/managed/cdac/tests/DumpTests/Microsoft.Diagnostics.DataContractReader.DumpTests.csproj
                  --no-build
                  --logger "trx;LogFileName=CdacDumpTests_${{ dumpPlatform }}.trx"
                  --results-directory $(Build.SourcesDirectory)/artifacts/TestResults/$(_BuildConfig)/${{ dumpPlatform }}
                displayName: 'Run cDAC Dump Tests (${{ dumpPlatform }} dumps)'
                continueOnError: true
                env:
                  CDAC_DUMP_ROOT: $(Build.SourcesDirectory)/artifacts/dumps/${{ dumpPlatform }}
              - task: PublishTestResults@2
                displayName: 'Publish Results ($(osGroup)-$(archType) → ${{ dumpPlatform }})'
                inputs:
                  testResultsFormat: VSTest
                  testResultsFiles: '**/*.trx'
                  searchFolder: '$(Build.SourcesDirectory)/artifacts/TestResults/$(_BuildConfig)/${{ dumpPlatform }}'
                  testRunTitle: 'cDAC Dump Tests $(osGroup)-$(archType) → ${{ dumpPlatform }}'
                  failTaskOnFailedTests: true
                  publishRunAttachments: true
                  buildConfiguration: $(_BuildConfig)
                continueOnError: true
                condition: always()
            # Fail the job if any test or publish step above reported issues.
            - script: echo "One or more dump test steps failed." && exit 1
              displayName: 'Fail if tests failed'
              condition: eq(variables['Agent.JobStatus'], 'SucceededWithIssues')
