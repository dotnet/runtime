parameters:
  basePath: ''
  isOfficialBuild: ''
  timeoutInMinutes: ''

steps:
- ${{ if and(eq(parameters.isOfficialBuild, true), ne(variables['Build.Reason'], 'PullRequest')) }}:
  - task: UseDotNet@2
    displayName: Install .NET 6 SDK for signing.
    inputs:
      packageType: 'sdk'
      version: '6.0.x'
      installationPath: '$(Agent.TempDirectory)/dotnet'

  - task: EsrpCodeSigning@1
    displayName: Sign Diagnostic Binaries
    inputs:
      ConnectedServiceName: 'dotnetesrp-diagnostics-dnceng'
      FolderPath: ${{ parameters.basePath }}
      Pattern: |
        **/mscordaccore*.dll
        **/mscordbi*.dll
      UseMinimatch: true
      signConfigType: 'inlineSignParams'
      inlineOperation: >-
        [
          {
            "keyCode": "CP-471322",
            "operationCode": "SigntoolSign",
            "parameters": {
              "OpusName": "Microsoft",
              "OpusInfo": "http://www.microsoft.com",
              "PageHash": "/NPH",
              "FileDigest": "/fd sha256",
              "TimeStamp": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
            },
            "toolName": "sign",
            "toolVersion": "1.0"
          },
          {
            "KeyCode": "CP-471322",
            "OperationCode": "SigntoolVerify",
            "Parameters": {},
            "ToolName": "sign",
            "ToolVersion": "1.0"
          }
        ]
      SessionTimeout: ${{ parameters.timeoutInMinutes }}
      MaxConcurrency: '50'
      MaxRetryAttempts: '5'
    env:
      DOTNET_MULTILEVEL_LOOKUP: 0
      DOTNET_ROOT: '$(Agent.TempDirectory)/dotnet'
      DOTNET_MSBUILD_SDK_RESOLVER_CLI_DIR: '$(Agent.TempDirectory)/dotnet'
