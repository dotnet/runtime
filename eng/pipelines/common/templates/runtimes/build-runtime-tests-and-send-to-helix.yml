parameters:
  buildConfig: ''
  osGroup: ''
  osSubgroup: ''
  container: ''
  testBuildArgs: ''
  crossBuild: false
  readyToRun: false
  liveLibrariesBuildConfig: ''
  compositeBuildMode: false
  helixQueues: ''
  displayNameArgs: ''
  runInUnloadableContext: false
  nativeAotTest: false
  runtimeFlavor: 'mono'
  runtimeVariant: 'monointerpreter'
  llvmAotStepContainer: ''
  scenarios:
    - normal
  variables: {}
  pool: ''
  dependsOn: []
  #arcade-specific parameters
  condition: always()
  continueOnError: false
  displayName: ''
  timeoutInMinutes: ''
  enableMicrobuild: ''
  gatherAssetManifests: false
  shouldContinueOnError: false

steps:
  - template: /eng/pipelines/common/templates/runtimes/build-runtime-tests.yml
    parameters:
      osGroup: ${{ parameters.osGroup }}
      osSubgroup: ${{ parameters.osSubgroup }}
      archType: ${{ parameters.archType }}
      buildConfig: ${{ parameters.buildConfig }}
      liveLibrariesBuildConfig: ${{ parameters.liveLibrariesBuildConfig }}
      testBuildArgs: ${{ parameters.testBuildArgs }}

  # Build a Mono LLVM AOT cross-compiler for non-amd64 targets (in this case, just arm64)
  - ${{ if and(eq(parameters.runtimeFlavor, 'mono'), or(eq(parameters.runtimeVariant, 'llvmaot'), eq(parameters.runtimeVariant, 'llvmfullaot'))) }}:
    - ${{ if eq(parameters.archType, 'arm64') }}:
      - script: ./build.sh
                -subset mono
                -c ${{ parameters.buildConfig }}
                -arch ${{ parameters.archType }}
                /p:BuildMonoAotCrossCompiler=true
                /p:BuildMonoAotCrossCompilerOnly=true
                /p:MonoLibClang="/usr/local/lib/libclang.so.16"
                /p:MonoAOTEnableLLVM=true
                /p:MonoAOTLLVMUseCxx11Abi=true
                /p:CrossBuild=true
        displayName: "Build Mono LLVM AOT cross compiler"

    - ${{ if eq(parameters.archType, 'x64') }}:
      - ${{ if eq(parameters.runtimeVariant, 'llvmaot') }}:
        - script: $(Build.SourcesDirectory)/src/tests/build$(scriptExt) $(logRootNameArg)MonoAot mono_aot ${{ parameters.buildConfig }} ${{ parameters.archType }}
          displayName: "LLVM AOT compile CoreCLR tests"
          target: ${{ coalesce(parameters.llvmAotStepContainer, parameters.container) }}
      - ${{ if eq(parameters.runtimeVariant, 'llvmfullaot') }}:
        - script: $(Build.SourcesDirectory)/src/tests/build$(scriptExt) $(logRootNameArg)MonoAot mono_fullaot ${{ parameters.buildConfig }} ${{ parameters.archType }}
          displayName: "LLVM AOT compile CoreCLR tests"
          target: ${{ coalesce(parameters.llvmAotStepContainer, parameters.container) }}
    - ${{ if eq(parameters.archType, 'arm64') }}:
      - ${{ if eq(parameters.runtimeVariant, 'llvmaot') }}:
        - script: $(Build.SourcesDirectory)/src/tests/build$(scriptExt) $(logRootNameArg)MonoAot mono_aot ${{ parameters.buildConfig }} ${{ parameters.archType }}  $(_monoAotCrossCompileArg) /p:RuntimeVariant=llvmfullaot -maxcpucount:2
          displayName: "LLVM AOT cross-compile CoreCLR tests"
          env:
            __MonoToolPrefix: aarch64-linux-gnu-
      - ${{ if eq(parameters.runtimeVariant, 'llvmfullaot') }}:
        - script: $(Build.SourcesDirectory)/src/tests/build$(scriptExt) $(logRootNameArg)MonoAot mono_fullaot ${{ parameters.buildConfig }} ${{ parameters.archType }} $(_monoAotCrossCompileArg) /p:RuntimeVariant=llvmfullaot -maxcpucount:2
          displayName: "LLVM AOT cross-compile CoreCLR tests"
          env:
            __MonoToolPrefix: aarch64-linux-gnu-

  #  Send tests to Helix
  - script: $(_msbuildCommand) $(_warnAsErrorParamHelixOverride) -restore
            $(Build.SourcesDirectory)/src/libraries/sendtohelix.proj
            /p:RuntimeFlavor=${{ parameters.runtimeFlavor }}
            /p:TargetArchitecture=${{ parameters.archType }}
            /p:TargetRuntimeIdentifier=${{ parameters.targetRid }}
            /p:Configuration=${{ parameters.buildConfig }}
            /p:TargetOS=${{ parameters.osGroup }}
            /p:MonoForceInterpreter=${{ parameters.interpreter }}
            /p:TestScope=${{ parameters.testScope }}
            /p:TestRunNamePrefixSuffix=${{ parameters.testRunNamePrefixSuffix }}
            /p:HelixBuild=$(Build.BuildNumber)
            ${{ parameters.extraHelixArguments }}
            /bl:$(Build.SourcesDirectory)/artifacts/log/$(_BuildConfig)/SendToHelix.binlog
    displayName: Send to Helix
    condition: and(succeeded(), ${{ parameters.condition }})
    continueOnError: ${{ eq(parameters.shouldContinueOnError, true) }}
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken) # We need to set this env var to publish helix results to Azure Dev Ops
      _Scenarios: ${{ join(',', parameters.scenarios) }} # Pass scenarios to MSBuild as env var to avoid need of escaping comma separated list

      ${{ if eq(variables['System.TeamProject'], 'internal') }}:
        HelixAccessToken: $(HelixApiAccessToken)
        HelixTargetQueues: ${{ replace(lower(join('+', parameters.helixQueues)), '.open', '') }}
        Creator: ''
      ${{ if eq(variables['System.TeamProject'], 'public') }}:
        HelixTargetQueues: ${{ join('+', parameters.helixQueues) }}
        Creator: ${{ parameters.creator }}

  # - template: /eng/pipelines/common/templates/runtimes/send-to-helix-step.yml
  #   parameters:
  #     displayName: Send tests to Helix
  #     buildConfig: $(buildConfigUpper)
  #     archType: ${{ parameters.archType }}
  #     osGroup: ${{ parameters.osGroup }}
  #     osSubgroup: ${{ parameters.osSubgroup}}
  #     coreClrRepoRoot: $(Build.SourcesDirectory)/src/coreclr
  #     shouldContinueOnError: ${{ parameters.shouldContinueOnError }}
  #     runtimeFlavor: ${{ parameters.runtimeFlavor }}
  #     runtimeVariant: ${{ parameters.runtimeVariant }}

  #     ${{ if eq(variables['System.TeamProject'], 'public') }}:
  #       creator: $(Build.DefinitionName)

  #       helixBuild: $(Build.BuildNumber)
  #       helixSource: $(_HelixSource)

  #       ${{ if ne(parameters.readyToRun, true) }}:
  #         helixType: 'test/functional/cli/'

  #       helixQueues: ${{ parameters.helixQueues }}

  #       # This tests whether an array is empty
  #       ${{ if eq(join('', parameters.helixQueues), '') }}:
  #         condition: false

  #       publishTestResults: true

  #       timeoutPerTestInMinutes: $(timeoutPerTestInMinutes)
  #       timeoutPerTestCollectionInMinutes: $(timeoutPerTestCollectionInMinutes)

  #       runCrossGen2: ${{ eq(parameters.readyToRun, true) }}
  #       compositeBuildMode: ${{ parameters.compositeBuildMode }}
  #       runInUnloadableContext: ${{ parameters.runInUnloadableContext }}
  #       nativeAotTest: ${{ parameters.nativeAotTest }}

  #       ${{ if eq(variables['System.TeamProject'], 'internal') }}:
  #         # Access token variable for internal project from the
  #         # DotNet-HelixApi-Access variable group
  #         helixAccessToken: $(HelixApiAccessToken)

  #       helixProjectArguments: '$(Build.SourcesDirectory)/src/tests/Common/helixpublishwitharcade.proj'

  #       scenarios: ${{ parameters.scenarios }}
