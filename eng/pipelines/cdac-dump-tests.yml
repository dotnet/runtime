trigger: none

schedules:
- cron: "0 4 * * *"
  displayName: Nightly cDAC dump tests
  branches:
    include:
    - main
  always: false

pr:
  branches:
    include:
    - main
  paths:
    include:
    - src/native/managed/cdac/**
    - src/coreclr/debug/runtimeinfo/**

variables:
  - template: /eng/pipelines/common/variables.yml

extends:
  template: /eng/pipelines/common/templates/pipeline-with-resources.yml
  parameters:
    stages:
    - stage: Build
      jobs:

      #
      # Build runtime + cDAC, create dumps, and run dump tests
      #
      - template: /eng/pipelines/common/platform-matrix.yml
        parameters:
          jobTemplate: /eng/pipelines/common/global-build-job.yml
          buildConfig: release
          platforms:
          - windows_x64
          - linux_x64
          jobParameters:
            buildArgs: -s clr+libs+tools.cdac -c $(_BuildConfig) -rc $(_BuildConfig) -lc $(_BuildConfig)
            nameSuffix: CdacDumpTests
            timeoutInMinutes: 120
            postBuildSteps:
            # Step 1: Build the dump test project (triggers GenerateAllDumps which builds
            #         debuggees, crashes them, and creates dump files; then compiles tests).
            - script: $(Build.SourcesDirectory)$(dir).dotnet$(dir)dotnet$(exeExt) build
                $(Build.SourcesDirectory)/src/native/managed/cdac/tests/DumpTests/Microsoft.Diagnostics.DataContractReader.DumpTests.csproj
                /p:CIDumpVersionsOnly=true
              displayName: 'Build Dump Tests and Generate Dumps'

            # Step 2: Run the tests (no-build since we just built above).
            - script: $(Build.SourcesDirectory)$(dir).dotnet$(dir)dotnet$(exeExt) test
                $(Build.SourcesDirectory)/src/native/managed/cdac/tests/DumpTests/Microsoft.Diagnostics.DataContractReader.DumpTests.csproj
                --no-build
                --logger "trx;LogFileName=CdacDumpTests.trx"
                --results-directory $(Build.SourcesDirectory)/artifacts/TestResults/$(_BuildConfig)
              displayName: 'Run cDAC Dump Tests'

            - task: PublishTestResults@2
              inputs:
                testResultsFormat: VSTest
                testResultsFiles: '**/*.trx'
                searchFolder: '$(Build.SourcesDirectory)/artifacts/TestResults'
                testRunTitle: 'cDAC Dump Tests $(osGroup)-$(archType)'
                failTaskOnFailedTests: true
                publishRunAttachments: true
                mergeTestResults: true
                buildConfiguration: $(_BuildConfig)
              continueOnError: true
              condition: always()
